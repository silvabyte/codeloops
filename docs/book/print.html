<!DOCTYPE HTML>
<html lang="en" class="coal sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Codeloops Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="src/theme/custom-d8ac81d3.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "coal";
            const default_dark_theme = "coal";
            window.path_to_searchindex_js = "searchindex-e5ba35e3.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5890de18.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('coal')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Codeloops Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/silvabyte/codeloops" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p align="center">
  <img src="images/logo.png" alt="Codeloops" width="400">
</p>

<p>Codeloops is a command-line tool that orchestrates an <strong>actor-critic feedback loop</strong> for AI coding agents. It runs your preferred coding agent (Claude Code, OpenCode, or Cursor) as the “actor” to execute tasks, then uses another agent as the “critic” to evaluate the work and provide feedback. This loop continues until the task is complete or a maximum iteration count is reached.</p>
<h2 id="the-problem"><a class="header" href="#the-problem">The Problem</a></h2>
<p>AI coding agents are powerful, but they lack a built-in mechanism for self-correction. When an agent makes a mistake or produces incomplete work, it has no way to know unless a human reviews the output. This leads to:</p>
<ul>
<li>Incomplete implementations that miss edge cases</li>
<li>Code that doesn’t fully address the original requirements</li>
<li>Bugs that could have been caught with a second look</li>
</ul>
<h2 id="how-codeloops-solves-it"><a class="header" href="#how-codeloops-solves-it">How Codeloops Solves It</a></h2>
<p>Codeloops introduces a feedback loop where:</p>
<ol>
<li>The <strong>actor</strong> (a coding agent) executes your task</li>
<li>Git captures the changes made</li>
<li>The <strong>critic</strong> (another agent instance) evaluates the output against your original prompt</li>
<li>If the work is incomplete, the critic provides feedback and the actor tries again</li>
<li>The loop continues until the critic approves or max iterations are reached</li>
</ol>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   prompt.md ──▶ Actor ──▶ Git Diff ──▶ Critic ──▶ Done?    │
│                   ▲                        │                │
│                   │         feedback       │                │
│                   └────────────────────────┘                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="key-benefits"><a class="header" href="#key-benefits">Key Benefits</a></h2>
<ul>
<li><strong>Self-correcting loop</strong>: Mistakes are caught and fixed automatically</li>
<li><strong>Improved task completion</strong>: Multiple iterations ensure requirements are fully met</li>
<li><strong>Full observability</strong>: Every iteration is logged to a session file for review</li>
<li><strong>Agent flexibility</strong>: Mix and match agents for actor and critic roles</li>
<li><strong>Simple interface</strong>: Just write a <code>prompt.md</code> file and run <code>codeloops</code></li>
</ul>
<h2 id="who-should-use-this"><a class="header" href="#who-should-use-this">Who Should Use This</a></h2>
<p>Codeloops is for developers who:</p>
<ul>
<li>Use AI coding agents for development tasks</li>
<li>Want higher quality output from their AI tools</li>
<li>Need a way to review and analyze AI agent behavior</li>
<li>Want to experiment with different agent configurations</li>
</ul>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>Ready to get started? Head to the <a href="#installation">Installation</a> guide to set up codeloops, then follow the <a href="#quickstart">Quickstart</a> to run your first session.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>This guide covers how to install codeloops and its prerequisites.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>Before installing codeloops, ensure you have:</p>
<h3 id="rust-toolchain"><a class="header" href="#rust-toolchain">Rust Toolchain</a></h3>
<p>Codeloops is written in Rust. Install the Rust toolchain via <a href="https://rustup.rs/">rustup</a>:</p>
<pre><code class="language-bash">curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
</code></pre>
<h3 id="at-least-one-supported-agent"><a class="header" href="#at-least-one-supported-agent">At Least One Supported Agent</a></h3>
<p>You need at least one AI coding agent CLI installed:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Agent</th><th>Installation</th></tr>
</thead>
<tbody>
<tr><td>Claude Code</td><td><a href="https://claude.ai/code">claude.ai/code</a></td></tr>
<tr><td>OpenCode</td><td><a href="https://opencode.ai/docs/#install">opencode.ai/docs</a></td></tr>
<tr><td>Cursor</td><td><a href="https://cursor.com/cli">cursor.com/cli</a></td></tr>
</tbody>
</table>
</div>
<p>The agent binary must be in your PATH. Verify with:</p>
<pre><code class="language-bash"># Check which agents are available
which claude
which opencode
which cursor-agent  # or 'agent'
</code></pre>
<h3 id="git"><a class="header" href="#git">Git</a></h3>
<p>Git is required for capturing diffs between iterations:</p>
<pre><code class="language-bash">git --version
</code></pre>
<h2 id="building-from-source"><a class="header" href="#building-from-source">Building from Source</a></h2>
<p>Clone the repository and build:</p>
<pre><code class="language-bash">git clone https://github.com/silvabyte/codeloops
cd codeloops
cargo build --release
</code></pre>
<p>The binary will be at <code>./target/release/codeloops</code>.</p>
<h2 id="adding-to-path"><a class="header" href="#adding-to-path">Adding to PATH</a></h2>
<p>Option 1: Create a symlink:</p>
<pre><code class="language-bash">sudo ln -s $(pwd)/target/release/codeloops /usr/local/bin/codeloops
</code></pre>
<p>Option 2: Copy the binary:</p>
<pre><code class="language-bash">sudo cp ./target/release/codeloops /usr/local/bin/
</code></pre>
<p>Option 3: Add the target directory to your PATH in <code>~/.bashrc</code> or <code>~/.zshrc</code>:</p>
<pre><code class="language-bash">export PATH="$PATH:/path/to/codeloops/target/release"
</code></pre>
<h2 id="verifying-installation"><a class="header" href="#verifying-installation">Verifying Installation</a></h2>
<p>Check that codeloops is installed correctly:</p>
<pre><code class="language-bash">codeloops --version
</code></pre>
<p>You should see output like:</p>
<pre><code>codeloops 0.1.0
</code></pre>
<h2 id="first-time-setup"><a class="header" href="#first-time-setup">First-Time Setup</a></h2>
<p>Run the interactive setup to configure your default agent:</p>
<pre><code class="language-bash">codeloops init
</code></pre>
<p>This creates a global configuration file at <code>~/.config/codeloops/config.toml</code> with your preferred defaults.</p>
<h2 id="installing-the-web-ui-optional"><a class="header" href="#installing-the-web-ui-optional">Installing the Web UI (Optional)</a></h2>
<p>The web UI is included when you build from source. To install it for standalone use:</p>
<pre><code class="language-bash">cd ui
bun install
bun run build
</code></pre>
<p>The built UI will be in <code>ui/dist/</code>. See <a href="#web-ui-overview">Web UI Overview</a> for usage.</p>
<h2 id="next-steps-1"><a class="header" href="#next-steps-1">Next Steps</a></h2>
<p>With codeloops installed, proceed to the <a href="#quickstart">Quickstart</a> guide to run your first session.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="quickstart"><a class="header" href="#quickstart">Quickstart</a></h1>
<p>This guide walks you through running codeloops for the first time.</p>
<h2 id="step-1-initialize-configuration"><a class="header" href="#step-1-initialize-configuration">Step 1: Initialize Configuration</a></h2>
<p>If you haven’t already, run the interactive setup:</p>
<pre><code class="language-bash">codeloops init
</code></pre>
<p>Select your preferred agent (Claude, OpenCode, or Cursor) when prompted.</p>
<h2 id="step-2-create-a-prompt-file"><a class="header" href="#step-2-create-a-prompt-file">Step 2: Create a Prompt File</a></h2>
<p>Navigate to a git repository where you want to make changes:</p>
<pre><code class="language-bash">cd /path/to/your/project
</code></pre>
<p>Create a <code>prompt.md</code> file describing your task:</p>
<pre><code class="language-markdown">Fix the typo in the greeting message. The word "Helo" should be "Hello".
</code></pre>
<p>Keep your first prompt simple and specific. Complex tasks work better once you’re familiar with how the loop operates.</p>
<h2 id="step-3-run-codeloops"><a class="header" href="#step-3-run-codeloops">Step 3: Run Codeloops</a></h2>
<p>Execute the loop:</p>
<pre><code class="language-bash">codeloops
</code></pre>
<p>Codeloops will:</p>
<ol>
<li>Read <code>prompt.md</code> from the current directory</li>
<li>Start the actor agent with your prompt</li>
<li>Capture the git diff after the actor completes</li>
<li>Run the critic agent to evaluate the changes</li>
<li>Either finish (if the critic approves) or loop back with feedback</li>
</ol>
<h2 id="step-4-understand-the-output"><a class="header" href="#step-4-understand-the-output">Step 4: Understand the Output</a></h2>
<p>During execution, you’ll see:</p>
<pre><code>[codeloops] Starting actor-critic loop
[codeloops] Prompt: Fix the typo in the greeting message...
[codeloops] Working directory: /path/to/your/project
[codeloops] Actor: Claude Code | Critic: Claude Code

[iteration 1]
[actor] Running Claude Code...
[actor] Completed in 12.3s (exit code: 0)
[git] 1 file changed, 1 insertion(+), 1 deletion(-)
[critic] Evaluating changes...
[critic] Decision: DONE
[critic] Summary: The typo has been fixed. "Helo" is now "Hello".

[codeloops] Session complete: success (1 iteration)
</code></pre>
<h3 id="decision-types"><a class="header" href="#decision-types">Decision Types</a></h3>
<p>The critic returns one of three decisions:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Decision</th><th>Meaning</th></tr>
</thead>
<tbody>
<tr><td><strong>DONE</strong></td><td>Task is complete, loop ends</td></tr>
<tr><td><strong>CONTINUE</strong></td><td>More work needed, actor runs again with feedback</td></tr>
<tr><td><strong>ERROR</strong></td><td>Something went wrong, actor gets recovery instructions</td></tr>
</tbody>
</table>
</div>
<h2 id="step-5-view-the-result"><a class="header" href="#step-5-view-the-result">Step 5: View the Result</a></h2>
<p>Check what changed:</p>
<pre><code class="language-bash">git diff
</code></pre>
<p>Or use the sessions command:</p>
<pre><code class="language-bash">codeloops sessions show
</code></pre>
<p>This opens an interactive viewer to browse the session details.</p>
<h2 id="alternative-inline-prompt"><a class="header" href="#alternative-inline-prompt">Alternative: Inline Prompt</a></h2>
<p>Instead of a file, you can pass the prompt directly:</p>
<pre><code class="language-bash">codeloops --prompt "Add a --verbose flag to the CLI"
</code></pre>
<h2 id="alternative-specify-agent"><a class="header" href="#alternative-specify-agent">Alternative: Specify Agent</a></h2>
<p>Override the configured agent:</p>
<pre><code class="language-bash">codeloops --agent opencode
</code></pre>
<p>Or use different agents for actor and critic:</p>
<pre><code class="language-bash">codeloops --actor-agent opencode --critic-agent claude
</code></pre>
<h2 id="common-first-run-issues"><a class="header" href="#common-first-run-issues">Common First-Run Issues</a></h2>
<h3 id="agent-not-found"><a class="header" href="#agent-not-found">Agent not found</a></h3>
<pre><code>Error: Agent 'claude' not found in PATH
</code></pre>
<p>Install the agent or ensure its binary is in your PATH.</p>
<h3 id="no-prompt-provided"><a class="header" href="#no-prompt-provided">No prompt provided</a></h3>
<pre><code>Error: No prompt provided. Create a prompt.md file or use --prompt
</code></pre>
<p>Create a <code>prompt.md</code> file or pass <code>--prompt "your task"</code>.</p>
<h3 id="not-a-git-repository"><a class="header" href="#not-a-git-repository">Not a git repository</a></h3>
<pre><code>Error: Not a git repository
</code></pre>
<p>Initialize git or navigate to an existing repository:</p>
<pre><code class="language-bash">git init
</code></pre>
<h2 id="next-steps-2"><a class="header" href="#next-steps-2">Next Steps</a></h2>
<ul>
<li>Read <a href="#your-first-session">Your First Session</a> for a detailed walkthrough</li>
<li>See <a href="#cli-reference">CLI Reference</a> for all available options</li>
<li>Learn about <a href="#configuration">Configuration</a> to customize behavior</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="your-first-session"><a class="header" href="#your-first-session">Your First Session</a></h1>
<p>This guide provides a detailed walkthrough of a real codeloops session, explaining each step of the actor-critic loop.</p>
<h2 id="the-task"><a class="header" href="#the-task">The Task</a></h2>
<p>Let’s say you’re working on a web application and need to add input validation to a user registration endpoint. The endpoint currently accepts any input without checking for valid email format or password requirements.</p>
<h2 id="setting-up"><a class="header" href="#setting-up">Setting Up</a></h2>
<p>Navigate to your project and create a detailed prompt:</p>
<pre><code class="language-bash">cd ~/projects/myapp
</code></pre>
<p>Create <code>prompt.md</code>:</p>
<pre><code class="language-markdown">Add input validation to the user registration endpoint in src/api/users.rs:

Requirements:
- Email must be a valid email format
- Password must be at least 8 characters
- Password must contain at least one uppercase letter and one number
- Return appropriate error messages for validation failures

The endpoint is the `register` function that handles POST /api/users/register.
</code></pre>
<h2 id="running-the-loop"><a class="header" href="#running-the-loop">Running the Loop</a></h2>
<p>Start codeloops:</p>
<pre><code class="language-bash">codeloops
</code></pre>
<h2 id="iteration-1-initial-attempt"><a class="header" href="#iteration-1-initial-attempt">Iteration 1: Initial Attempt</a></h2>
<h3 id="actor-phase"><a class="header" href="#actor-phase">Actor Phase</a></h3>
<p>The actor receives your prompt and starts working:</p>
<pre><code>[iteration 1]
[actor] Running Claude Code...
</code></pre>
<p>The actor examines your codebase, finds <code>src/api/users.rs</code>, and implements validation. After completion:</p>
<pre><code>[actor] Completed in 45.2s (exit code: 0)
[git] 2 files changed, 47 insertions(+), 3 deletions(-)
</code></pre>
<p>The actor made changes to 2 files and the git diff is captured.</p>
<h3 id="critic-phase"><a class="header" href="#critic-phase">Critic Phase</a></h3>
<p>The critic receives:</p>
<ul>
<li>Your original prompt</li>
<li>The actor’s stdout output</li>
<li>The git diff showing all changes</li>
</ul>
<p>The critic evaluates whether the changes meet your requirements:</p>
<pre><code>[critic] Evaluating changes...
[critic] Decision: CONTINUE
[critic] Feedback: The email validation is implemented but the password
         validation only checks length. Missing: uppercase letter check
         and number requirement. Also, error messages are generic -
         please provide specific feedback for each validation rule.
</code></pre>
<h3 id="what-happened"><a class="header" href="#what-happened">What Happened</a></h3>
<p>The actor’s first attempt was incomplete. It added email validation and password length checking, but missed:</p>
<ul>
<li>Uppercase letter requirement</li>
<li>Number requirement</li>
<li>Specific error messages</li>
</ul>
<p>The critic identified these gaps and provided feedback.</p>
<h2 id="iteration-2-addressing-feedback"><a class="header" href="#iteration-2-addressing-feedback">Iteration 2: Addressing Feedback</a></h2>
<h3 id="actor-phase-with-feedback"><a class="header" href="#actor-phase-with-feedback">Actor Phase (with Feedback)</a></h3>
<p>The actor now receives the original prompt plus the critic’s feedback:</p>
<pre><code>[iteration 2]
[actor] Running Claude Code...
</code></pre>
<p>The actor reads the feedback and addresses each point:</p>
<pre><code>[actor] Completed in 32.1s (exit code: 0)
[git] 1 file changed, 28 insertions(+), 12 deletions(-)
</code></pre>
<h3 id="critic-phase-1"><a class="header" href="#critic-phase-1">Critic Phase</a></h3>
<p>The critic re-evaluates:</p>
<pre><code>[critic] Evaluating changes...
[critic] Decision: DONE
[critic] Summary: Input validation is now complete. Email format is
         validated using regex. Password validation checks: minimum
         8 characters, at least one uppercase letter (A-Z), at least
         one digit (0-9). Error messages are specific and helpful.
[critic] Confidence: 0.95
</code></pre>
<h2 id="session-complete"><a class="header" href="#session-complete">Session Complete</a></h2>
<pre><code>[codeloops] Session complete: success (2 iterations)
[codeloops] Duration: 89.4s
[codeloops] Session saved: 2025-01-27T15-30-45Z_a3f2c1
</code></pre>
<p>The loop ends because the critic returned <code>DONE</code>.</p>
<h2 id="reviewing-the-session"><a class="header" href="#reviewing-the-session">Reviewing the Session</a></h2>
<h3 id="using-the-cli"><a class="header" href="#using-the-cli">Using the CLI</a></h3>
<p>View the session details:</p>
<pre><code class="language-bash">codeloops sessions show 2025-01-27T15-30-45Z_a3f2c1
</code></pre>
<p>Or use the interactive picker:</p>
<pre><code class="language-bash">codeloops sessions show
</code></pre>
<h3 id="viewing-the-diff"><a class="header" href="#viewing-the-diff">Viewing the Diff</a></h3>
<p>See the cumulative changes across all iterations:</p>
<pre><code class="language-bash">codeloops sessions diff 2025-01-27T15-30-45Z_a3f2c1
</code></pre>
<h3 id="using-the-web-ui"><a class="header" href="#using-the-web-ui">Using the Web UI</a></h3>
<p>For a visual interface:</p>
<pre><code class="language-bash">codeloops ui
</code></pre>
<p>Navigate to the session to see:</p>
<ul>
<li>Iteration timeline</li>
<li>Each iteration’s diff with syntax highlighting</li>
<li>Critic feedback trail</li>
</ul>
<h2 id="understanding-the-session-file"><a class="header" href="#understanding-the-session-file">Understanding the Session File</a></h2>
<p>The session is stored at <code>~/.local/share/codeloops/sessions/2025-01-27T15-30-45Z_a3f2c1.jsonl</code>:</p>
<pre><code class="language-json">{"type":"session_start","timestamp":"2025-01-27T15:30:45Z","prompt":"Add input validation...","working_dir":"/home/user/projects/myapp","actor_agent":"Claude Code","critic_agent":"Claude Code"}
{"type":"iteration","iteration_number":1,"actor_output":"...","git_diff":"...","critic_decision":"CONTINUE","feedback":"The email validation is implemented but..."}
{"type":"iteration","iteration_number":2,"actor_output":"...","git_diff":"...","critic_decision":"DONE","feedback":null}
{"type":"session_end","outcome":"success","iterations":2,"summary":"Input validation is now complete...","confidence":0.95,"duration_secs":89.4}
</code></pre>
<h2 id="what-if-it-doesnt-go-well"><a class="header" href="#what-if-it-doesnt-go-well">What If It Doesn’t Go Well?</a></h2>
<h3 id="task-takes-too-many-iterations"><a class="header" href="#task-takes-too-many-iterations">Task Takes Too Many Iterations</a></h3>
<p>If the loop continues for many iterations without completing:</p>
<ol>
<li><strong>Set a limit</strong>: Use <code>--max-iterations 5</code> to cap the attempts</li>
<li><strong>Cancel and reformulate</strong>: Press Ctrl+C and rewrite your prompt with more detail</li>
<li><strong>Review the feedback</strong>: Check what the critic is asking for</li>
</ol>
<h3 id="actor-produces-errors"><a class="header" href="#actor-produces-errors">Actor Produces Errors</a></h3>
<p>If the actor exits with an error (non-zero exit code):</p>
<ol>
<li>The critic will suggest recovery steps</li>
<li>The actor tries again with recovery guidance</li>
<li>If errors persist, the session ends as <code>failed</code></li>
</ol>
<h3 id="critic-always-says-continue"><a class="header" href="#critic-always-says-continue">Critic Always Says CONTINUE</a></h3>
<p>This usually means your prompt is ambiguous. The critic doesn’t know when the task is “done” because the requirements aren’t clear. Add explicit acceptance criteria to your prompt.</p>
<h2 id="tips-for-success"><a class="header" href="#tips-for-success">Tips for Success</a></h2>
<ol>
<li><strong>Be specific</strong>: Include file paths, function names, and exact requirements</li>
<li><strong>Define “done”</strong>: What criteria must be met for the task to be complete?</li>
<li><strong>Provide context</strong>: Mention relevant parts of your codebase</li>
<li><strong>Start small</strong>: Complex tasks often work better when broken into smaller prompts</li>
</ol>
<h2 id="next-steps-3"><a class="header" href="#next-steps-3">Next Steps</a></h2>
<ul>
<li>Learn about <a href="#configuration">Configuration</a> to customize agent behavior</li>
<li>See <a href="#writing-prompts">Writing Prompts</a> for prompt best practices</li>
<li>Explore <a href="#sessions">Sessions</a> for session management</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cli-reference"><a class="header" href="#cli-reference">CLI Reference</a></h1>
<p>Complete reference for all codeloops commands and options.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<pre><code>codeloops [OPTIONS] [COMMAND]
</code></pre>
<p>When no command is specified, codeloops runs the actor-critic loop (equivalent to <code>codeloops run</code>).</p>
<h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>run</code></td><td>Run the actor-critic loop (default)</td></tr>
<tr><td><code>sessions</code></td><td>Browse and inspect sessions</td></tr>
<tr><td><code>ui</code></td><td>Start the web UI</td></tr>
<tr><td><code>init</code></td><td>Interactive configuration setup</td></tr>
<tr><td><code>help</code></td><td>Print help information</td></tr>
</tbody>
</table>
</div>
<h2 id="run-command"><a class="header" href="#run-command">Run Command</a></h2>
<p>Execute the actor-critic loop. This is the default command when none is specified.</p>
<pre><code class="language-bash">codeloops run [OPTIONS]
codeloops [OPTIONS]  # Same as above
</code></pre>
<h3 id="prompt-options"><a class="header" href="#prompt-options">Prompt Options</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>-p, --prompt &lt;PROMPT&gt;</code></td><td>String</td><td>-</td><td>Task prompt (inline)</td></tr>
<tr><td><code>--prompt-file &lt;FILE&gt;</code></td><td>Path</td><td><code>prompt.md</code></td><td>Path to prompt file</td></tr>
</tbody>
</table>
</div>
<p>If neither <code>--prompt</code> nor <code>--prompt-file</code> is provided, codeloops looks for <code>prompt.md</code> in the working directory.</p>
<h3 id="directory-options"><a class="header" href="#directory-options">Directory Options</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>-d, --working-dir &lt;DIR&gt;</code></td><td>Path</td><td>Current directory</td><td>Working directory for the session</td></tr>
</tbody>
</table>
</div>
<h3 id="agent-options"><a class="header" href="#agent-options">Agent Options</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>-a, --agent &lt;AGENT&gt;</code></td><td>Enum</td><td><code>claude</code></td><td>Agent for both actor and critic</td></tr>
<tr><td><code>--actor-agent &lt;AGENT&gt;</code></td><td>Enum</td><td>-</td><td>Agent specifically for actor role</td></tr>
<tr><td><code>--critic-agent &lt;AGENT&gt;</code></td><td>Enum</td><td>-</td><td>Agent specifically for critic role</td></tr>
<tr><td><code>-m, --model &lt;MODEL&gt;</code></td><td>String</td><td>-</td><td>Model to use (if agent supports it)</td></tr>
</tbody>
</table>
</div>
<p>Agent values: <code>claude</code>, <code>opencode</code>, <code>cursor</code></p>
<h3 id="loop-control"><a class="header" href="#loop-control">Loop Control</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>-n, --max-iterations &lt;N&gt;</code></td><td>Integer</td><td>Unlimited</td><td>Maximum loop iterations</td></tr>
</tbody>
</table>
</div>
<h3 id="output-options"><a class="header" href="#output-options">Output Options</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>--log-format &lt;FORMAT&gt;</code></td><td>Enum</td><td><code>pretty</code></td><td>Output format</td></tr>
<tr><td><code>--log-file &lt;PATH&gt;</code></td><td>Path</td><td>-</td><td>Write structured logs to file</td></tr>
<tr><td><code>--json-output</code></td><td>Flag</td><td>-</td><td>Output final result as JSON</td></tr>
<tr><td><code>--no-color</code></td><td>Flag</td><td>-</td><td>Disable colored output</td></tr>
</tbody>
</table>
</div>
<p>Log format values: <code>pretty</code>, <code>json</code>, <code>compact</code></p>
<h3 id="other-options"><a class="header" href="#other-options">Other Options</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>--dry-run</code></td><td>Flag</td><td>-</td><td>Show configuration without executing</td></tr>
</tbody>
</table>
</div>
<h3 id="examples"><a class="header" href="#examples">Examples</a></h3>
<pre><code class="language-bash"># Run with default prompt.md
codeloops

# Run with inline prompt
codeloops --prompt "Fix the bug in main.rs"

# Run with custom prompt file
codeloops --prompt-file tasks/feature.md

# Run with specific agent
codeloops --agent opencode

# Run with mixed agents
codeloops --actor-agent opencode --critic-agent claude

# Limit iterations
codeloops --max-iterations 5

# Output as JSON
codeloops --json-output

# Dry run to verify configuration
codeloops --dry-run
</code></pre>
<h2 id="sessions-command"><a class="header" href="#sessions-command">Sessions Command</a></h2>
<p>Browse and inspect recorded sessions.</p>
<pre><code class="language-bash">codeloops sessions &lt;SUBCOMMAND&gt;
</code></pre>
<h3 id="subcommands"><a class="header" href="#subcommands">Subcommands</a></h3>
<h4 id="list"><a class="header" href="#list">list</a></h4>
<p>List all sessions with optional filtering.</p>
<pre><code class="language-bash">codeloops sessions list [OPTIONS]
</code></pre>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>--outcome &lt;OUTCOME&gt;</code></td><td>String</td><td>Filter by outcome: <code>success</code>, <code>failed</code>, <code>interrupted</code>, <code>max_iterations_reached</code></td></tr>
<tr><td><code>--after &lt;DATE&gt;</code></td><td>Date</td><td>Show sessions after date (YYYY-MM-DD)</td></tr>
<tr><td><code>--before &lt;DATE&gt;</code></td><td>Date</td><td>Show sessions before date (YYYY-MM-DD)</td></tr>
<tr><td><code>--search &lt;TEXT&gt;</code></td><td>String</td><td>Search in prompt text</td></tr>
<tr><td><code>--project &lt;NAME&gt;</code></td><td>String</td><td>Filter by project name</td></tr>
</tbody>
</table>
</div>
<p>Examples:</p>
<pre><code class="language-bash"># List all sessions
codeloops sessions list

# Filter by outcome
codeloops sessions list --outcome success

# Filter by date range
codeloops sessions list --after 2025-01-01 --before 2025-01-31

# Search prompts
codeloops sessions list --search "authentication"

# Filter by project
codeloops sessions list --project myapp
</code></pre>
<h4 id="show"><a class="header" href="#show">show</a></h4>
<p>Show detailed session information.</p>
<pre><code class="language-bash">codeloops sessions show [ID]
</code></pre>
<p>If no ID is provided, opens an interactive picker to select a session.</p>
<p>Examples:</p>
<pre><code class="language-bash"># Interactive picker
codeloops sessions show

# Show specific session
codeloops sessions show 2025-01-27T15-30-45Z_a3f2c1
</code></pre>
<h4 id="diff"><a class="header" href="#diff">diff</a></h4>
<p>Show the cumulative git diff from a session.</p>
<pre><code class="language-bash">codeloops sessions diff [ID]
</code></pre>
<p>If no ID is provided, opens an interactive picker.</p>
<p>Examples:</p>
<pre><code class="language-bash"># Interactive picker
codeloops sessions diff

# Show diff for specific session
codeloops sessions diff 2025-01-27T15-30-45Z_a3f2c1
</code></pre>
<h4 id="stats"><a class="header" href="#stats">stats</a></h4>
<p>Show aggregate statistics across all sessions.</p>
<pre><code class="language-bash">codeloops sessions stats
</code></pre>
<p>Output includes:</p>
<ul>
<li>Total sessions</li>
<li>Success rate</li>
<li>Average iterations</li>
<li>Average duration</li>
<li>Sessions by project</li>
</ul>
<h2 id="ui-command"><a class="header" href="#ui-command">UI Command</a></h2>
<p>Start the web UI for visual session browsing.</p>
<pre><code class="language-bash">codeloops ui [OPTIONS]
</code></pre>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>--dev</code></td><td>Flag</td><td>-</td><td>Development mode with hot reloading</td></tr>
<tr><td><code>--api-port &lt;PORT&gt;</code></td><td>Integer</td><td>3100</td><td>API server port</td></tr>
<tr><td><code>--ui-port &lt;PORT&gt;</code></td><td>Integer</td><td>3101</td><td>UI server port</td></tr>
</tbody>
</table>
</div>
<p>Examples:</p>
<pre><code class="language-bash"># Start UI with defaults
codeloops ui

# Custom ports
codeloops ui --api-port 4000 --ui-port 4001

# Development mode
codeloops ui --dev
</code></pre>
<p>The UI opens automatically in your default browser.</p>
<h2 id="init-command"><a class="header" href="#init-command">Init Command</a></h2>
<p>Interactive first-time setup.</p>
<pre><code class="language-bash">codeloops init
</code></pre>
<p>This command:</p>
<ol>
<li>Prompts for your preferred default agent</li>
<li>Creates <code>~/.config/codeloops/config.toml</code></li>
<li>Displays the generated configuration</li>
</ol>
<p>Run this after installation to set up your defaults.</p>
<h2 id="global-options"><a class="header" href="#global-options">Global Options</a></h2>
<p>These options work with any command:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>-h, --help</code></td><td>Print help information</td></tr>
<tr><td><code>-V, --version</code></td><td>Print version information</td></tr>
</tbody>
</table>
</div>
<h2 id="exit-codes"><a class="header" href="#exit-codes">Exit Codes</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Code</th><th>Meaning</th></tr>
</thead>
<tbody>
<tr><td>0</td><td>Success</td></tr>
<tr><td>1</td><td>Max iterations reached</td></tr>
<tr><td>2</td><td>Failed (error during execution)</td></tr>
<tr><td>130</td><td>User interrupted (Ctrl+C)</td></tr>
</tbody>
</table>
</div>
<h2 id="environment-variables"><a class="header" href="#environment-variables">Environment Variables</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Variable</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>CODELOOPS_UI_DIR</code></td><td>Override the UI directory location</td></tr>
<tr><td><code>NO_COLOR</code></td><td>Disable colored output when set</td></tr>
</tbody>
</table>
</div>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>Codeloops supports configuration at two levels: global (user-wide) and project-level. This guide explains how to configure both.</p>
<h2 id="configuration-precedence"><a class="header" href="#configuration-precedence">Configuration Precedence</a></h2>
<p>Settings are resolved in this order (highest to lowest priority):</p>
<ol>
<li>CLI flags (e.g., <code>--agent claude</code>)</li>
<li>Project configuration (<code>codeloops.toml</code> in working directory)</li>
<li>Global configuration (<code>~/.config/codeloops/config.toml</code>)</li>
<li>Built-in defaults</li>
</ol>
<p>For example, if you set <code>agent = "opencode"</code> in your global config but run <code>codeloops --agent claude</code>, Claude will be used.</p>
<h2 id="global-configuration"><a class="header" href="#global-configuration">Global Configuration</a></h2>
<p>Location: <code>~/.config/codeloops/config.toml</code></p>
<p>The global configuration sets your user-wide defaults. Create it with <code>codeloops init</code> or manually.</p>
<h3 id="schema"><a class="header" href="#schema">Schema</a></h3>
<pre><code class="language-toml">[defaults]
agent = "claude"           # Default agent for both roles
model = "sonnet"           # Default model (optional)

[defaults.actor]
agent = "opencode"         # Override agent for actor role
model = "gpt-4o"           # Override model for actor

[defaults.critic]
agent = "claude"           # Override agent for critic role
model = "opus"             # Override model for critic
</code></pre>
<h3 id="fields"><a class="header" href="#fields">Fields</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Section</th><th>Field</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>[defaults]</code></td><td><code>agent</code></td><td>String</td><td>Default agent: <code>claude</code>, <code>opencode</code>, or <code>cursor</code></td></tr>
<tr><td><code>[defaults]</code></td><td><code>model</code></td><td>String</td><td>Default model name (optional)</td></tr>
<tr><td><code>[defaults.actor]</code></td><td><code>agent</code></td><td>String</td><td>Actor-specific agent override</td></tr>
<tr><td><code>[defaults.actor]</code></td><td><code>model</code></td><td>String</td><td>Actor-specific model override</td></tr>
<tr><td><code>[defaults.critic]</code></td><td><code>agent</code></td><td>String</td><td>Critic-specific agent override</td></tr>
<tr><td><code>[defaults.critic]</code></td><td><code>model</code></td><td>String</td><td>Critic-specific model override</td></tr>
</tbody>
</table>
</div>
<h3 id="example-configurations"><a class="header" href="#example-configurations">Example Configurations</a></h3>
<p><strong>Simple setup (same agent for everything):</strong></p>
<pre><code class="language-toml">[defaults]
agent = "claude"
</code></pre>
<p><strong>Mixed agents (fast actor, thorough critic):</strong></p>
<pre><code class="language-toml">[defaults]
agent = "claude"

[defaults.actor]
agent = "opencode"
model = "gpt-4o"

[defaults.critic]
model = "opus"
</code></pre>
<h2 id="project-configuration"><a class="header" href="#project-configuration">Project Configuration</a></h2>
<p>Location: <code>codeloops.toml</code> in the project root (working directory)</p>
<p>Project configuration overrides global settings for a specific project. This is useful when different projects need different agent configurations.</p>
<h3 id="schema-1"><a class="header" href="#schema-1">Schema</a></h3>
<pre><code class="language-toml">agent = "claude"           # Default agent for this project
model = "sonnet"           # Default model (optional)

[actor]
agent = "opencode"         # Actor agent for this project
model = "gpt-4o"           # Actor model for this project

[critic]
agent = "claude"           # Critic agent for this project
model = "opus"             # Critic model for this project
</code></pre>
<h3 id="fields-1"><a class="header" href="#fields-1">Fields</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Section</th><th>Field</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>(root)</td><td><code>agent</code></td><td>String</td><td>Default agent for this project</td></tr>
<tr><td>(root)</td><td><code>model</code></td><td>String</td><td>Default model for this project</td></tr>
<tr><td><code>[actor]</code></td><td><code>agent</code></td><td>String</td><td>Actor agent override</td></tr>
<tr><td><code>[actor]</code></td><td><code>model</code></td><td>String</td><td>Actor model override</td></tr>
<tr><td><code>[critic]</code></td><td><code>agent</code></td><td>String</td><td>Critic agent override</td></tr>
<tr><td><code>[critic]</code></td><td><code>model</code></td><td>String</td><td>Critic model override</td></tr>
</tbody>
</table>
</div>
<h3 id="example-configurations-1"><a class="header" href="#example-configurations-1">Example Configurations</a></h3>
<p><strong>Simple project config:</strong></p>
<pre><code class="language-toml">agent = "claude"
</code></pre>
<p><strong>Project using OpenCode for fast iteration:</strong></p>
<pre><code class="language-toml">[actor]
agent = "opencode"
model = "gpt-4o-mini"

[critic]
agent = "claude"
model = "sonnet"
</code></pre>
<h2 id="resolution-examples"><a class="header" href="#resolution-examples">Resolution Examples</a></h2>
<h3 id="example-1-no-configuration"><a class="header" href="#example-1-no-configuration">Example 1: No configuration</a></h3>
<p>With no config files and running <code>codeloops</code>:</p>
<ul>
<li>Actor: Claude (default)</li>
<li>Critic: Claude (default)</li>
</ul>
<h3 id="example-2-global-config-only"><a class="header" href="#example-2-global-config-only">Example 2: Global config only</a></h3>
<p><code>~/.config/codeloops/config.toml</code>:</p>
<pre><code class="language-toml">[defaults]
agent = "opencode"
</code></pre>
<p>Running <code>codeloops</code>:</p>
<ul>
<li>Actor: OpenCode (from global)</li>
<li>Critic: OpenCode (from global)</li>
</ul>
<h3 id="example-3-global--project-config"><a class="header" href="#example-3-global--project-config">Example 3: Global + project config</a></h3>
<p><code>~/.config/codeloops/config.toml</code>:</p>
<pre><code class="language-toml">[defaults]
agent = "opencode"
</code></pre>
<p><code>codeloops.toml</code>:</p>
<pre><code class="language-toml">agent = "claude"
</code></pre>
<p>Running <code>codeloops</code>:</p>
<ul>
<li>Actor: Claude (project overrides global)</li>
<li>Critic: Claude (project overrides global)</li>
</ul>
<h3 id="example-4-cli-overrides-everything"><a class="header" href="#example-4-cli-overrides-everything">Example 4: CLI overrides everything</a></h3>
<p><code>~/.config/codeloops/config.toml</code>:</p>
<pre><code class="language-toml">[defaults]
agent = "opencode"
</code></pre>
<p><code>codeloops.toml</code>:</p>
<pre><code class="language-toml">agent = "claude"
</code></pre>
<p>Running <code>codeloops --agent cursor</code>:</p>
<ul>
<li>Actor: Cursor (CLI overrides all)</li>
<li>Critic: Cursor (CLI overrides all)</li>
</ul>
<h3 id="example-5-per-role-configuration"><a class="header" href="#example-5-per-role-configuration">Example 5: Per-role configuration</a></h3>
<p><code>~/.config/codeloops/config.toml</code>:</p>
<pre><code class="language-toml">[defaults]
agent = "claude"

[defaults.actor]
agent = "opencode"
</code></pre>
<p>Running <code>codeloops</code>:</p>
<ul>
<li>Actor: OpenCode (from defaults.actor)</li>
<li>Critic: Claude (from defaults)</li>
</ul>
<h3 id="example-6-cli-role-specific-override"><a class="header" href="#example-6-cli-role-specific-override">Example 6: CLI role-specific override</a></h3>
<p><code>~/.config/codeloops/config.toml</code>:</p>
<pre><code class="language-toml">[defaults]
agent = "opencode"
</code></pre>
<p>Running <code>codeloops --critic-agent claude</code>:</p>
<ul>
<li>Actor: OpenCode (from global)</li>
<li>Critic: Claude (CLI override for critic only)</li>
</ul>
<h2 id="creating-configuration"><a class="header" href="#creating-configuration">Creating Configuration</a></h2>
<h3 id="using-init"><a class="header" href="#using-init">Using init</a></h3>
<p>The simplest way to create global configuration:</p>
<pre><code class="language-bash">codeloops init
</code></pre>
<p>This runs an interactive setup and creates the config file.</p>
<h3 id="manual-creation"><a class="header" href="#manual-creation">Manual Creation</a></h3>
<p>Create the file manually:</p>
<pre><code class="language-bash">mkdir -p ~/.config/codeloops
cat &gt; ~/.config/codeloops/config.toml &lt;&lt; 'EOF'
[defaults]
agent = "claude"
EOF
</code></pre>
<p>For project config, create <code>codeloops.toml</code> in your project root.</p>
<h2 id="validating-configuration"><a class="header" href="#validating-configuration">Validating Configuration</a></h2>
<p>Use <code>--dry-run</code> to see the resolved configuration without executing:</p>
<pre><code class="language-bash">codeloops --dry-run
</code></pre>
<p>Output shows the effective agent, model, and other settings that would be used.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="agents"><a class="header" href="#agents">Agents</a></h1>
<p>Codeloops works with multiple AI coding agents. This guide covers supported agents and how to choose between them.</p>
<h2 id="supported-agents"><a class="header" href="#supported-agents">Supported Agents</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Agent</th><th>CLI Value</th><th>Binary</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>Claude Code</td><td><code>claude</code></td><td><code>claude</code></td><td>Anthropic’s Claude-powered coding agent</td></tr>
<tr><td>OpenCode</td><td><code>opencode</code></td><td><code>opencode</code></td><td>Multi-model coding agent</td></tr>
<tr><td>Cursor</td><td><code>cursor-agent</code></td><td><code>cursor-agent</code></td><td>Cursor IDE’s agent CLI</td></tr>
</tbody>
</table>
</div>
<h2 id="agent-details"><a class="header" href="#agent-details">Agent Details</a></h2>
<h3 id="claude-code"><a class="header" href="#claude-code">Claude Code</a></h3>
<p>Claude Code is Anthropic’s official coding agent, powered by Claude models.</p>
<p><strong>Binary</strong>: <code>claude</code></p>
<p><strong>Strengths</strong>:</p>
<ul>
<li>Excellent reasoning and planning</li>
<li>Strong understanding of complex codebases</li>
<li>Good at following detailed instructions</li>
<li>Reliable critic evaluation</li>
</ul>
<p><strong>Installation</strong>: Visit <a href="https://claude.ai/code">claude.ai/code</a></p>
<p><strong>Verify installation</strong>:</p>
<pre><code class="language-bash">which claude
claude --version
</code></pre>
<h3 id="opencode"><a class="header" href="#opencode">OpenCode</a></h3>
<p>OpenCode is a multi-model coding agent that supports various LLM backends.</p>
<p><strong>Binary</strong>: <code>opencode</code></p>
<p><strong>Strengths</strong>:</p>
<ul>
<li>Supports multiple models (GPT-4, etc.)</li>
<li>Fast execution for straightforward tasks</li>
<li>Good for rapid iteration</li>
</ul>
<p><strong>Installation</strong>: Visit <a href="https://opencode.ai/docs/#install">opencode.ai/docs</a></p>
<p><strong>Verify installation</strong>:</p>
<pre><code class="language-bash">which opencode
opencode --version
</code></pre>
<h3 id="cursor"><a class="header" href="#cursor">Cursor</a></h3>
<p>Cursor’s CLI provides access to its coding capabilities outside the IDE.</p>
<p><strong>Binary</strong>: <code>cursor-agent</code> (or <code>agent</code>)</p>
<p><strong>Strengths</strong>:</p>
<ul>
<li>Integrates with Cursor IDE workflow</li>
<li>Familiar for Cursor users</li>
</ul>
<p><strong>Installation</strong>: Visit <a href="https://cursor.com/cli">cursor.com/cli</a></p>
<p><strong>Verify installation</strong>:</p>
<pre><code class="language-bash">which cursor-agent  # or 'agent'
</code></pre>
<h2 id="choosing-agents"><a class="header" href="#choosing-agents">Choosing Agents</a></h2>
<h3 id="same-agent-for-both-roles"><a class="header" href="#same-agent-for-both-roles">Same Agent for Both Roles</a></h3>
<p>The simplest configuration uses one agent for both actor and critic:</p>
<pre><code class="language-bash">codeloops --agent claude
</code></pre>
<p>This is recommended when:</p>
<ul>
<li>You’re starting out and want simplicity</li>
<li>The agent performs well for your use case</li>
<li>You want consistent behavior</li>
</ul>
<h3 id="different-agents-for-actor-and-critic"><a class="header" href="#different-agents-for-actor-and-critic">Different Agents for Actor and Critic</a></h3>
<p>You can use different agents for each role:</p>
<pre><code class="language-bash">codeloops --actor-agent opencode --critic-agent claude
</code></pre>
<p>This is useful when:</p>
<ul>
<li>You want fast iteration with a thorough reviewer</li>
<li>Different agents have different strengths</li>
<li>You’re experimenting with agent combinations</li>
</ul>
<h3 id="configuration-recommendations"><a class="header" href="#configuration-recommendations">Configuration Recommendations</a></h3>
<p><strong>For complex tasks</strong> (refactoring, architecture changes):</p>
<pre><code class="language-bash">codeloops --agent claude
</code></pre>
<p>Use Claude for both roles when the task requires deep understanding.</p>
<p><strong>For fast iteration</strong> (simple fixes, small changes):</p>
<pre><code class="language-bash">codeloops --actor-agent opencode --critic-agent claude
</code></pre>
<p>Use a fast actor with a thorough critic.</p>
<p><strong>For Cursor users</strong>:</p>
<pre><code class="language-bash">codeloops --agent cursor-agent
</code></pre>
<p>Use Cursor if you’re already in the Cursor ecosystem.</p>
<h2 id="model-selection"><a class="header" href="#model-selection">Model Selection</a></h2>
<p>Some agents support model selection:</p>
<pre><code class="language-bash"># Specify model for both roles
codeloops --agent claude --model opus

# Specify model per role (via config file)
</code></pre>
<p>Model support depends on the agent:</p>
<ul>
<li>Claude Code: Supports Claude models (sonnet, opus, etc.)</li>
<li>OpenCode: Supports multiple backends (gpt-4o, etc.)</li>
<li>Cursor: Uses Cursor’s configured model</li>
</ul>
<h2 id="agent-availability"><a class="header" href="#agent-availability">Agent Availability</a></h2>
<p>Codeloops checks agent availability before running. If an agent isn’t found:</p>
<pre><code>Error: Agent 'claude' not found in PATH
</code></pre>
<p>To fix this:</p>
<ol>
<li>Install the agent</li>
<li>Ensure the binary is in your PATH</li>
<li>Verify with <code>which &lt;agent-name&gt;</code></li>
</ol>
<h3 id="checking-all-agents"><a class="header" href="#checking-all-agents">Checking All Agents</a></h3>
<p>Check which agents are available:</p>
<pre><code class="language-bash">which claude opencode cursor-agent
</code></pre>
<h2 id="agent-configuration"><a class="header" href="#agent-configuration">Agent Configuration</a></h2>
<h3 id="in-global-config"><a class="header" href="#in-global-config">In Global Config</a></h3>
<pre><code class="language-toml"># ~/.config/codeloops/config.toml

[defaults]
agent = "claude"

[defaults.actor]
agent = "opencode"

[defaults.critic]
agent = "claude"
</code></pre>
<h3 id="in-project-config"><a class="header" href="#in-project-config">In Project Config</a></h3>
<pre><code class="language-toml"># codeloops.toml

[actor]
agent = "opencode"
model = "gpt-4o"

[critic]
agent = "claude"
model = "sonnet"
</code></pre>
<h2 id="how-agents-are-invoked"><a class="header" href="#how-agents-are-invoked">How Agents Are Invoked</a></h2>
<p>When codeloops runs an agent, it:</p>
<ol>
<li>Spawns the agent binary as a subprocess</li>
<li>Passes the prompt via stdin or command-line arguments</li>
<li>Sets the working directory</li>
<li>Captures stdout, stderr, and exit code</li>
<li>Waits for completion</li>
</ol>
<p>The agent runs with full access to the filesystem within the working directory, allowing it to read and modify files as needed.</p>
<h2 id="agent-output"><a class="header" href="#agent-output">Agent Output</a></h2>
<p>Agent output is captured and passed to the critic. The output typically includes:</p>
<ul>
<li>What the agent did</li>
<li>Files modified</li>
<li>Any errors encountered</li>
</ul>
<p>This output, combined with the git diff, forms the basis for critic evaluation.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="writing-prompts"><a class="header" href="#writing-prompts">Writing Prompts</a></h1>
<p>The quality of your prompt directly affects how well codeloops completes your task. This guide covers how to write effective prompts.</p>
<h2 id="prompt-basics"><a class="header" href="#prompt-basics">Prompt Basics</a></h2>
<h3 id="using-promptmd"><a class="header" href="#using-promptmd">Using prompt.md</a></h3>
<p>The default way to provide a prompt is via a <code>prompt.md</code> file in your working directory:</p>
<pre><code class="language-bash"># Create prompt.md
echo "Fix the authentication bug" &gt; prompt.md

# Run codeloops (reads prompt.md automatically)
codeloops
</code></pre>
<h3 id="using-prompt-flag"><a class="header" href="#using-prompt-flag">Using –prompt Flag</a></h3>
<p>For quick tasks, pass the prompt inline:</p>
<pre><code class="language-bash">codeloops --prompt "Add a --verbose flag to the CLI"
</code></pre>
<h3 id="using-prompt-file"><a class="header" href="#using-prompt-file">Using –prompt-file</a></h3>
<p>Point to a different file:</p>
<pre><code class="language-bash">codeloops --prompt-file tasks/feature-x.md
</code></pre>
<h2 id="anatomy-of-a-good-prompt"><a class="header" href="#anatomy-of-a-good-prompt">Anatomy of a Good Prompt</a></h2>
<p>Effective prompts have four components:</p>
<h3 id="1-clear-objective"><a class="header" href="#1-clear-objective">1. Clear Objective</a></h3>
<p>State exactly what you want done:</p>
<pre><code class="language-markdown">Add input validation to the user registration endpoint.
</code></pre>
<p>Not:</p>
<pre><code class="language-markdown">Improve the user registration.
</code></pre>
<h3 id="2-context"><a class="header" href="#2-context">2. Context</a></h3>
<p>Provide relevant information about your codebase:</p>
<pre><code class="language-markdown">The registration endpoint is in src/api/users.rs, specifically the
`register` function that handles POST /api/users/register.

The User struct is defined in src/models/user.rs.
</code></pre>
<h3 id="3-requirements"><a class="header" href="#3-requirements">3. Requirements</a></h3>
<p>List specific requirements:</p>
<pre><code class="language-markdown">Requirements:
- Email must be a valid email format (use the `validator` crate)
- Password must be at least 8 characters
- Password must contain at least one uppercase letter
- Password must contain at least one number
</code></pre>
<h3 id="4-acceptance-criteria"><a class="header" href="#4-acceptance-criteria">4. Acceptance Criteria</a></h3>
<p>Define what “done” looks like:</p>
<pre><code class="language-markdown">The task is complete when:
- Invalid emails return a 400 error with message "Invalid email format"
- Short passwords return a 400 error with message "Password must be at least 8 characters"
- Weak passwords return a 400 error with specific feedback
- Valid inputs proceed to registration
</code></pre>
<h2 id="prompt-templates"><a class="header" href="#prompt-templates">Prompt Templates</a></h2>
<h3 id="bug-fix"><a class="header" href="#bug-fix">Bug Fix</a></h3>
<pre><code class="language-markdown">## Bug Description
[Describe the bug and how to reproduce it]

## Expected Behavior
[What should happen instead]

## Location
[File path and function name if known]

## Additional Context
[Any relevant information]
</code></pre>
<p>Example:</p>
<pre><code class="language-markdown">## Bug Description
The login endpoint returns 500 when the email contains a plus sign
(e.g., user+tag@example.com).

## Expected Behavior
Plus signs should be valid in email addresses per RFC 5321.

## Location
src/api/auth.rs, `login` function

## Additional Context
The validation regex is likely too strict.
</code></pre>
<h3 id="new-feature"><a class="header" href="#new-feature">New Feature</a></h3>
<pre><code class="language-markdown">## Feature Description
[What the feature should do]

## Requirements
[List of specific requirements]

## Affected Files
[Known files that need changes, if any]

## Acceptance Criteria
[How to know when it's done]
</code></pre>
<p>Example:</p>
<pre><code class="language-markdown">## Feature Description
Add a --dry-run flag to the deploy command that shows what would be
deployed without actually deploying.

## Requirements
- Add --dry-run boolean flag to DeployArgs struct
- When set, print deployment plan instead of executing
- Include file list, target environment, and estimated duration

## Affected Files
- src/commands/deploy.rs (add flag and logic)
- src/lib.rs (if shared types needed)

## Acceptance Criteria
- Running `app deploy --dry-run` shows the plan
- Running `app deploy` without the flag deploys normally
- Help text describes the new flag
</code></pre>
<h3 id="refactoring"><a class="header" href="#refactoring">Refactoring</a></h3>
<pre><code class="language-markdown">## Goal
[What the refactoring achieves]

## Current State
[How the code works now]

## Desired State
[How the code should work after]

## Constraints
- [Any constraints to follow]
- [Behaviors to preserve]
</code></pre>
<p>Example:</p>
<pre><code class="language-markdown">## Goal
Extract the database connection logic into a reusable module.

## Current State
Database connection code is duplicated across:
- src/api/users.rs
- src/api/posts.rs
- src/api/comments.rs

Each file creates its own connection pool.

## Desired State
- Single src/db/mod.rs module with connection pool
- Shared pool instance across all API modules
- Connection configuration from environment variables

## Constraints
- Must maintain backward compatibility
- No changes to API behavior
- Tests must continue to pass
</code></pre>
<h3 id="adding-tests"><a class="header" href="#adding-tests">Adding Tests</a></h3>
<pre><code class="language-markdown">## Target Code
[What needs tests]

## Test Requirements
[What to test]

## Test Location
[Where tests should go]
</code></pre>
<p>Example:</p>
<pre><code class="language-markdown">## Target Code
The `parse_config` function in src/config.rs

## Test Requirements
- Test valid TOML parsing
- Test missing required fields
- Test invalid field types
- Test default value handling
- Test environment variable override

## Test Location
Add tests to src/config.rs in a `#[cfg(test)]` module
</code></pre>
<h2 id="what-to-avoid"><a class="header" href="#what-to-avoid">What to Avoid</a></h2>
<h3 id="vague-instructions"><a class="header" href="#vague-instructions">Vague Instructions</a></h3>
<p>Bad:</p>
<pre><code class="language-markdown">Make the code better.
</code></pre>
<p>Good:</p>
<pre><code class="language-markdown">Refactor the `process_order` function to reduce cyclomatic complexity.
Extract the validation logic into a separate `validate_order` function.
</code></pre>
<h3 id="multiple-unrelated-tasks"><a class="header" href="#multiple-unrelated-tasks">Multiple Unrelated Tasks</a></h3>
<p>Bad:</p>
<pre><code class="language-markdown">Fix the login bug and also add a new dashboard page and update the README.
</code></pre>
<p>Good:</p>
<pre><code class="language-markdown">Fix the login bug where users with spaces in their password can't log in.
</code></pre>
<p>(Create separate prompts for the other tasks)</p>
<h3 id="missing-context"><a class="header" href="#missing-context">Missing Context</a></h3>
<p>Bad:</p>
<pre><code class="language-markdown">Add caching.
</code></pre>
<p>Good:</p>
<pre><code class="language-markdown">Add Redis caching to the `get_user` endpoint in src/api/users.rs.

Cache user data for 5 minutes using the user ID as the key.
The Redis connection string is in the REDIS_URL environment variable.
</code></pre>
<h3 id="ambiguous-done-criteria"><a class="header" href="#ambiguous-done-criteria">Ambiguous “Done” Criteria</a></h3>
<p>Bad:</p>
<pre><code class="language-markdown">Improve performance.
</code></pre>
<p>Good:</p>
<pre><code class="language-markdown">Optimize the `search_products` function to run in under 100ms for
queries matching up to 1000 products.

Currently it takes 2-3 seconds. Add an index on the `name` field
and use pagination with a limit of 50 results.
</code></pre>
<h2 id="multi-step-tasks"><a class="header" href="#multi-step-tasks">Multi-Step Tasks</a></h2>
<p>For complex tasks, break them into smaller prompts:</p>
<p>Instead of:</p>
<pre><code class="language-markdown">Implement a complete user authentication system with registration,
login, logout, password reset, and email verification.
</code></pre>
<p>Do this sequence:</p>
<ol>
<li><code>prompt-1.md</code>: Implement user registration</li>
<li><code>prompt-2.md</code>: Implement user login</li>
<li><code>prompt-3.md</code>: Implement logout</li>
<li><code>prompt-4.md</code>: Implement password reset</li>
<li><code>prompt-5.md</code>: Implement email verification</li>
</ol>
<p>Run each with:</p>
<pre><code class="language-bash">codeloops --prompt-file prompt-1.md
codeloops --prompt-file prompt-2.md
# etc.
</code></pre>
<h2 id="how-the-critic-uses-your-prompt"><a class="header" href="#how-the-critic-uses-your-prompt">How the Critic Uses Your Prompt</a></h2>
<p>The critic evaluates the actor’s work against your prompt. It checks:</p>
<ol>
<li>Were the stated requirements met?</li>
<li>Does the implementation match the acceptance criteria?</li>
<li>Are there obvious issues or gaps?</li>
</ol>
<p>A clear prompt helps the critic make accurate decisions. Vague prompts lead to the critic either:</p>
<ul>
<li>Approving incomplete work (didn’t know what to check)</li>
<li>Continuously requesting changes (unclear when “done”)</li>
</ul>
<h2 id="generating-prompts-with-agent-commands"><a class="header" href="#generating-prompts-with-agent-commands">Generating Prompts with Agent Commands</a></h2>
<p>You can configure your coding agent to generate <code>prompt.md</code> files automatically. This creates a powerful workflow:</p>
<ol>
<li>Use your agent interactively to explore and plan</li>
<li>Run a command that writes the plan to <code>prompt.md</code></li>
<li>Run codeloops with that prompt for structured execution</li>
</ol>
<h3 id="claude-code-1"><a class="header" href="#claude-code-1">Claude Code</a></h3>
<p>Create a command file at <code>~/.claude/commands/promptmd.md</code>:</p>
<pre><code class="language-markdown">---
description: Writes plan out to prompt.md file
---

## Instructions

1. Write out the plan to a prompt.md file in the cwd.
   a. If prompt.md file exists already, create a backup of it using a timestamp: prompt.timestamp.md
2. This prompt.md file will be used to implement the plan in another working session.
3. Ensure it contains detailed tasks to thoroughly implement the plan.
4. Also always ensure the plan includes adding documentation, tests that actually provide confidence and any other quality assurance checks available in the project/codebase.
5. Make sure the plan also specifies to commit the changes once finished.
</code></pre>
<p>Then use it in Claude Code:</p>
<pre><code>&gt; /promptmd
</code></pre>
<h3 id="opencode-1"><a class="header" href="#opencode-1">OpenCode</a></h3>
<p>Create a command file at <code>~/.config/opencode/command/promptmd.md</code> with the same content as above.</p>
<p>Then use it in OpenCode:</p>
<pre><code>&gt; /promptmd
</code></pre>
<h3 id="workflow-example"><a class="header" href="#workflow-example">Workflow Example</a></h3>
<pre><code class="language-bash"># 1. Start your agent and explore the task
opencode
&gt; Analyze the codebase and figure out how to add user authentication

# 2. Once you have a plan, generate the prompt
&gt; /promptmd

# 3. Exit and run codeloops
codeloops
</code></pre>
<p>This workflow lets you leverage your agent’s interactive exploration for planning, then use codeloops’ actor-critic loop for disciplined execution.</p>
<h2 id="tips-for-success-1"><a class="header" href="#tips-for-success-1">Tips for Success</a></h2>
<ol>
<li><strong>Be specific</strong>: File paths, function names, exact requirements</li>
<li><strong>Define done</strong>: What criteria must be met?</li>
<li><strong>Provide context</strong>: Relevant code locations and relationships</li>
<li><strong>One task per prompt</strong>: Complex tasks need multiple prompts</li>
<li><strong>Include constraints</strong>: What must be preserved or avoided?</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="sessions"><a class="header" href="#sessions">Sessions</a></h1>
<p>Every codeloops run is recorded as a session. This guide covers how to view, filter, and analyze your sessions.</p>
<h2 id="session-storage"><a class="header" href="#session-storage">Session Storage</a></h2>
<p>Sessions are stored as JSONL files in:</p>
<pre><code>~/.local/share/codeloops/sessions/
</code></pre>
<p>Each session is a single file named:</p>
<pre><code>&lt;timestamp&gt;_&lt;hash&gt;.jsonl
</code></pre>
<p>For example: <code>2025-01-27T15-30-45Z_a3f2c1.jsonl</code></p>
<p>The hash is derived from the prompt, making it easy to identify related sessions.</p>
<h2 id="listing-sessions"><a class="header" href="#listing-sessions">Listing Sessions</a></h2>
<h3 id="basic-list"><a class="header" href="#basic-list">Basic List</a></h3>
<pre><code class="language-bash">codeloops sessions list
</code></pre>
<p>Output:</p>
<pre><code>ID                            Project    Outcome   Iters  Duration  Prompt
2025-01-27T15-30-45Z_a3f2c1   myapp      success   2      89.4s     Add input validation to...
2025-01-27T14-22-10Z_b5d3e2   myapp      success   1      45.1s     Fix the typo in greeting...
2025-01-26T09-15-33Z_c7f4a9   api-svc    failed    5      312.8s    Implement OAuth flow...
</code></pre>
<h3 id="filtering-by-outcome"><a class="header" href="#filtering-by-outcome">Filtering by Outcome</a></h3>
<pre><code class="language-bash"># Only successful sessions
codeloops sessions list --outcome success

# Only failed sessions
codeloops sessions list --outcome failed

# Interrupted sessions (Ctrl+C)
codeloops sessions list --outcome interrupted

# Max iterations reached
codeloops sessions list --outcome max_iterations_reached
</code></pre>
<h3 id="filtering-by-date"><a class="header" href="#filtering-by-date">Filtering by Date</a></h3>
<pre><code class="language-bash"># Sessions after a date
codeloops sessions list --after 2025-01-01

# Sessions before a date
codeloops sessions list --before 2025-01-31

# Date range
codeloops sessions list --after 2025-01-01 --before 2025-01-31
</code></pre>
<h3 id="filtering-by-project"><a class="header" href="#filtering-by-project">Filtering by Project</a></h3>
<pre><code class="language-bash">codeloops sessions list --project myapp
</code></pre>
<p>The project name is the basename of the working directory where the session ran.</p>
<h3 id="searching-prompts"><a class="header" href="#searching-prompts">Searching Prompts</a></h3>
<pre><code class="language-bash">codeloops sessions list --search "authentication"
</code></pre>
<p>This searches the prompt text for the given substring.</p>
<h3 id="combining-filters"><a class="header" href="#combining-filters">Combining Filters</a></h3>
<pre><code class="language-bash">codeloops sessions list --outcome success --project myapp --after 2025-01-01
</code></pre>
<h2 id="viewing-session-details"><a class="header" href="#viewing-session-details">Viewing Session Details</a></h2>
<h3 id="interactive-picker"><a class="header" href="#interactive-picker">Interactive Picker</a></h3>
<pre><code class="language-bash">codeloops sessions show
</code></pre>
<p>This opens an interactive picker to browse and select a session.</p>
<h3 id="specific-session"><a class="header" href="#specific-session">Specific Session</a></h3>
<pre><code class="language-bash">codeloops sessions show 2025-01-27T15-30-45Z_a3f2c1
</code></pre>
<p>Output includes:</p>
<ul>
<li>Session metadata (timestamp, agents, working directory)</li>
<li>Full prompt text</li>
<li>Each iteration with actor output and critic feedback</li>
<li>Final outcome and summary</li>
</ul>
<h2 id="viewing-session-diffs"><a class="header" href="#viewing-session-diffs">Viewing Session Diffs</a></h2>
<h3 id="interactive-picker-1"><a class="header" href="#interactive-picker-1">Interactive Picker</a></h3>
<pre><code class="language-bash">codeloops sessions diff
</code></pre>
<h3 id="specific-session-1"><a class="header" href="#specific-session-1">Specific Session</a></h3>
<pre><code class="language-bash">codeloops sessions diff 2025-01-27T15-30-45Z_a3f2c1
</code></pre>
<p>This shows the cumulative git diff from all iterations. The diff is syntax-highlighted in the terminal.</p>
<h2 id="session-statistics"><a class="header" href="#session-statistics">Session Statistics</a></h2>
<pre><code class="language-bash">codeloops sessions stats
</code></pre>
<p>Output:</p>
<pre><code>Session Statistics
==================

Total Sessions:    47
Success Rate:      78.7%
Avg Iterations:    2.3
Avg Duration:      94.2s

By Project:
  myapp:           23 sessions (82.6% success)
  api-svc:         15 sessions (73.3% success)
  web-frontend:    9 sessions (77.8% success)

Sessions Over Time:
  2025-01-27:      5 sessions
  2025-01-26:      8 sessions
  2025-01-25:      12 sessions
  ...
</code></pre>
<h2 id="session-outcomes"><a class="header" href="#session-outcomes">Session Outcomes</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Outcome</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>success</code></td><td>Critic approved the work (DONE decision)</td></tr>
<tr><td><code>failed</code></td><td>Error during execution</td></tr>
<tr><td><code>interrupted</code></td><td>User pressed Ctrl+C</td></tr>
<tr><td><code>max_iterations_reached</code></td><td>Hit the iteration limit without completion</td></tr>
</tbody>
</table>
</div>
<h2 id="understanding-session-content"><a class="header" href="#understanding-session-content">Understanding Session Content</a></h2>
<h3 id="session-start"><a class="header" href="#session-start">Session Start</a></h3>
<p>Contains initial configuration:</p>
<ul>
<li>Timestamp</li>
<li>Prompt</li>
<li>Working directory</li>
<li>Actor and critic agents</li>
<li>Models (if specified)</li>
<li>Max iterations (if set)</li>
</ul>
<h3 id="iterations"><a class="header" href="#iterations">Iterations</a></h3>
<p>Each iteration records:</p>
<ul>
<li>Iteration number</li>
<li>Actor output (stdout)</li>
<li>Actor stderr</li>
<li>Actor exit code</li>
<li>Actor duration</li>
<li>Git diff</li>
<li>Files changed count</li>
<li>Critic decision (DONE, CONTINUE, or ERROR)</li>
<li>Critic feedback (if CONTINUE)</li>
<li>Timestamp</li>
</ul>
<h3 id="session-end"><a class="header" href="#session-end">Session End</a></h3>
<p>Final status:</p>
<ul>
<li>Outcome</li>
<li>Total iterations</li>
<li>Summary (from critic)</li>
<li>Confidence score (0-1)</li>
<li>Total duration</li>
</ul>
<h2 id="programmatic-access"><a class="header" href="#programmatic-access">Programmatic Access</a></h2>
<h3 id="using-jq"><a class="header" href="#using-jq">Using jq</a></h3>
<p>Sessions are JSONL (one JSON object per line), making them easy to parse:</p>
<pre><code class="language-bash"># Get the prompt from a session
head -1 ~/.local/share/codeloops/sessions/2025-01-27T15-30-45Z_a3f2c1.jsonl | jq -r '.prompt'

# Get all critic decisions
cat ~/.local/share/codeloops/sessions/2025-01-27T15-30-45Z_a3f2c1.jsonl | jq -r 'select(.type == "iteration") | .critic_decision'

# Get the final outcome
tail -1 ~/.local/share/codeloops/sessions/2025-01-27T15-30-45Z_a3f2c1.jsonl | jq -r '.outcome'
</code></pre>
<h3 id="using-python"><a class="header" href="#using-python">Using Python</a></h3>
<pre><code class="language-python">import json
from pathlib import Path

session_file = Path.home() / ".local/share/codeloops/sessions/2025-01-27T15-30-45Z_a3f2c1.jsonl"

with open(session_file) as f:
    lines = [json.loads(line) for line in f]

start = lines[0]
iterations = [l for l in lines if l.get("type") == "iteration"]
end = lines[-1] if lines[-1].get("type") == "session_end" else None

print(f"Prompt: {start['prompt']}")
print(f"Iterations: {len(iterations)}")
if end:
    print(f"Outcome: {end['outcome']}")
</code></pre>
<h3 id="using-rust"><a class="header" href="#using-rust">Using Rust</a></h3>
<p>The <code>codeloops-sessions</code> crate provides session parsing:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use codeloops_sessions::{SessionStore, SessionFilter};

let store = SessionStore::new()?;
let sessions = store.list_sessions(&amp;SessionFilter::default())?;

for summary in sessions {
    println!("{}: {}", summary.id, summary.prompt_preview);
}

// Load a full session
let session = store.load_session("2025-01-27T15-30-45Z_a3f2c1")?;
println!("Iterations: {}", session.iterations.len());
<span class="boring">}</span></code></pre>
<h2 id="managing-sessions"><a class="header" href="#managing-sessions">Managing Sessions</a></h2>
<h3 id="deleting-sessions"><a class="header" href="#deleting-sessions">Deleting Sessions</a></h3>
<p>Sessions are plain files. Delete them directly:</p>
<pre><code class="language-bash"># Delete a specific session
rm ~/.local/share/codeloops/sessions/2025-01-27T15-30-45Z_a3f2c1.jsonl

# Delete all sessions older than 30 days
find ~/.local/share/codeloops/sessions -name "*.jsonl" -mtime +30 -delete
</code></pre>
<h3 id="backing-up-sessions"><a class="header" href="#backing-up-sessions">Backing Up Sessions</a></h3>
<pre><code class="language-bash"># Copy all sessions to a backup location
cp -r ~/.local/share/codeloops/sessions ~/backups/codeloops-sessions-$(date +%Y%m%d)
</code></pre>
<h3 id="session-size"><a class="header" href="#session-size">Session Size</a></h3>
<p>Sessions can grow large if:</p>
<ul>
<li>The actor produces verbose output</li>
<li>Many iterations occur</li>
<li>Large diffs are generated</li>
</ul>
<p>Check session sizes:</p>
<pre><code class="language-bash">ls -lh ~/.local/share/codeloops/sessions/
</code></pre>
<h2 id="web-ui-for-sessions"><a class="header" href="#web-ui-for-sessions">Web UI for Sessions</a></h2>
<p>For visual session browsing:</p>
<pre><code class="language-bash">codeloops ui
</code></pre>
<p>The web UI provides:</p>
<ul>
<li>Session list with filters</li>
<li>Iteration timeline</li>
<li>Syntax-highlighted diffs</li>
<li>Critic feedback trail</li>
<li>Statistics and charts</li>
</ul>
<p>See <a href="#web-ui-overview">Web UI Overview</a> for details.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="web-ui-overview"><a class="header" href="#web-ui-overview">Web UI Overview</a></h1>
<p>Codeloops includes a web-based interface for browsing and analyzing sessions. This guide provides an overview of what the UI offers.</p>
<h2 id="what-the-web-ui-provides"><a class="header" href="#what-the-web-ui-provides">What the Web UI Provides</a></h2>
<h3 id="session-list"><a class="header" href="#session-list">Session List</a></h3>
<p>Browse all recorded sessions with:</p>
<ul>
<li>Sortable columns (timestamp, project, outcome, iterations, duration)</li>
<li>Quick filters for outcome and project</li>
<li>Search functionality for prompts</li>
<li>Date range filtering</li>
</ul>
<h3 id="session-detail-view"><a class="header" href="#session-detail-view">Session Detail View</a></h3>
<p>Examine individual sessions with:</p>
<ul>
<li>Full prompt display</li>
<li>Session metadata (agents, working directory, duration)</li>
<li>Iteration-by-iteration breakdown</li>
</ul>
<h3 id="iteration-timeline"><a class="header" href="#iteration-timeline">Iteration Timeline</a></h3>
<p>Visualize the actor-critic loop:</p>
<ul>
<li>Timeline showing each iteration</li>
<li>Duration bars for actor execution</li>
<li>Color-coded critic decisions (DONE, CONTINUE, ERROR)</li>
<li>Click to expand iteration details</li>
</ul>
<h3 id="syntax-highlighted-diffs"><a class="header" href="#syntax-highlighted-diffs">Syntax-Highlighted Diffs</a></h3>
<p>View code changes with:</p>
<ul>
<li>Syntax highlighting for common languages</li>
<li>Side-by-side or unified diff view</li>
<li>File-by-file navigation</li>
<li>Line number display</li>
</ul>
<h3 id="statistics-and-charts"><a class="header" href="#statistics-and-charts">Statistics and Charts</a></h3>
<p>Analyze patterns across sessions:</p>
<ul>
<li>Success rate over time</li>
<li>Average iterations per project</li>
<li>Session duration trends</li>
<li>Project-wise breakdown</li>
</ul>
<h3 id="real-time-updates"><a class="header" href="#real-time-updates">Real-Time Updates</a></h3>
<p>When a session is in progress:</p>
<ul>
<li>Live iteration updates via Server-Sent Events</li>
<li>Progress indicators</li>
<li>Auto-refresh of session list</li>
</ul>
<h2 id="when-to-use-cli-vs-ui"><a class="header" href="#when-to-use-cli-vs-ui">When to Use CLI vs UI</a></h2>
<h3 id="use-the-cli-when"><a class="header" href="#use-the-cli-when">Use the CLI when:</a></h3>
<ul>
<li>Doing quick lookups (<code>codeloops sessions show &lt;id&gt;</code>)</li>
<li>Scripting and automation</li>
<li>Working in a terminal-only environment</li>
<li>Piping output to other tools</li>
</ul>
<h3 id="use-the-ui-when"><a class="header" href="#use-the-ui-when">Use the UI when:</a></h3>
<ul>
<li>Browsing multiple sessions</li>
<li>Comparing iterations visually</li>
<li>Analyzing patterns and statistics</li>
<li>Reviewing complex diffs</li>
<li>Sharing session details with others</li>
</ul>
<h2 id="technology-stack"><a class="header" href="#technology-stack">Technology Stack</a></h2>
<p>The web UI is built with:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Technology</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td>React 19</td><td>UI framework</td></tr>
<tr><td>React Router 7</td><td>Client-side routing</td></tr>
<tr><td>TypeScript</td><td>Type safety</td></tr>
<tr><td>Vite</td><td>Build tool and dev server</td></tr>
<tr><td>Tailwind CSS 4</td><td>Styling</td></tr>
<tr><td>Recharts</td><td>Charts and visualizations</td></tr>
<tr><td>Bun</td><td>JavaScript runtime and bundler</td></tr>
</tbody>
</table>
</div>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                      Web Browser                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                    React UI                           │  │
│  │   Dashboard │ Session Detail │ Stats │ Diff Viewer   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP / SSE
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Server (Rust)                        │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────────┐   │
│  │  /sessions  │  │    /stats    │  │  /sessions/live  │   │
│  │   REST API  │  │   REST API   │  │       SSE        │   │
│  └─────────────┘  └──────────────┘  └──────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Session Store (JSONL Files)                    │
│        ~/.local/share/codeloops/sessions/*.jsonl            │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="ports"><a class="header" href="#ports">Ports</a></h2>
<p>By default:</p>
<ul>
<li><strong>API Server</strong>: Port 3100</li>
<li><strong>UI Server</strong>: Port 3101 (development) or served by API (production)</li>
</ul>
<p>Both are configurable via CLI flags.</p>
<h2 id="browser-support"><a class="header" href="#browser-support">Browser Support</a></h2>
<p>The UI works in modern browsers:</p>
<ul>
<li>Chrome/Chromium (recommended)</li>
<li>Firefox</li>
<li>Safari</li>
<li>Edge</li>
</ul>
<h2 id="next-steps-4"><a class="header" href="#next-steps-4">Next Steps</a></h2>
<ul>
<li><a href="#web-ui-usage">Usage Guide</a> - How to use the UI</li>
<li><a href="#web-ui-development">Development Guide</a> - Contributing to the UI</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="web-ui-usage"><a class="header" href="#web-ui-usage">Web UI Usage</a></h1>
<p>This guide covers how to use the codeloops web interface.</p>
<h2 id="starting-the-ui"><a class="header" href="#starting-the-ui">Starting the UI</a></h2>
<h3 id="basic-start"><a class="header" href="#basic-start">Basic Start</a></h3>
<pre><code class="language-bash">codeloops ui
</code></pre>
<p>This:</p>
<ol>
<li>Starts the API server on port 3100</li>
<li>Serves the UI on port 3101</li>
<li>Opens your default browser automatically</li>
</ol>
<h3 id="custom-ports"><a class="header" href="#custom-ports">Custom Ports</a></h3>
<pre><code class="language-bash">codeloops ui --api-port 4000 --ui-port 4001
</code></pre>
<h3 id="development-mode"><a class="header" href="#development-mode">Development Mode</a></h3>
<p>For UI development with hot reloading:</p>
<pre><code class="language-bash">codeloops ui --dev
</code></pre>
<h2 id="navigating-the-interface"><a class="header" href="#navigating-the-interface">Navigating the Interface</a></h2>
<h3 id="sidebar"><a class="header" href="#sidebar">Sidebar</a></h3>
<p>The sidebar provides navigation:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Section</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>Dashboard</td><td>Session list with filters</td></tr>
<tr><td>Stats</td><td>Statistics and charts</td></tr>
</tbody>
</table>
</div>
<h3 id="dashboard-session-list"><a class="header" href="#dashboard-session-list">Dashboard (Session List)</a></h3>
<p>The main view shows all sessions in a table:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Column</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>Timestamp</td><td>When the session started</td></tr>
<tr><td>Project</td><td>Project name (working directory basename)</td></tr>
<tr><td>Outcome</td><td>success, failed, interrupted, or max_iterations_reached</td></tr>
<tr><td>Iterations</td><td>Number of actor-critic loops</td></tr>
<tr><td>Duration</td><td>Total session time</td></tr>
<tr><td>Prompt</td><td>First 100 characters of the prompt</td></tr>
</tbody>
</table>
</div>
<p><strong>Sorting</strong>: Click column headers to sort.</p>
<p><strong>Row click</strong>: Opens the session detail view.</p>
<h3 id="filters"><a class="header" href="#filters">Filters</a></h3>
<p>Above the session table:</p>
<p><strong>Outcome Filter</strong>: Dropdown to filter by outcome type.</p>
<p><strong>Project Filter</strong>: Dropdown to filter by project name.</p>
<p><strong>Search</strong>: Text input to search prompts.</p>
<p><strong>Date Range</strong>: Start and end date pickers.</p>
<p><strong>Clear Filters</strong>: Reset all filters.</p>
<h3 id="session-detail-view-1"><a class="header" href="#session-detail-view-1">Session Detail View</a></h3>
<p>Click a session to open its detail view:</p>
<h4 id="header-section"><a class="header" href="#header-section">Header Section</a></h4>
<ul>
<li>Session ID</li>
<li>Timestamp</li>
<li>Working directory</li>
<li>Actor agent and model</li>
<li>Critic agent and model</li>
<li>Total duration</li>
<li>Final outcome</li>
</ul>
<h4 id="prompt-section"><a class="header" href="#prompt-section">Prompt Section</a></h4>
<p>The full prompt text, rendered as markdown.</p>
<h4 id="iteration-timeline-1"><a class="header" href="#iteration-timeline-1">Iteration Timeline</a></h4>
<p>Visual timeline of iterations:</p>
<pre><code>[===========] 45s  ──▶  CONTINUE
[=======] 32s      ──▶  DONE
</code></pre>
<p>Each bar represents an iteration:</p>
<ul>
<li>Width proportional to duration</li>
<li>Color indicates critic decision:
<ul>
<li>Green: DONE</li>
<li>Yellow: CONTINUE</li>
<li>Red: ERROR</li>
</ul>
</li>
</ul>
<h4 id="iteration-details"><a class="header" href="#iteration-details">Iteration Details</a></h4>
<p>Click an iteration to expand:</p>
<p><strong>Actor Output</strong>: What the agent produced (stdout)</p>
<p><strong>Git Diff</strong>: Syntax-highlighted diff of changes</p>
<p><strong>Critic Feedback</strong>: Feedback text (for CONTINUE decisions)</p>
<p><strong>Metadata</strong>: Duration, exit code, files changed</p>
<h3 id="diff-viewer"><a class="header" href="#diff-viewer">Diff Viewer</a></h3>
<p>The diff viewer shows code changes:</p>
<p><strong>File Tabs</strong>: If multiple files changed, tabs let you switch between them.</p>
<p><strong>Syntax Highlighting</strong>: Code is highlighted based on file extension.</p>
<p><strong>Line Numbers</strong>: Both old and new line numbers shown.</p>
<p><strong>Change Indicators</strong>:</p>
<ul>
<li>Green background: Added lines</li>
<li>Red background: Removed lines</li>
<li>No background: Unchanged context lines</li>
</ul>
<h3 id="stats-page"><a class="header" href="#stats-page">Stats Page</a></h3>
<p>The statistics page shows:</p>
<h4 id="summary-cards"><a class="header" href="#summary-cards">Summary Cards</a></h4>
<ul>
<li>Total Sessions</li>
<li>Success Rate</li>
<li>Average Iterations</li>
<li>Average Duration</li>
</ul>
<h4 id="charts"><a class="header" href="#charts">Charts</a></h4>
<p><strong>Sessions Over Time</strong>: Bar chart showing sessions per day.</p>
<p><strong>Success Rate Trend</strong>: Line chart of success rate over time.</p>
<p><strong>Iterations Distribution</strong>: Histogram of iteration counts.</p>
<p><strong>Duration Distribution</strong>: Histogram of session durations.</p>
<h4 id="by-project"><a class="header" href="#by-project">By Project</a></h4>
<p>Table breakdown per project:</p>
<ul>
<li>Session count</li>
<li>Success rate</li>
<li>Average iterations</li>
<li>Average duration</li>
</ul>
<h3 id="real-time-updates-1"><a class="header" href="#real-time-updates-1">Real-Time Updates</a></h3>
<p>When sessions are running:</p>
<p><strong>Session List</strong>: New sessions appear automatically.</p>
<p><strong>Active Session</strong>: If viewing an active session, iterations appear as they complete.</p>
<p><strong>Status Indicator</strong>: Shows “Live” badge for in-progress sessions.</p>
<p>The UI uses Server-Sent Events (SSE) for real-time updates without polling.</p>
<h2 id="keyboard-shortcuts"><a class="header" href="#keyboard-shortcuts">Keyboard Shortcuts</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Action</th></tr>
</thead>
<tbody>
<tr><td><code>/</code></td><td>Focus search input</td></tr>
<tr><td><code>Esc</code></td><td>Close detail view / clear search</td></tr>
<tr><td><code>j</code></td><td>Next session in list</td></tr>
<tr><td><code>k</code></td><td>Previous session in list</td></tr>
<tr><td><code>Enter</code></td><td>Open selected session</td></tr>
</tbody>
</table>
</div>
<h2 id="url-structure"><a class="header" href="#url-structure">URL Structure</a></h2>
<p>The UI uses client-side routing:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>URL</th><th>View</th></tr>
</thead>
<tbody>
<tr><td><code>/</code></td><td>Dashboard (session list)</td></tr>
<tr><td><code>/sessions/:id</code></td><td>Session detail</td></tr>
<tr><td><code>/stats</code></td><td>Statistics page</td></tr>
</tbody>
</table>
</div>
<p>You can bookmark or share these URLs directly.</p>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="ui-wont-start"><a class="header" href="#ui-wont-start">UI Won’t Start</a></h3>
<p><strong>Port already in use</strong>:</p>
<pre><code>Error: Address already in use (port 3100)
</code></pre>
<p>Solution: Use different ports:</p>
<pre><code class="language-bash">codeloops ui --api-port 4000 --ui-port 4001
</code></pre>
<p><strong>UI directory not found</strong>:</p>
<pre><code>Error: UI directory not found
</code></pre>
<p>Solution: Build the UI or set <code>CODELOOPS_UI_DIR</code>:</p>
<pre><code class="language-bash">cd ui &amp;&amp; bun run build
# or
export CODELOOPS_UI_DIR=/path/to/ui/dist
</code></pre>
<h3 id="no-sessions-showing"><a class="header" href="#no-sessions-showing">No Sessions Showing</a></h3>
<p>Check that sessions exist:</p>
<pre><code class="language-bash">ls ~/.local/share/codeloops/sessions/
</code></pre>
<p>If empty, run some codeloops sessions first.</p>
<h3 id="slow-loading"><a class="header" href="#slow-loading">Slow Loading</a></h3>
<p>Large sessions (many iterations, large diffs) may load slowly. The API paginates where possible, but individual session detail views load the full session.</p>
<h3 id="browser-console-errors"><a class="header" href="#browser-console-errors">Browser Console Errors</a></h3>
<p>Open browser developer tools (F12) and check the console for errors. Common issues:</p>
<ul>
<li>CORS errors: Ensure the API server is running</li>
<li>404 errors: API endpoint issues</li>
<li>Network errors: Port/firewall problems</li>
</ul>
<h2 id="tips"><a class="header" href="#tips">Tips</a></h2>
<ol>
<li>
<p><strong>Use filters</strong>: Large session lists load faster with filters applied.</p>
</li>
<li>
<p><strong>Bookmark searches</strong>: The URL includes filter state, so bookmark filtered views.</p>
</li>
<li>
<p><strong>Compare iterations</strong>: Use the iteration timeline to quickly see where changes happened.</p>
</li>
<li>
<p><strong>Export data</strong>: Use the CLI for programmatic access to session data.</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="web-ui-development"><a class="header" href="#web-ui-development">Web UI Development</a></h1>
<p>This guide covers how to develop and contribute to the codeloops web UI.</p>
<h2 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h2>
<ul>
<li><a href="https://bun.sh/">Bun</a> (recommended) or Node.js 18+</li>
<li>Rust toolchain (for the API server)</li>
</ul>
<h2 id="development-setup"><a class="header" href="#development-setup">Development Setup</a></h2>
<h3 id="clone-and-install"><a class="header" href="#clone-and-install">Clone and Install</a></h3>
<pre><code class="language-bash">git clone https://github.com/silvabyte/codeloops
cd codeloops/ui
bun install
</code></pre>
<h3 id="start-development-servers"><a class="header" href="#start-development-servers">Start Development Servers</a></h3>
<p>Option 1: Use the integrated dev mode:</p>
<pre><code class="language-bash">codeloops ui --dev
</code></pre>
<p>This starts both the API server and Vite dev server with hot reloading.</p>
<p>Option 2: Run servers separately:</p>
<pre><code class="language-bash"># Terminal 1: API server
cargo run -- ui --dev

# Terminal 2: Vite dev server (if needed separately)
cd ui &amp;&amp; bun dev
</code></pre>
<h3 id="development-urls"><a class="header" href="#development-urls">Development URLs</a></h3>
<ul>
<li><strong>UI</strong>: http://localhost:3101</li>
<li><strong>API</strong>: http://localhost:3100</li>
</ul>
<p>In dev mode, the UI proxies API requests to the backend automatically.</p>
<h2 id="project-structure"><a class="header" href="#project-structure">Project Structure</a></h2>
<pre><code>ui/
├── src/
│   ├── main.tsx              # Application entry point
│   ├── App.tsx               # Root component with routing
│   │
│   ├── api/
│   │   ├── types.ts          # TypeScript interfaces
│   │   └── client.ts         # API client functions
│   │
│   ├── pages/
│   │   ├── Dashboard.tsx     # Session list view
│   │   ├── SessionDetail.tsx # Single session view
│   │   ├── Stats.tsx         # Statistics page
│   │   └── NotFound.tsx      # 404 page
│   │
│   ├── components/
│   │   ├── Layout.tsx        # Main layout with sidebar
│   │   ├── Welcome.tsx       # Empty state component
│   │   ├── SessionTable.tsx  # Sessions list table
│   │   ├── SessionFilters.tsx# Filter controls
│   │   ├── StatsBar.tsx      # Statistics summary
│   │   ├── IterationTimeline.tsx # Visual timeline
│   │   ├── CriticTrail.tsx   # Critic feedback display
│   │   └── DiffViewer.tsx    # Code diff viewer
│   │
│   ├── hooks/
│   │   ├── useSessions.ts    # Fetch sessions list
│   │   ├── useSession.ts     # Fetch single session
│   │   ├── useStats.ts       # Fetch statistics
│   │   └── useSSE.ts         # Server-Sent Events
│   │
│   └── lib/
│       └── utils.ts          # Utility functions
│
├── package.json
├── vite.config.ts            # Vite configuration
├── tsconfig.json             # TypeScript configuration
├── tailwind.config.js        # Tailwind CSS configuration
└── serve.ts                  # Standalone server entry
</code></pre>
<h2 id="key-components"><a class="header" href="#key-components">Key Components</a></h2>
<h3 id="api-client-srcapiclientts"><a class="header" href="#api-client-srcapiclientts">API Client (<code>src/api/client.ts</code>)</a></h3>
<p>Functions for fetching data from the backend:</p>
<pre><code class="language-typescript">// Fetch all sessions with optional filters
export async function fetchSessions(filters?: SessionFilter): Promise&lt;SessionSummary[]&gt;

// Fetch a single session by ID
export async function fetchSession(id: string): Promise&lt;Session&gt;

// Fetch session diff
export async function fetchSessionDiff(id: string): Promise&lt;string&gt;

// Fetch statistics
export async function fetchStats(): Promise&lt;SessionStats&gt;
</code></pre>
<h3 id="types-srcapitypests"><a class="header" href="#types-srcapitypests">Types (<code>src/api/types.ts</code>)</a></h3>
<p>TypeScript interfaces matching the Rust types:</p>
<pre><code class="language-typescript">interface SessionSummary {
  id: string
  timestamp: string
  prompt_preview: string
  working_dir: string
  project: string
  outcome: string | null
  iterations: number
  duration_secs: number | null
  confidence: number | null
  actor_agent: string
  critic_agent: string
}

interface Session {
  id: string
  start: SessionStart
  iterations: Iteration[]
  end: SessionEnd | null
}
</code></pre>
<h3 id="hooks"><a class="header" href="#hooks">Hooks</a></h3>
<p>Custom React hooks for data fetching:</p>
<pre><code class="language-typescript">// useSessions.ts
export function useSessions(filters?: SessionFilter) {
  const [sessions, setSessions] = useState&lt;SessionSummary[]&gt;([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState&lt;Error | null&gt;(null)
  // ... fetch logic
  return { sessions, loading, error, refetch }
}
</code></pre>
<h3 id="sse-hook-srchooksusessets"><a class="header" href="#sse-hook-srchooksusessets">SSE Hook (<code>src/hooks/useSSE.ts</code>)</a></h3>
<p>Handles real-time updates:</p>
<pre><code class="language-typescript">export function useSSE(onEvent: (event: SessionEvent) =&gt; void) {
  useEffect(() =&gt; {
    const eventSource = new EventSource('/api/sessions/live')
    eventSource.onmessage = (e) =&gt; {
      const event = JSON.parse(e.data)
      onEvent(event)
    }
    return () =&gt; eventSource.close()
  }, [onEvent])
}
</code></pre>
<h2 id="adding-a-new-page"><a class="header" href="#adding-a-new-page">Adding a New Page</a></h2>
<ol>
<li>Create the page component in <code>src/pages/</code>:</li>
</ol>
<pre><code class="language-typescript">// src/pages/MyPage.tsx
export default function MyPage() {
  return (
    &lt;div&gt;
      &lt;h1&gt;My Page&lt;/h1&gt;
    &lt;/div&gt;
  )
}
</code></pre>
<ol start="2">
<li>Add the route in <code>src/App.tsx</code>:</li>
</ol>
<pre><code class="language-typescript">import MyPage from './pages/MyPage'

// In the Routes:
&lt;Route path="/my-page" element={&lt;MyPage /&gt;} /&gt;
</code></pre>
<ol start="3">
<li>Add navigation in <code>src/components/Layout.tsx</code>:</li>
</ol>
<pre><code class="language-typescript">&lt;NavLink to="/my-page"&gt;My Page&lt;/NavLink&gt;
</code></pre>
<h2 id="adding-a-new-component"><a class="header" href="#adding-a-new-component">Adding a New Component</a></h2>
<ol>
<li>Create the component in <code>src/components/</code>:</li>
</ol>
<pre><code class="language-typescript">// src/components/MyComponent.tsx
interface MyComponentProps {
  title: string
  children: React.ReactNode
}

export function MyComponent({ title, children }: MyComponentProps) {
  return (
    &lt;div className="p-4 border rounded"&gt;
      &lt;h2 className="text-lg font-bold"&gt;{title}&lt;/h2&gt;
      {children}
    &lt;/div&gt;
  )
}
</code></pre>
<ol start="2">
<li>Import and use it:</li>
</ol>
<pre><code class="language-typescript">import { MyComponent } from '../components/MyComponent'

&lt;MyComponent title="Hello"&gt;
  Content here
&lt;/MyComponent&gt;
</code></pre>
<h2 id="styling"><a class="header" href="#styling">Styling</a></h2>
<p>The UI uses Tailwind CSS. Add classes directly to elements:</p>
<pre><code class="language-tsx">&lt;div className="flex items-center gap-4 p-4 bg-gray-100 rounded-lg"&gt;
  &lt;span className="text-sm text-gray-600"&gt;Label&lt;/span&gt;
  &lt;button className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"&gt;
    Click me
  &lt;/button&gt;
&lt;/div&gt;
</code></pre>
<h2 id="building-for-production"><a class="header" href="#building-for-production">Building for Production</a></h2>
<pre><code class="language-bash">cd ui
bun run build
</code></pre>
<p>Output goes to <code>ui/dist/</code>.</p>
<h2 id="creating-a-standalone-binary"><a class="header" href="#creating-a-standalone-binary">Creating a Standalone Binary</a></h2>
<pre><code class="language-bash">cd ui
bun run compile
</code></pre>
<p>This creates a <code>codeloops-ui</code> binary that serves the UI without needing Bun installed.</p>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<h3 id="type-checking"><a class="header" href="#type-checking">Type Checking</a></h3>
<pre><code class="language-bash">bun run typecheck
# or
npx tsc --noEmit
</code></pre>
<h3 id="linting"><a class="header" href="#linting">Linting</a></h3>
<pre><code class="language-bash">bun run lint
# or
npx eslint src/
</code></pre>
<h2 id="api-development"><a class="header" href="#api-development">API Development</a></h2>
<p>The API server is in Rust at <code>crates/codeloops/src/api/</code>. Key files:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>File</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td><code>mod.rs</code></td><td>Router setup</td></tr>
<tr><td><code>sessions.rs</code></td><td>Session endpoints</td></tr>
<tr><td><code>stats.rs</code></td><td>Statistics endpoint</td></tr>
<tr><td><code>sse.rs</code></td><td>Server-Sent Events</td></tr>
</tbody>
</table>
</div>
<p>To add a new API endpoint:</p>
<ol>
<li>Add the handler function in the appropriate file</li>
<li>Add the route in <code>mod.rs</code>:</li>
</ol>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>.route("/api/my-endpoint", get(my_handler))
<span class="boring">}</span></code></pre>
<ol start="3">
<li>Add the corresponding client function in <code>ui/src/api/client.ts</code></li>
</ol>
<h2 id="common-tasks"><a class="header" href="#common-tasks">Common Tasks</a></h2>
<h3 id="update-api-types"><a class="header" href="#update-api-types">Update API Types</a></h3>
<p>When Rust types change:</p>
<ol>
<li>Update <code>ui/src/api/types.ts</code> to match</li>
<li>Update any affected components</li>
</ol>
<h3 id="add-a-new-filter"><a class="header" href="#add-a-new-filter">Add a New Filter</a></h3>
<ol>
<li>Add the filter field to <code>SessionFilter</code> in <code>types.ts</code></li>
<li>Update <code>SessionFilters.tsx</code> to include the new control</li>
<li>Update <code>fetchSessions()</code> to send the filter parameter</li>
<li>Update the Rust API to handle the new filter</li>
</ol>
<h3 id="add-a-chart"><a class="header" href="#add-a-chart">Add a Chart</a></h3>
<ol>
<li>Add the data field to the appropriate type</li>
<li>Import from Recharts:</li>
</ol>
<pre><code class="language-typescript">import { BarChart, Bar, XAxis, YAxis, Tooltip } from 'recharts'
</code></pre>
<ol start="3">
<li>Add the chart component:</li>
</ol>
<pre><code class="language-tsx">&lt;BarChart data={data}&gt;
  &lt;XAxis dataKey="name" /&gt;
  &lt;YAxis /&gt;
  &lt;Tooltip /&gt;
  &lt;Bar dataKey="value" fill="#3b82f6" /&gt;
&lt;/BarChart&gt;
</code></pre>
<h2 id="debugging"><a class="header" href="#debugging">Debugging</a></h2>
<h3 id="browser-devtools"><a class="header" href="#browser-devtools">Browser DevTools</a></h3>
<ul>
<li><strong>Network tab</strong>: Check API requests</li>
<li><strong>Console</strong>: View errors and logs</li>
<li><strong>React DevTools</strong>: Inspect component state</li>
</ul>
<h3 id="api-debugging"><a class="header" href="#api-debugging">API Debugging</a></h3>
<pre><code class="language-bash"># Test API endpoints directly
curl http://localhost:3100/api/sessions
curl http://localhost:3100/api/stats
</code></pre>
<h3 id="sse-debugging"><a class="header" href="#sse-debugging">SSE Debugging</a></h3>
<p>In browser console:</p>
<pre><code class="language-javascript">const es = new EventSource('http://localhost:3100/api/sessions/live')
es.onmessage = (e) =&gt; console.log(JSON.parse(e.data))
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="architecture-overview"><a class="header" href="#architecture-overview">Architecture Overview</a></h1>
<p>This document provides a high-level overview of codeloops’ architecture, design philosophy, and component structure.</p>
<h2 id="design-philosophy"><a class="header" href="#design-philosophy">Design Philosophy</a></h2>
<h3 id="simplicity"><a class="header" href="#simplicity">Simplicity</a></h3>
<p>Codeloops embraces simplicity at every level:</p>
<ul>
<li><strong>Interface</strong>: A <code>prompt.md</code> file is the primary interface. No complex configuration required.</li>
<li><strong>Execution</strong>: Run <code>codeloops</code> and the loop handles the rest.</li>
<li><strong>Output</strong>: JSONL session files are human-readable and tool-friendly.</li>
</ul>
<h3 id="composability"><a class="header" href="#composability">Composability</a></h3>
<p>The system is designed for flexibility:</p>
<ul>
<li><strong>Agent-agnostic</strong>: Works with any coding agent that has a CLI.</li>
<li><strong>Mixed configurations</strong>: Use different agents for actor and critic roles.</li>
<li><strong>Extensible</strong>: Adding new agents requires implementing a simple trait.</li>
</ul>
<h3 id="observability"><a class="header" href="#observability">Observability</a></h3>
<p>Every action is recorded:</p>
<ul>
<li><strong>Full session logging</strong>: All inputs, outputs, and decisions are captured.</li>
<li><strong>Iteration history</strong>: See exactly what happened at each step.</li>
<li><strong>Statistics</strong>: Analyze patterns across sessions.</li>
</ul>
<h2 id="system-diagram"><a class="header" href="#system-diagram">System Diagram</a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                              User Interface                                 │
│  ┌───────────────┐  ┌────────────────┐  ┌───────────────────────────────┐  │
│  │   prompt.md   │  │  CLI (codeloops) │  │         Web UI              │  │
│  │               │  │                  │  │  (sessions, stats, diffs)   │  │
│  └───────┬───────┘  └────────┬─────────┘  └──────────────┬──────────────┘  │
└──────────┼───────────────────┼───────────────────────────┼──────────────────┘
           │                   │                           │
           ▼                   ▼                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Core System                                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         LoopRunner                                  │   │
│  │                    (codeloops-core crate)                           │   │
│  │                                                                     │   │
│  │   ┌─────────────┐          ┌─────────────┐          ┌───────────┐  │   │
│  │   │   Actor     │ ──────▶  │   Git Diff   │ ──────▶  │  Critic   │  │   │
│  │   │   Agent     │          │   Capture    │          │  Agent    │  │   │
│  │   └─────────────┘          └─────────────┘          └───────────┘  │   │
│  │         │                                                  │       │   │
│  │         │                  ┌─────────────┐                 │       │   │
│  │         └──────────────────│  Feedback   │◀────────────────┘       │   │
│  │                            │    Loop     │                         │   │
│  │                            └─────────────┘                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Session Writer                                 │   │
│  │                  (codeloops-logging crate)                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
└────────────────────────────────────┼────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Storage Layer                                     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │             ~/.local/share/codeloops/sessions/*.jsonl               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="component-overview"><a class="header" href="#component-overview">Component Overview</a></h2>
<h3 id="cli-binary-codeloops-crate"><a class="header" href="#cli-binary-codeloops-crate">CLI Binary (<code>codeloops</code> crate)</a></h3>
<p>The main entry point. Responsibilities:</p>
<ul>
<li>Parse command-line arguments</li>
<li>Load configuration (global and project)</li>
<li>Initialize the loop runner</li>
<li>Handle session commands</li>
<li>Serve the web UI and API</li>
</ul>
<h3 id="loop-runner-codeloops-core-crate"><a class="header" href="#loop-runner-codeloops-core-crate">Loop Runner (<code>codeloops-core</code> crate)</a></h3>
<p>Orchestrates the actor-critic loop. Responsibilities:</p>
<ul>
<li>Execute actor agents</li>
<li>Capture git diffs</li>
<li>Execute critic agents</li>
<li>Parse critic decisions</li>
<li>Manage iteration flow</li>
<li>Handle interrupts (Ctrl+C)</li>
</ul>
<h3 id="agent-abstraction-codeloops-agent-crate"><a class="header" href="#agent-abstraction-codeloops-agent-crate">Agent Abstraction (<code>codeloops-agent</code> crate)</a></h3>
<p>Provides a unified interface for coding agents. Responsibilities:</p>
<ul>
<li>Define the <code>Agent</code> trait</li>
<li>Implement agents (Claude, OpenCode, Cursor)</li>
<li>Spawn agent processes</li>
<li>Capture output (stdout, stderr, exit code)</li>
</ul>
<h3 id="critic-evaluation-codeloops-critic-crate"><a class="header" href="#critic-evaluation-codeloops-critic-crate">Critic Evaluation (<code>codeloops-critic</code> crate)</a></h3>
<p>Handles critic logic. Responsibilities:</p>
<ul>
<li>Build evaluation prompts</li>
<li>Parse critic decisions (DONE, CONTINUE, ERROR)</li>
<li>Extract feedback and confidence scores</li>
</ul>
<h3 id="git-operations-codeloops-git-crate"><a class="header" href="#git-operations-codeloops-git-crate">Git Operations (<code>codeloops-git</code> crate)</a></h3>
<p>Manages git interactions. Responsibilities:</p>
<ul>
<li>Capture diffs between iterations</li>
<li>Track changed files</li>
<li>Provide diff summaries</li>
</ul>
<h3 id="logging-codeloops-logging-crate"><a class="header" href="#logging-codeloops-logging-crate">Logging (<code>codeloops-logging</code> crate)</a></h3>
<p>Handles output and session recording. Responsibilities:</p>
<ul>
<li>Format log output (pretty, JSON, compact)</li>
<li>Write session JSONL files</li>
<li>Handle structured events</li>
</ul>
<h3 id="session-management-codeloops-sessions-crate"><a class="header" href="#session-management-codeloops-sessions-crate">Session Management (<code>codeloops-sessions</code> crate)</a></h3>
<p>Reads and queries sessions. Responsibilities:</p>
<ul>
<li>Parse JSONL session files</li>
<li>Provide session summaries (fast)</li>
<li>Filter and search sessions</li>
<li>Calculate statistics</li>
<li>Watch for session changes</li>
</ul>
<h2 id="data-flow"><a class="header" href="#data-flow">Data Flow</a></h2>
<ol>
<li>
<p><strong>Input</strong>: User provides prompt via <code>prompt.md</code> or <code>--prompt</code></p>
</li>
<li>
<p><strong>Configuration</strong>: CLI loads global and project config, resolves agent choices</p>
</li>
<li>
<p><strong>Initialization</strong>: LoopRunner created with actor/critic agents</p>
</li>
<li>
<p><strong>Session Start</strong>: SessionWriter creates JSONL file, writes start line</p>
</li>
<li>
<p><strong>Actor Execution</strong>: Actor agent spawned with prompt, output captured</p>
</li>
<li>
<p><strong>Diff Capture</strong>: Git diff computed between before/after states</p>
</li>
<li>
<p><strong>Critic Evaluation</strong>: Critic agent spawned with actor output + diff</p>
</li>
<li>
<p><strong>Decision Parsing</strong>: Critic response parsed for decision and feedback</p>
</li>
<li>
<p><strong>Session Update</strong>: Iteration recorded to JSONL file</p>
</li>
<li>
<p><strong>Loop Control</strong>: If DONE, end session. If CONTINUE, feed back to actor.</p>
</li>
<li>
<p><strong>Completion</strong>: SessionEnd line written, process exits</p>
</li>
</ol>
<h2 id="why-this-architecture"><a class="header" href="#why-this-architecture">Why This Architecture?</a></h2>
<h3 id="separation-of-concerns"><a class="header" href="#separation-of-concerns">Separation of Concerns</a></h3>
<p>Each crate has a single responsibility:</p>
<ul>
<li><code>codeloops-agent</code>: Knows how to run agents</li>
<li><code>codeloops-critic</code>: Knows how to evaluate</li>
<li><code>codeloops-git</code>: Knows how to diff</li>
<li><code>codeloops-core</code>: Orchestrates everything</li>
</ul>
<p>This makes testing and modification easier.</p>
<h3 id="extensibility"><a class="header" href="#extensibility">Extensibility</a></h3>
<p>Adding a new agent:</p>
<ol>
<li>Implement the <code>Agent</code> trait</li>
<li>Add it to the agent factory</li>
<li>No changes to core loop logic</li>
</ol>
<h3 id="observability-1"><a class="header" href="#observability-1">Observability</a></h3>
<p>JSONL session files provide:</p>
<ul>
<li>Complete audit trail</li>
<li>Easy parsing (standard JSON)</li>
<li>Append-only writes (crash-safe)</li>
<li>Human readability</li>
</ul>
<h3 id="performance"><a class="header" href="#performance">Performance</a></h3>
<p>Design choices for performance:</p>
<ul>
<li>Fast session summaries (read first/last lines only)</li>
<li>Streaming output from agents</li>
<li>Minimal overhead in the loop</li>
</ul>
<h2 id="next-steps-5"><a class="header" href="#next-steps-5">Next Steps</a></h2>
<ul>
<li><a href="#the-actor-critic-loop">The Actor-Critic Loop</a> - Detailed loop mechanics</li>
<li><a href="#crate-structure">Crate Structure</a> - Deep dive into each crate</li>
<li><a href="#data-flow-1">Data Flow</a> - Sequence diagrams and data paths</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="the-actor-critic-loop"><a class="header" href="#the-actor-critic-loop">The Actor-Critic Loop</a></h1>
<p>This document explains the core feedback loop that drives codeloops.</p>
<h2 id="concept"><a class="header" href="#concept">Concept</a></h2>
<p>The actor-critic pattern comes from reinforcement learning, where:</p>
<ul>
<li>The <strong>actor</strong> takes actions (makes code changes)</li>
<li>The <strong>critic</strong> evaluates those actions (reviews the changes)</li>
</ul>
<p>In codeloops:</p>
<ul>
<li>The actor is a coding agent executing your task</li>
<li>The critic is another agent instance evaluating the work</li>
<li>Feedback flows from critic to actor until the task is complete</li>
</ul>
<h2 id="state-machine"><a class="header" href="#state-machine">State Machine</a></h2>
<pre><code>                    ┌──────────────────┐
                    │      START       │
                    └────────┬─────────┘
                             │
                             ▼
                    ┌──────────────────┐
              ┌────▶│ ACTOR_EXECUTING  │◀────┐
              │     └────────┬─────────┘     │
              │              │               │
              │              ▼               │
              │     ┌──────────────────┐     │
              │     │ CAPTURING_DIFF   │     │
              │     └────────┬─────────┘     │
              │              │               │
              │              ▼               │
              │     ┌──────────────────┐     │
              │     │CRITIC_EVALUATING │     │
              │     └────────┬─────────┘     │
              │              │               │
              │   ┌──────────┼──────────┐    │
              │   │          │          │    │
              │   ▼          ▼          ▼    │
              │ ┌────┐   ┌────────┐  ┌─────┐ │
              │ │DONE│   │CONTINUE│  │ERROR│ │
              │ └──┬─┘   └───┬────┘  └──┬──┘ │
              │    │         │          │    │
              │    │         │ feedback │    │
              │    │         └──────────┼────┘
              │    │                    │
              │    │     recovery       │
              │    │     suggestion     │
              │    │         ┌──────────┘
              │    │         │
              │    ▼         ▼
              │ ┌──────┐  ┌──────────────┐
              │ │ END  │  │ FEED_BACK    │
              │ └──────┘  └──────┬───────┘
              │                  │
              └──────────────────┘
</code></pre>
<h2 id="decision-types-1"><a class="header" href="#decision-types-1">Decision Types</a></h2>
<p>The critic returns one of three decisions:</p>
<h3 id="done"><a class="header" href="#done">DONE</a></h3>
<p>The task is complete. The critic has determined that:</p>
<ul>
<li>All requirements in the prompt are met</li>
<li>The implementation is correct</li>
<li>No further changes are needed</li>
</ul>
<p>Response includes:</p>
<ul>
<li>Summary of what was accomplished</li>
<li>Confidence score (0.0 to 1.0)</li>
</ul>
<h3 id="continue"><a class="header" href="#continue">CONTINUE</a></h3>
<p>More work is needed. The critic has determined that:</p>
<ul>
<li>The prompt requirements are not fully met</li>
<li>There are issues that need addressing</li>
<li>Additional changes are required</li>
</ul>
<p>Response includes:</p>
<ul>
<li>Feedback explaining what’s missing or wrong</li>
<li>Guidance for the next iteration</li>
</ul>
<h3 id="error"><a class="header" href="#error">ERROR</a></h3>
<p>Something went wrong. This occurs when:</p>
<ul>
<li>The actor’s exit code indicates failure</li>
<li>The actor produced error output</li>
<li>The changes broke something</li>
</ul>
<p>Response includes:</p>
<ul>
<li>Analysis of what went wrong</li>
<li>Recovery suggestion for the actor</li>
</ul>
<h2 id="iteration-flow"><a class="header" href="#iteration-flow">Iteration Flow</a></h2>
<h3 id="1-actor-execution"><a class="header" href="#1-actor-execution">1. Actor Execution</a></h3>
<p>The actor receives:</p>
<ul>
<li>Original prompt (always)</li>
<li>Previous feedback (if CONTINUE or ERROR)</li>
</ul>
<pre><code>┌─────────────────────────────────────────────────┐
│                 Actor Input                     │
├─────────────────────────────────────────────────┤
│ Original Prompt:                                │
│   Add input validation to the login endpoint.   │
│                                                 │
│ Previous Feedback (if any):                     │
│   The email validation is good, but password    │
│   validation is missing. Please add checks for  │
│   minimum length and required characters.       │
└─────────────────────────────────────────────────┘
</code></pre>
<p>The actor executes with full filesystem access in the working directory.</p>
<h3 id="2-diff-capture"><a class="header" href="#2-diff-capture">2. Diff Capture</a></h3>
<p>After the actor completes, codeloops captures:</p>
<ul>
<li>Git diff (all changes since session start)</li>
<li>Number of files changed</li>
<li>Actor stdout and stderr</li>
<li>Actor exit code</li>
<li>Execution duration</li>
</ul>
<h3 id="3-critic-evaluation"><a class="header" href="#3-critic-evaluation">3. Critic Evaluation</a></h3>
<p>The critic receives:</p>
<ul>
<li>Original prompt</li>
<li>Actor’s output (stdout)</li>
<li>Git diff of changes</li>
<li>Iteration number</li>
<li>Previous history (summarized)</li>
</ul>
<pre><code>┌─────────────────────────────────────────────────┐
│                 Critic Input                    │
├─────────────────────────────────────────────────┤
│ Task Prompt:                                    │
│   Add input validation to the login endpoint.   │
│                                                 │
│ Actor Output:                                   │
│   I've added email validation using regex and   │
│   password length checking...                   │
│                                                 │
│ Git Diff:                                       │
│   diff --git a/src/auth.rs b/src/auth.rs        │
│   +    if !is_valid_email(&amp;email) { ... }       │
│   +    if password.len() &lt; 8 { ... }            │
│                                                 │
│ Iteration: 1                                    │
└─────────────────────────────────────────────────┘
</code></pre>
<h3 id="4-decision-parsing"><a class="header" href="#4-decision-parsing">4. Decision Parsing</a></h3>
<p>The critic’s response is parsed to extract:</p>
<ul>
<li>Decision (DONE, CONTINUE, or ERROR)</li>
<li>Feedback or summary text</li>
<li>Confidence score (for DONE)</li>
</ul>
<p>Expected critic output format:</p>
<pre><code>DECISION: DONE

SUMMARY: Input validation has been added to the login endpoint.
Email addresses are validated using RFC 5321 compliant regex.
Passwords require minimum 8 characters.

CONFIDENCE: 0.95
</code></pre>
<p>Or for CONTINUE:</p>
<pre><code>DECISION: CONTINUE

FEEDBACK: The email validation looks good, but password validation
only checks length. The requirements also specified:
- At least one uppercase letter
- At least one number

Please add these additional password requirements.
</code></pre>
<h3 id="5-loop-control"><a class="header" href="#5-loop-control">5. Loop Control</a></h3>
<p>Based on the decision:</p>
<p><strong>DONE</strong>: Session ends successfully</p>
<ul>
<li>SessionEnd written with outcome=“success”</li>
<li>Summary and confidence recorded</li>
<li>Exit code 0</li>
</ul>
<p><strong>CONTINUE</strong>: Actor runs again</p>
<ul>
<li>Feedback passed to actor</li>
<li>New iteration begins</li>
<li>Same prompt + feedback</li>
</ul>
<p><strong>ERROR</strong>: Recovery attempted</p>
<ul>
<li>Recovery suggestion passed to actor</li>
<li>New iteration begins</li>
<li>If repeated errors, may fail session</li>
</ul>
<h2 id="termination-conditions"><a class="header" href="#termination-conditions">Termination Conditions</a></h2>
<p>The loop ends when:</p>
<ol>
<li><strong>Success</strong>: Critic returns DONE</li>
<li><strong>Max iterations</strong>: Configured limit reached (exit code 1)</li>
<li><strong>Error</strong>: Unrecoverable error occurs (exit code 2)</li>
<li><strong>Interrupt</strong>: User presses Ctrl+C (exit code 130)</li>
</ol>
<h2 id="confidence-scoring"><a class="header" href="#confidence-scoring">Confidence Scoring</a></h2>
<p>When the critic returns DONE, it provides a confidence score:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Score</th><th>Meaning</th></tr>
</thead>
<tbody>
<tr><td>0.9 - 1.0</td><td>High confidence, all requirements clearly met</td></tr>
<tr><td>0.7 - 0.9</td><td>Good confidence, requirements met with minor uncertainty</td></tr>
<tr><td>0.5 - 0.7</td><td>Moderate confidence, some requirements unclear</td></tr>
<tr><td>&lt; 0.5</td><td>Low confidence, task may be incomplete</td></tr>
</tbody>
</table>
</div>
<p>The score is recorded but doesn’t affect loop behavior. It’s informational for users reviewing sessions.</p>
<h2 id="feedback-quality"><a class="header" href="#feedback-quality">Feedback Quality</a></h2>
<p>Good critic feedback:</p>
<ul>
<li>Specific about what’s missing or wrong</li>
<li>References the original requirements</li>
<li>Provides actionable guidance</li>
<li>Prioritizes issues by importance</li>
</ul>
<p>Example of good feedback:</p>
<pre><code>FEEDBACK: The validation is partially implemented:

DONE:
- Email format validation using regex

MISSING:
1. Password minimum length check (required: 8 characters)
2. Password uppercase letter requirement
3. Password digit requirement

Please implement the missing password validations and return
appropriate error messages for each case.
</code></pre>
<h2 id="actor-recovery"><a class="header" href="#actor-recovery">Actor Recovery</a></h2>
<p>When the actor fails (non-zero exit code), the critic provides recovery guidance:</p>
<pre><code>DECISION: ERROR

ANALYSIS: The actor encountered a compilation error:
  error[E0599]: no method named `validate_email` found

RECOVERY: The `validate_email` method doesn't exist. You need to
either:
1. Import it from the `validators` crate, or
2. Implement it in src/utils/validation.rs

Check the project's existing validation patterns in src/utils/.
</code></pre>
<p>The actor then receives this recovery suggestion and attempts to fix the issue.</p>
<h2 id="iteration-limits"><a class="header" href="#iteration-limits">Iteration Limits</a></h2>
<p>Without a limit, loops could run indefinitely. Set limits with:</p>
<pre><code class="language-bash">codeloops --max-iterations 5
</code></pre>
<p>Or in configuration:</p>
<pre><code class="language-toml">max_iterations = 5
</code></pre>
<p>When the limit is reached:</p>
<ul>
<li>Outcome is “max_iterations_reached”</li>
<li>Exit code is 1</li>
<li>Session is complete but task may be unfinished</li>
</ul>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<h3 id="for-prompts"><a class="header" href="#for-prompts">For Prompts</a></h3>
<p>Clear prompts lead to accurate critic evaluation:</p>
<ul>
<li>Include acceptance criteria</li>
<li>Be specific about requirements</li>
<li>Define what “done” looks like</li>
</ul>
<h3 id="for-iteration-limits"><a class="header" href="#for-iteration-limits">For Iteration Limits</a></h3>
<p>Choose limits based on task complexity:</p>
<ul>
<li>Simple fixes: 2-3 iterations</li>
<li>Medium features: 5-10 iterations</li>
<li>Complex tasks: Consider breaking into smaller prompts</li>
</ul>
<h3 id="for-agent-selection"><a class="header" href="#for-agent-selection">For Agent Selection</a></h3>
<p>Consider critic thoroughness:</p>
<ul>
<li>More thorough critic = better feedback but slower</li>
<li>Faster critic = quicker iterations but may miss issues</li>
</ul>
<h2 id="implementation-details"><a class="header" href="#implementation-details">Implementation Details</a></h2>
<p>The loop is implemented in <code>codeloops-core/src/loop_runner.rs</code>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub async fn run(&amp;self, context: LoopContext) -&gt; Result&lt;LoopOutcome, LoopError&gt; {
    loop {
        // Run actor
        let actor_output = self.actor.execute(&amp;context.build_prompt()).await?;

        // Capture diff
        let diff = self.diff_capture.capture()?;

        // Run critic
        let critic_output = self.critic.evaluate(&amp;actor_output, &amp;diff).await?;

        // Parse decision
        match critic_output.decision {
            Decision::Done { summary, confidence } =&gt; {
                return Ok(LoopOutcome::Success { ... });
            }
            Decision::Continue { feedback } =&gt; {
                context.set_feedback(feedback);
                continue;
            }
            Decision::Error { recovery } =&gt; {
                context.set_feedback(recovery);
                continue;
            }
        }
    }
}
<span class="boring">}</span></code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="crate-structure"><a class="header" href="#crate-structure">Crate Structure</a></h1>
<p>Codeloops is organized as a Rust workspace with multiple crates. This document details each crate’s purpose and key types.</p>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Crate</th><th>Type</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td><code>codeloops</code></td><td>Binary</td><td>CLI, API server, session viewer</td></tr>
<tr><td><code>codeloops-core</code></td><td>Library</td><td>Loop orchestration</td></tr>
<tr><td><code>codeloops-agent</code></td><td>Library</td><td>Agent abstraction</td></tr>
<tr><td><code>codeloops-critic</code></td><td>Library</td><td>Critic evaluation</td></tr>
<tr><td><code>codeloops-git</code></td><td>Library</td><td>Git diff capture</td></tr>
<tr><td><code>codeloops-logging</code></td><td>Library</td><td>Logging and session writing</td></tr>
<tr><td><code>codeloops-sessions</code></td><td>Library</td><td>Session reading and parsing</td></tr>
</tbody>
</table>
</div>
<h2 id="dependency-graph"><a class="header" href="#dependency-graph">Dependency Graph</a></h2>
<pre><code>                    ┌─────────────────┐
                    │   codeloops     │  (binary)
                    │                 │
                    └────────┬────────┘
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
           ▼                 ▼                 ▼
┌──────────────────┐ ┌──────────────┐ ┌─────────────────┐
│ codeloops-core   │ │codeloops-    │ │ codeloops-      │
│                  │ │sessions      │ │ logging         │
└────────┬─────────┘ └──────────────┘ └─────────────────┘
         │
    ┌────┴────┬─────────────┐
    │         │             │
    ▼         ▼             ▼
┌────────┐ ┌────────┐ ┌──────────────┐
│agent   │ │critic  │ │    git       │
└────────┘ └────────┘ └──────────────┘
</code></pre>
<h2 id="codeloops-binary-crate"><a class="header" href="#codeloops-binary-crate">codeloops (Binary Crate)</a></h2>
<p><strong>Location</strong>: <code>crates/codeloops/</code></p>
<p>The main CLI binary. Entry point for all user interactions.</p>
<h3 id="key-files"><a class="header" href="#key-files">Key Files</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>File</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td><code>main.rs</code></td><td>CLI entry, argument parsing, command dispatch</td></tr>
<tr><td><code>config.rs</code></td><td>Configuration loading (global + project)</td></tr>
<tr><td><code>sessions.rs</code></td><td>Session commands (list, show, diff, stats)</td></tr>
<tr><td><code>init.rs</code></td><td>Interactive setup</td></tr>
<tr><td><code>ui.rs</code></td><td>Web UI launcher</td></tr>
<tr><td><code>api/mod.rs</code></td><td>API server router</td></tr>
<tr><td><code>api/sessions.rs</code></td><td>Session API endpoints</td></tr>
<tr><td><code>api/stats.rs</code></td><td>Statistics API endpoint</td></tr>
<tr><td><code>api/sse.rs</code></td><td>Server-Sent Events for live updates</td></tr>
</tbody>
</table>
</div>
<h3 id="key-types"><a class="header" href="#key-types">Key Types</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// CLI argument structure
struct Cli {
    prompt: Option&lt;String&gt;,
    prompt_file: Option&lt;PathBuf&gt;,
    working_dir: Option&lt;PathBuf&gt;,
    agent: Option&lt;AgentChoice&gt;,
    actor_agent: Option&lt;AgentChoice&gt;,
    critic_agent: Option&lt;AgentChoice&gt;,
    max_iterations: Option&lt;usize&gt;,
    // ...
}

enum Commands {
    Run,
    Sessions(SessionsAction),
    Ui(UiArgs),
    Init,
}

// Configuration types
struct GlobalConfig {
    defaults: DefaultsConfig,
}

struct ProjectConfig {
    agent: Option&lt;String&gt;,
    model: Option&lt;String&gt;,
    actor: Option&lt;RoleConfig&gt;,
    critic: Option&lt;RoleConfig&gt;,
}
<span class="boring">}</span></code></pre>
<h2 id="codeloops-core-library-crate"><a class="header" href="#codeloops-core-library-crate">codeloops-core (Library Crate)</a></h2>
<p><strong>Location</strong>: <code>crates/codeloops-core/</code></p>
<p>Core loop orchestration logic.</p>
<h3 id="key-files-1"><a class="header" href="#key-files-1">Key Files</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>File</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td><code>lib.rs</code></td><td>Crate root, re-exports</td></tr>
<tr><td><code>loop_runner.rs</code></td><td>Main loop execution</td></tr>
<tr><td><code>context.rs</code></td><td>Loop context and iteration records</td></tr>
<tr><td><code>outcome.rs</code></td><td>Loop outcomes (Success, Failed, etc.)</td></tr>
<tr><td><code>error.rs</code></td><td>Error types</td></tr>
</tbody>
</table>
</div>
<h3 id="key-types-1"><a class="header" href="#key-types-1">Key Types</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Loop orchestrator
pub struct LoopRunner {
    actor: Arc&lt;dyn Agent&gt;,
    critic: Arc&lt;dyn Agent&gt;,
    diff_capture: DiffCapture,
    logger: Logger,
    session_writer: SessionWriter,
    interrupt: Arc&lt;AtomicBool&gt;,
}

// Shared context across iterations
pub struct LoopContext {
    pub prompt: String,
    pub working_dir: PathBuf,
    pub iteration: usize,
    pub history: Vec&lt;IterationRecord&gt;,
    pub max_iterations: Option&lt;usize&gt;,
    pub last_feedback: Option&lt;String&gt;,
}

// Record of one iteration
pub struct IterationRecord {
    pub iteration_number: usize,
    pub actor_output: String,
    pub actor_stderr: String,
    pub actor_exit_code: i32,
    pub actor_duration_secs: f64,
    pub git_diff: String,
    pub git_files_changed: usize,
    pub critic_output: String,
    pub critic_decision: String,
    pub timestamp: DateTime&lt;Utc&gt;,
}

// Terminal states
pub enum LoopOutcome {
    Success { iterations, summary, confidence, history, duration },
    MaxIterationsReached { iterations, history, duration },
    UserInterrupted { iterations, history, duration },
    Failed { iterations, error, history, duration },
}
<span class="boring">}</span></code></pre>
<h3 id="main-loop"><a class="header" href="#main-loop">Main Loop</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl LoopRunner {
    pub async fn run(&amp;self, context: LoopContext) -&gt; Result&lt;LoopOutcome&gt; {
        // Write session start
        self.session_writer.write_start(&amp;context)?;

        loop {
            // Check interrupt
            if self.interrupt.load(Ordering::SeqCst) {
                return Ok(LoopOutcome::UserInterrupted { ... });
            }

            // Check max iterations
            if let Some(max) = context.max_iterations {
                if context.iteration &gt;= max {
                    return Ok(LoopOutcome::MaxIterationsReached { ... });
                }
            }

            // Execute iteration
            let result = self.run_iteration(&amp;mut context).await?;

            match result {
                IterationResult::Done { summary, confidence } =&gt; {
                    return Ok(LoopOutcome::Success { ... });
                }
                IterationResult::Continue { feedback } =&gt; {
                    context.last_feedback = Some(feedback);
                    context.iteration += 1;
                }
            }
        }
    }
}
<span class="boring">}</span></code></pre>
<h2 id="codeloops-agent-library-crate"><a class="header" href="#codeloops-agent-library-crate">codeloops-agent (Library Crate)</a></h2>
<p><strong>Location</strong>: <code>crates/codeloops-agent/</code></p>
<p>Agent abstraction layer.</p>
<h3 id="key-files-2"><a class="header" href="#key-files-2">Key Files</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>File</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td><code>lib.rs</code></td><td>Crate root, factory function</td></tr>
<tr><td><code>traits.rs</code></td><td>Agent trait definition</td></tr>
<tr><td><code>claude.rs</code></td><td>Claude Code agent</td></tr>
<tr><td><code>opencode.rs</code></td><td>OpenCode agent</td></tr>
<tr><td><code>cursor.rs</code></td><td>Cursor agent</td></tr>
<tr><td><code>spawner.rs</code></td><td>Process spawning utilities</td></tr>
<tr><td><code>output.rs</code></td><td>Output types</td></tr>
</tbody>
</table>
</div>
<h3 id="key-types-2"><a class="header" href="#key-types-2">Key Types</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Agent interface
#[async_trait]
pub trait Agent: Send + Sync {
    fn name(&amp;self) -&gt; &amp;str;
    fn agent_type(&amp;self) -&gt; AgentType;

    async fn execute(
        &amp;self,
        prompt: &amp;str,
        config: &amp;AgentConfig,
    ) -&gt; Result&lt;AgentOutput, AgentError&gt;;

    async fn is_available(&amp;self) -&gt; bool;
    fn binary_path(&amp;self) -&gt; &amp;Path;
}

// Agent types
pub enum AgentType {
    ClaudeCode,
    OpenCode,
    Cursor,
}

// Agent configuration
pub struct AgentConfig {
    pub working_dir: PathBuf,
    pub timeout: Option&lt;Duration&gt;,
    pub env_vars: HashMap&lt;String, String&gt;,
    pub model: Option&lt;String&gt;,
}

// Agent execution result
pub struct AgentOutput {
    pub stdout: String,
    pub stderr: String,
    pub exit_code: i32,
    pub duration: Duration,
}

// Factory function
pub fn create_agent(agent_type: AgentType) -&gt; Box&lt;dyn Agent&gt; {
    match agent_type {
        AgentType::ClaudeCode =&gt; Box::new(ClaudeCodeAgent::new()),
        AgentType::OpenCode =&gt; Box::new(OpenCodeAgent::new()),
        AgentType::Cursor =&gt; Box::new(CursorAgent::new()),
    }
}
<span class="boring">}</span></code></pre>
<h2 id="codeloops-critic-library-crate"><a class="header" href="#codeloops-critic-library-crate">codeloops-critic (Library Crate)</a></h2>
<p><strong>Location</strong>: <code>crates/codeloops-critic/</code></p>
<p>Critic evaluation and decision parsing.</p>
<h3 id="key-files-3"><a class="header" href="#key-files-3">Key Files</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>File</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td><code>lib.rs</code></td><td>Crate root, re-exports</td></tr>
<tr><td><code>evaluator.rs</code></td><td>Critic evaluation logic</td></tr>
<tr><td><code>decision.rs</code></td><td>Decision types and parsing</td></tr>
<tr><td><code>prompts.rs</code></td><td>Prompt templates for critic</td></tr>
</tbody>
</table>
</div>
<h3 id="key-types-3"><a class="header" href="#key-types-3">Key Types</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Critic evaluator
pub struct CriticEvaluator {
    agent: Arc&lt;dyn Agent&gt;,
}

// Decision types
pub enum CriticDecision {
    Done {
        summary: String,
        confidence: f64,
    },
    Continue {
        feedback: String,
    },
    Error {
        recovery: String,
    },
}

// Evaluation input
pub struct EvaluationInput {
    pub prompt: String,
    pub actor_output: String,
    pub git_diff: String,
    pub iteration: usize,
}
<span class="boring">}</span></code></pre>
<h2 id="codeloops-git-library-crate"><a class="header" href="#codeloops-git-library-crate">codeloops-git (Library Crate)</a></h2>
<p><strong>Location</strong>: <code>crates/codeloops-git/</code></p>
<p>Git operations for diff capture.</p>
<h3 id="key-files-4"><a class="header" href="#key-files-4">Key Files</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>File</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td><code>lib.rs</code></td><td>Crate root, re-exports</td></tr>
<tr><td><code>diff.rs</code></td><td>Diff capture functionality</td></tr>
<tr><td><code>status.rs</code></td><td>Git status utilities</td></tr>
</tbody>
</table>
</div>
<h3 id="key-types-4"><a class="header" href="#key-types-4">Key Types</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Diff capture utility
pub struct DiffCapture {
    working_dir: PathBuf,
    baseline_commit: Option&lt;String&gt;,
}

// Diff result
pub struct DiffSummary {
    pub diff: String,
    pub files_changed: usize,
    pub insertions: usize,
    pub deletions: usize,
}

impl DiffCapture {
    pub fn new(working_dir: PathBuf) -&gt; Self;
    pub fn capture(&amp;self) -&gt; Result&lt;DiffSummary&gt;;
    pub fn set_baseline(&amp;mut self);
}
<span class="boring">}</span></code></pre>
<h2 id="codeloops-logging-library-crate"><a class="header" href="#codeloops-logging-library-crate">codeloops-logging (Library Crate)</a></h2>
<p><strong>Location</strong>: <code>crates/codeloops-logging/</code></p>
<p>Logging and session file writing.</p>
<h3 id="key-files-5"><a class="header" href="#key-files-5">Key Files</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>File</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td><code>lib.rs</code></td><td>Crate root, re-exports</td></tr>
<tr><td><code>session.rs</code></td><td>Session JSONL writer</td></tr>
<tr><td><code>events.rs</code></td><td>Log event types</td></tr>
</tbody>
</table>
</div>
<h3 id="key-types-5"><a class="header" href="#key-types-5">Key Types</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Session writer
pub struct SessionWriter {
    file: File,
    id: String,
}

// Session line types
#[derive(Serialize)]
#[serde(tag = "type")]
pub enum SessionLine {
    #[serde(rename = "session_start")]
    SessionStart {
        timestamp: DateTime&lt;Utc&gt;,
        prompt: String,
        working_dir: PathBuf,
        actor_agent: String,
        critic_agent: String,
        actor_model: Option&lt;String&gt;,
        critic_model: Option&lt;String&gt;,
        max_iterations: Option&lt;usize&gt;,
    },
    #[serde(rename = "iteration")]
    Iteration {
        iteration_number: usize,
        actor_output: String,
        actor_stderr: String,
        actor_exit_code: i32,
        actor_duration_secs: f64,
        git_diff: String,
        git_files_changed: usize,
        critic_decision: String,
        feedback: Option&lt;String&gt;,
        timestamp: DateTime&lt;Utc&gt;,
    },
    #[serde(rename = "session_end")]
    SessionEnd {
        outcome: String,
        iterations: usize,
        summary: Option&lt;String&gt;,
        confidence: Option&lt;f64&gt;,
        duration_secs: f64,
        timestamp: DateTime&lt;Utc&gt;,
    },
}

impl SessionWriter {
    pub fn new(sessions_dir: &amp;Path, prompt: &amp;str) -&gt; Result&lt;Self&gt;;
    pub fn write_start(&amp;mut self, ...) -&gt; Result&lt;()&gt;;
    pub fn write_iteration(&amp;mut self, ...) -&gt; Result&lt;()&gt;;
    pub fn write_end(&amp;mut self, ...) -&gt; Result&lt;()&gt;;
}
<span class="boring">}</span></code></pre>
<h2 id="codeloops-sessions-library-crate"><a class="header" href="#codeloops-sessions-library-crate">codeloops-sessions (Library Crate)</a></h2>
<p><strong>Location</strong>: <code>crates/codeloops-sessions/</code></p>
<p>Session reading, parsing, and querying.</p>
<h3 id="key-files-6"><a class="header" href="#key-files-6">Key Files</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>File</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td><code>lib.rs</code></td><td>Crate root, re-exports</td></tr>
<tr><td><code>store.rs</code></td><td>Session storage access</td></tr>
<tr><td><code>parser.rs</code></td><td>JSONL parsing</td></tr>
<tr><td><code>types.rs</code></td><td>Session types</td></tr>
<tr><td><code>watcher.rs</code></td><td>File system watcher for live updates</td></tr>
</tbody>
</table>
</div>
<h3 id="key-types-6"><a class="header" href="#key-types-6">Key Types</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Session store
pub struct SessionStore {
    sessions_dir: PathBuf,
}

// Full session
pub struct Session {
    pub id: String,
    pub start: SessionStart,
    pub iterations: Vec&lt;Iteration&gt;,
    pub end: Option&lt;SessionEnd&gt;,
}

// Session summary (for listings)
pub struct SessionSummary {
    pub id: String,
    pub timestamp: DateTime&lt;Utc&gt;,
    pub prompt_preview: String,
    pub working_dir: PathBuf,
    pub project: String,
    pub outcome: Option&lt;String&gt;,
    pub iterations: usize,
    pub duration_secs: Option&lt;f64&gt;,
    pub confidence: Option&lt;f64&gt;,
    pub actor_agent: String,
    pub critic_agent: String,
}

// Filter criteria
pub struct SessionFilter {
    pub outcome: Option&lt;String&gt;,
    pub after: Option&lt;DateTime&lt;Utc&gt;&gt;,
    pub before: Option&lt;DateTime&lt;Utc&gt;&gt;,
    pub search: Option&lt;String&gt;,
    pub project: Option&lt;String&gt;,
}

// Statistics
pub struct SessionStats {
    pub total_sessions: usize,
    pub success_rate: f64,
    pub avg_iterations: f64,
    pub avg_duration_secs: f64,
    pub sessions_over_time: Vec&lt;DayCount&gt;,
    pub by_project: Vec&lt;ProjectStats&gt;,
}

impl SessionStore {
    pub fn new() -&gt; Result&lt;Self&gt;;
    pub fn list_sessions(&amp;self, filter: &amp;SessionFilter) -&gt; Result&lt;Vec&lt;SessionSummary&gt;&gt;;
    pub fn load_session(&amp;self, id: &amp;str) -&gt; Result&lt;Session&gt;;
    pub fn get_stats(&amp;self) -&gt; Result&lt;SessionStats&gt;;
}
<span class="boring">}</span></code></pre>
<h2 id="which-crate-for-which-change"><a class="header" href="#which-crate-for-which-change">Which Crate for Which Change?</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Change Type</th><th>Crate</th></tr>
</thead>
<tbody>
<tr><td>New CLI command</td><td><code>codeloops</code></td></tr>
<tr><td>Configuration options</td><td><code>codeloops</code></td></tr>
<tr><td>Loop behavior</td><td><code>codeloops-core</code></td></tr>
<tr><td>New agent support</td><td><code>codeloops-agent</code></td></tr>
<tr><td>Critic evaluation logic</td><td><code>codeloops-critic</code></td></tr>
<tr><td>Git operations</td><td><code>codeloops-git</code></td></tr>
<tr><td>Log output format</td><td><code>codeloops-logging</code></td></tr>
<tr><td>Session parsing</td><td><code>codeloops-sessions</code></td></tr>
<tr><td>API endpoints</td><td><code>codeloops</code> (api/)</td></tr>
<tr><td>Web UI</td><td><code>ui/</code> (separate)</td></tr>
</tbody>
</table>
</div>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="data-flow-1"><a class="header" href="#data-flow-1">Data Flow</a></h1>
<p>This document details how data flows through codeloops during execution.</p>
<h2 id="high-level-flow"><a class="header" href="#high-level-flow">High-Level Flow</a></h2>
<pre><code>User Input          Processing           Storage           Output
───────────         ──────────           ───────           ──────

prompt.md ────────▶ CLI Parser ─────────────────────────▶ Console
                        │
                        ▼
                   Config Loader ───────────────────────▶ Console
                        │
                        ▼
                   Agent Factory
                        │
                        ▼
                   LoopRunner ──────────▶ SessionWriter ─▶ JSONL File
                        │                      │
              ┌─────────┴─────────┐           │
              ▼                   ▼           │
           Actor              Critic ─────────┤
              │                   │           │
              ▼                   ▼           │
          Git Diff ───────────────────────────┤
                                              │
                                              ▼
                                        Session File
</code></pre>
<h2 id="detailed-sequence-running-a-session"><a class="header" href="#detailed-sequence-running-a-session">Detailed Sequence: Running a Session</a></h2>
<h3 id="phase-1-initialization"><a class="header" href="#phase-1-initialization">Phase 1: Initialization</a></h3>
<pre><code>┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   User   │     │   CLI    │     │  Config  │     │ Agents   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ codeloops      │                │                │
     │────────────────▶                │                │
     │                │                │                │
     │                │ load global    │                │
     │                │───────────────▶│                │
     │                │                │                │
     │                │◀───────────────│                │
     │                │                │                │
     │                │ load project   │                │
     │                │───────────────▶│                │
     │                │                │                │
     │                │◀───────────────│                │
     │                │                │                │
     │                │ merge configs  │                │
     │                │───────▶        │                │
     │                │                │                │
     │                │ create agents  │                │
     │                │────────────────────────────────▶│
     │                │                │                │
     │                │◀────────────────────────────────│
     │                │                │                │
</code></pre>
<h3 id="phase-2-session-start"><a class="header" href="#phase-2-session-start">Phase 2: Session Start</a></h3>
<pre><code>┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   CLI    │     │  Runner  │     │  Writer  │     │   File   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ run(context)   │                │                │
     │───────────────▶│                │                │
     │                │                │                │
     │                │ create writer  │                │
     │                │───────────────▶│                │
     │                │                │                │
     │                │                │ create file    │
     │                │                │───────────────▶│
     │                │                │                │
     │                │ write_start()  │                │
     │                │───────────────▶│                │
     │                │                │                │
     │                │                │ append line    │
     │                │                │───────────────▶│
     │                │                │                │
</code></pre>
<h3 id="phase-3-actor-execution"><a class="header" href="#phase-3-actor-execution">Phase 3: Actor Execution</a></h3>
<pre><code>┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Runner  │     │  Actor   │     │ Process  │     │   Git    │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ build prompt   │                │                │
     │───────▶        │                │                │
     │                │                │                │
     │ execute()      │                │                │
     │───────────────▶│                │                │
     │                │                │                │
     │                │ spawn process  │                │
     │                │───────────────▶│                │
     │                │                │                │
     │                │                │ run agent CLI  │
     │                │                │ (claude/opencode)
     │                │                │                │
     │                │◀───────────────│ (stdout/stderr)
     │                │                │                │
     │◀───────────────│ AgentOutput    │                │
     │                │                │                │
     │ capture diff   │                │                │
     │─────────────────────────────────────────────────▶│
     │                │                │                │
     │◀─────────────────────────────────────────────────│
     │                │                │                │
</code></pre>
<h3 id="phase-4-critic-evaluation"><a class="header" href="#phase-4-critic-evaluation">Phase 4: Critic Evaluation</a></h3>
<pre><code>┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Runner  │     │  Critic  │     │  Agent   │     │  Parser  │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ evaluate()     │                │                │
     │───────────────▶│                │                │
     │                │                │                │
     │                │ build prompt   │                │
     │                │───────▶        │                │
     │                │                │                │
     │                │ execute()      │                │
     │                │───────────────▶│                │
     │                │                │                │
     │                │◀───────────────│ AgentOutput    │
     │                │                │                │
     │                │ parse response │                │
     │                │───────────────────────────────▶│
     │                │                │                │
     │                │◀───────────────────────────────│
     │                │                │  CriticDecision│
     │◀───────────────│                │                │
     │                │                │                │
</code></pre>
<h3 id="phase-5-iteration-recording"><a class="header" href="#phase-5-iteration-recording">Phase 5: Iteration Recording</a></h3>
<pre><code>┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Runner  │     │  Writer  │     │   File   │     │  Logger  │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ write_iteration()               │                │
     │───────────────▶│                │                │
     │                │                │                │
     │                │ serialize JSON │                │
     │                │───────▶        │                │
     │                │                │                │
     │                │ append line    │                │
     │                │───────────────▶│                │
     │                │                │                │
     │ log iteration  │                │                │
     │─────────────────────────────────────────────────▶│
     │                │                │                │
     │                │                │                │ console
     │                │                │                │ output
     │                │                │                │
</code></pre>
<h3 id="phase-6-loop-decision"><a class="header" href="#phase-6-loop-decision">Phase 6: Loop Decision</a></h3>
<pre><code>┌──────────┐
│  Runner  │
└────┬─────┘
     │
     │ match decision
     │───────▶
     │
     ├─── DONE ───────────▶ write_end() ─▶ return Success
     │
     ├─── CONTINUE ───────▶ set_feedback() ─▶ loop back
     │
     └─── ERROR ──────────▶ set_feedback() ─▶ loop back
</code></pre>
<h2 id="data-structures-at-each-stage"><a class="header" href="#data-structures-at-each-stage">Data Structures at Each Stage</a></h2>
<h3 id="input-data"><a class="header" href="#input-data">Input Data</a></h3>
<pre><code>prompt: String
working_dir: PathBuf
config: {
    actor_agent: AgentType,
    critic_agent: AgentType,
    actor_model: Option&lt;String&gt;,
    critic_model: Option&lt;String&gt;,
    max_iterations: Option&lt;usize&gt;,
}
</code></pre>
<h3 id="after-actor-execution"><a class="header" href="#after-actor-execution">After Actor Execution</a></h3>
<pre><code>actor_output: {
    stdout: String,
    stderr: String,
    exit_code: i32,
    duration: Duration,
}
</code></pre>
<h3 id="after-diff-capture"><a class="header" href="#after-diff-capture">After Diff Capture</a></h3>
<pre><code>diff_summary: {
    diff: String,
    files_changed: usize,
    insertions: usize,
    deletions: usize,
}
</code></pre>
<h3 id="after-critic-evaluation"><a class="header" href="#after-critic-evaluation">After Critic Evaluation</a></h3>
<pre><code>decision: {
    type: "DONE" | "CONTINUE" | "ERROR",
    summary?: String,       // for DONE
    confidence?: f64,       // for DONE
    feedback?: String,      // for CONTINUE
    recovery?: String,      // for ERROR
}
</code></pre>
<h3 id="session-file-jsonl"><a class="header" href="#session-file-jsonl">Session File (JSONL)</a></h3>
<pre><code>Line 1 (SessionStart):
{
    "type": "session_start",
    "timestamp": "2025-01-27T15:30:45Z",
    "prompt": "...",
    "working_dir": "/path/to/project",
    "actor_agent": "Claude Code",
    "critic_agent": "Claude Code",
    "actor_model": "sonnet",
    "critic_model": null,
    "max_iterations": 10
}

Line 2..N (Iteration):
{
    "type": "iteration",
    "iteration_number": 1,
    "actor_output": "...",
    "actor_stderr": "",
    "actor_exit_code": 0,
    "actor_duration_secs": 45.2,
    "git_diff": "...",
    "git_files_changed": 3,
    "critic_decision": "CONTINUE",
    "feedback": "...",
    "timestamp": "2025-01-27T15:31:30Z"
}

Final Line (SessionEnd):
{
    "type": "session_end",
    "outcome": "success",
    "iterations": 2,
    "summary": "...",
    "confidence": 0.95,
    "duration_secs": 89.4,
    "timestamp": "2025-01-27T15:32:14Z"
}
</code></pre>
<h2 id="api-data-flow"><a class="header" href="#api-data-flow">API Data Flow</a></h2>
<h3 id="list-sessions"><a class="header" href="#list-sessions">List Sessions</a></h3>
<pre><code>Browser                  API                    SessionStore
   │                      │                          │
   │ GET /api/sessions    │                          │
   │─────────────────────▶│                          │
   │                      │                          │
   │                      │ list_sessions(filter)    │
   │                      │─────────────────────────▶│
   │                      │                          │
   │                      │                          │ read first/last
   │                      │                          │ lines of each file
   │                      │                          │
   │                      │◀─────────────────────────│
   │                      │   Vec&lt;SessionSummary&gt;    │
   │                      │                          │
   │◀─────────────────────│                          │
   │   JSON response      │                          │
   │                      │                          │
</code></pre>
<h3 id="get-session-detail"><a class="header" href="#get-session-detail">Get Session Detail</a></h3>
<pre><code>Browser                  API                    SessionStore
   │                      │                          │
   │ GET /api/sessions/id │                          │
   │─────────────────────▶│                          │
   │                      │                          │
   │                      │ load_session(id)         │
   │                      │─────────────────────────▶│
   │                      │                          │
   │                      │                          │ read entire
   │                      │                          │ JSONL file
   │                      │                          │
   │                      │◀─────────────────────────│
   │                      │     Session              │
   │                      │                          │
   │◀─────────────────────│                          │
   │   JSON response      │                          │
   │                      │                          │
</code></pre>
<h3 id="live-updates-sse"><a class="header" href="#live-updates-sse">Live Updates (SSE)</a></h3>
<pre><code>Browser                  API                    SessionWatcher
   │                      │                          │
   │ GET /api/sessions/live (SSE)                    │
   │─────────────────────▶│                          │
   │                      │                          │
   │                      │ subscribe()              │
   │                      │─────────────────────────▶│
   │                      │                          │
   │◀ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│ (connection held open)  │
   │                      │                          │
   │                      │                          │ file change
   │                      │                          │ detected
   │                      │◀ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│
   │                      │    SessionEvent         │
   │                      │                          │
   │◀─────────────────────│                          │
   │   SSE event          │                          │
   │                      │                          │
</code></pre>
<h2 id="file-system-layout"><a class="header" href="#file-system-layout">File System Layout</a></h2>
<pre><code>~/.config/codeloops/
└── config.toml                    # Global configuration

~/.local/share/codeloops/
├── sessions/                      # Session storage
│   ├── 2025-01-27T15-30-45Z_a3f2c1.jsonl
│   ├── 2025-01-27T14-22-10Z_b5d3e2.jsonl
│   └── ...
└── ui/                           # UI assets (optional)
    ├── index.html
    ├── assets/
    └── ...

/path/to/project/
├── codeloops.toml                # Project configuration (optional)
├── prompt.md                     # Default prompt file
└── ...                           # Project files
</code></pre>
<h2 id="concurrency-model"><a class="header" href="#concurrency-model">Concurrency Model</a></h2>
<ul>
<li><strong>Actor execution</strong>: Single-threaded, synchronous process spawn</li>
<li><strong>Critic execution</strong>: Single-threaded, synchronous process spawn</li>
<li><strong>Session writing</strong>: Append-only, no concurrent writers</li>
<li><strong>API server</strong>: Multi-threaded (tokio async runtime)</li>
<li><strong>SSE</strong>: Async broadcast channel for events</li>
</ul>
<p>The loop itself is sequential (actor → diff → critic → decision → repeat), ensuring consistent state and predictable behavior.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="session-format"><a class="header" href="#session-format">Session Format</a></h1>
<p>This document provides a complete reference for the codeloops session file format.</p>
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>Sessions are stored as JSONL (JSON Lines) files. Each line is a valid JSON object representing one event in the session.</p>
<p><strong>Location</strong>: <code>~/.local/share/codeloops/sessions/</code></p>
<p><strong>Filename format</strong>: <code>&lt;timestamp&gt;_&lt;hash&gt;.jsonl</code></p>
<p>Example: <code>2025-01-27T15-30-45Z_a3f2c1.jsonl</code></p>
<ul>
<li><code>timestamp</code>: ISO 8601 format with hyphens replacing colons (filesystem-safe)</li>
<li><code>hash</code>: First 6 characters of SHA256(prompt)</li>
</ul>
<h2 id="line-types"><a class="header" href="#line-types">Line Types</a></h2>
<p>Every line has a <code>type</code> field indicating its kind:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Type</th><th>Occurrence</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>session_start</code></td><td>Exactly once</td><td>First line, session metadata</td></tr>
<tr><td><code>iteration</code></td><td>Zero or more</td><td>One per actor-critic cycle</td></tr>
<tr><td><code>session_end</code></td><td>Zero or once</td><td>Last line, final outcome</td></tr>
</tbody>
</table>
</div>
<h2 id="sessionstart"><a class="header" href="#sessionstart">SessionStart</a></h2>
<p>The first line of every session file.</p>
<h3 id="schema-2"><a class="header" href="#schema-2">Schema</a></h3>
<pre><code class="language-json">{
  "type": "session_start",
  "timestamp": "&lt;ISO 8601 datetime&gt;",
  "prompt": "&lt;string&gt;",
  "working_dir": "&lt;path&gt;",
  "actor_agent": "&lt;string&gt;",
  "critic_agent": "&lt;string&gt;",
  "actor_model": "&lt;string | null&gt;",
  "critic_model": "&lt;string | null&gt;",
  "max_iterations": "&lt;integer | null&gt;"
}
</code></pre>
<h3 id="fields-2"><a class="header" href="#fields-2">Fields</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>type</code></td><td>string</td><td>Yes</td><td>Always <code>"session_start"</code></td></tr>
<tr><td><code>timestamp</code></td><td>string</td><td>Yes</td><td>ISO 8601 datetime when session started</td></tr>
<tr><td><code>prompt</code></td><td>string</td><td>Yes</td><td>Full task prompt text</td></tr>
<tr><td><code>working_dir</code></td><td>string</td><td>Yes</td><td>Absolute path to working directory</td></tr>
<tr><td><code>actor_agent</code></td><td>string</td><td>Yes</td><td>Actor agent name (e.g., “Claude Code”)</td></tr>
<tr><td><code>critic_agent</code></td><td>string</td><td>Yes</td><td>Critic agent name (e.g., “Claude Code”)</td></tr>
<tr><td><code>actor_model</code></td><td>string/null</td><td>Yes</td><td>Actor model name or null if not specified</td></tr>
<tr><td><code>critic_model</code></td><td>string/null</td><td>Yes</td><td>Critic model name or null if not specified</td></tr>
<tr><td><code>max_iterations</code></td><td>integer/null</td><td>Yes</td><td>Iteration limit or null if unlimited</td></tr>
</tbody>
</table>
</div>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<pre><code class="language-json">{
  "type": "session_start",
  "timestamp": "2025-01-27T15:30:45Z",
  "prompt": "Add input validation to the user registration endpoint.\n\nRequirements:\n- Email must be valid format\n- Password must be at least 8 characters",
  "working_dir": "/home/user/projects/myapp",
  "actor_agent": "Claude Code",
  "critic_agent": "Claude Code",
  "actor_model": "sonnet",
  "critic_model": null,
  "max_iterations": 10
}
</code></pre>
<h2 id="iteration"><a class="header" href="#iteration">Iteration</a></h2>
<p>One line per actor-critic cycle. Sessions may have zero iterations (if the actor fails immediately).</p>
<h3 id="schema-1-1"><a class="header" href="#schema-1-1">Schema</a></h3>
<pre><code class="language-json">{
  "type": "iteration",
  "iteration_number": "&lt;integer&gt;",
  "actor_output": "&lt;string&gt;",
  "actor_stderr": "&lt;string&gt;",
  "actor_exit_code": "&lt;integer&gt;",
  "actor_duration_secs": "&lt;float&gt;",
  "git_diff": "&lt;string&gt;",
  "git_files_changed": "&lt;integer&gt;",
  "critic_decision": "&lt;string&gt;",
  "feedback": "&lt;string | null&gt;",
  "timestamp": "&lt;ISO 8601 datetime&gt;"
}
</code></pre>
<h3 id="fields-1-1"><a class="header" href="#fields-1-1">Fields</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>type</code></td><td>string</td><td>Yes</td><td>Always <code>"iteration"</code></td></tr>
<tr><td><code>iteration_number</code></td><td>integer</td><td>Yes</td><td>1-indexed iteration number</td></tr>
<tr><td><code>actor_output</code></td><td>string</td><td>Yes</td><td>Actor’s stdout output</td></tr>
<tr><td><code>actor_stderr</code></td><td>string</td><td>Yes</td><td>Actor’s stderr output</td></tr>
<tr><td><code>actor_exit_code</code></td><td>integer</td><td>Yes</td><td>Actor’s process exit code</td></tr>
<tr><td><code>actor_duration_secs</code></td><td>float</td><td>Yes</td><td>Actor execution time in seconds</td></tr>
<tr><td><code>git_diff</code></td><td>string</td><td>Yes</td><td>Unified diff of changes</td></tr>
<tr><td><code>git_files_changed</code></td><td>integer</td><td>Yes</td><td>Number of files modified</td></tr>
<tr><td><code>critic_decision</code></td><td>string</td><td>Yes</td><td><code>"DONE"</code>, <code>"CONTINUE"</code>, or <code>"ERROR"</code></td></tr>
<tr><td><code>feedback</code></td><td>string/null</td><td>Yes</td><td>Critic feedback (null for DONE)</td></tr>
<tr><td><code>timestamp</code></td><td>string</td><td>Yes</td><td>ISO 8601 datetime when iteration completed</td></tr>
</tbody>
</table>
</div>
<h3 id="critic-decision-values"><a class="header" href="#critic-decision-values">Critic Decision Values</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Value</th><th>Meaning</th></tr>
</thead>
<tbody>
<tr><td><code>DONE</code></td><td>Task complete, no more iterations</td></tr>
<tr><td><code>CONTINUE</code></td><td>More work needed, feedback provided</td></tr>
<tr><td><code>ERROR</code></td><td>Error occurred, recovery suggestion provided</td></tr>
</tbody>
</table>
</div>
<h3 id="example-continue"><a class="header" href="#example-continue">Example (CONTINUE)</a></h3>
<pre><code class="language-json">{
  "type": "iteration",
  "iteration_number": 1,
  "actor_output": "I've added email validation using a regex pattern. The validation is now in place for the registration endpoint.",
  "actor_stderr": "",
  "actor_exit_code": 0,
  "actor_duration_secs": 45.2,
  "git_diff": "diff --git a/src/api/users.rs b/src/api/users.rs\nindex 1234567..abcdefg 100644\n--- a/src/api/users.rs\n+++ b/src/api/users.rs\n@@ -10,6 +10,12 @@ pub async fn register(data: Json&lt;RegisterRequest&gt;) {\n+    if !is_valid_email(&amp;data.email) {\n+        return Err(ApiError::BadRequest(\"Invalid email format\"));\n+    }\n",
  "git_files_changed": 1,
  "critic_decision": "CONTINUE",
  "feedback": "Email validation is implemented correctly. However, password validation is missing. Please add:\n1. Minimum 8 character length check\n2. Error message for invalid passwords",
  "timestamp": "2025-01-27T15:31:30Z"
}
</code></pre>
<h3 id="example-done"><a class="header" href="#example-done">Example (DONE)</a></h3>
<pre><code class="language-json">{
  "type": "iteration",
  "iteration_number": 2,
  "actor_output": "I've added password validation with minimum length check. Both email and password are now validated.",
  "actor_stderr": "",
  "actor_exit_code": 0,
  "actor_duration_secs": 32.1,
  "git_diff": "diff --git a/src/api/users.rs b/src/api/users.rs\n...",
  "git_files_changed": 1,
  "critic_decision": "DONE",
  "feedback": null,
  "timestamp": "2025-01-27T15:32:02Z"
}
</code></pre>
<h3 id="example-error"><a class="header" href="#example-error">Example (ERROR)</a></h3>
<pre><code class="language-json">{
  "type": "iteration",
  "iteration_number": 1,
  "actor_output": "",
  "actor_stderr": "error[E0433]: failed to resolve: use of undeclared crate or module `validator`",
  "actor_exit_code": 101,
  "actor_duration_secs": 12.5,
  "git_diff": "",
  "git_files_changed": 0,
  "critic_decision": "ERROR",
  "feedback": "The actor encountered a compilation error. The `validator` crate is not in Cargo.toml. Please either:\n1. Add `validator = \"0.16\"` to Cargo.toml, or\n2. Implement validation manually without the external crate",
  "timestamp": "2025-01-27T15:31:00Z"
}
</code></pre>
<h2 id="sessionend"><a class="header" href="#sessionend">SessionEnd</a></h2>
<p>The last line of a completed session. May be absent if the session is still in progress or crashed.</p>
<h3 id="schema-2-1"><a class="header" href="#schema-2-1">Schema</a></h3>
<pre><code class="language-json">{
  "type": "session_end",
  "outcome": "&lt;string&gt;",
  "iterations": "&lt;integer&gt;",
  "summary": "&lt;string | null&gt;",
  "confidence": "&lt;float | null&gt;",
  "duration_secs": "&lt;float&gt;",
  "timestamp": "&lt;ISO 8601 datetime&gt;"
}
</code></pre>
<h3 id="fields-2-1"><a class="header" href="#fields-2-1">Fields</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Type</th><th>Required</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>type</code></td><td>string</td><td>Yes</td><td>Always <code>"session_end"</code></td></tr>
<tr><td><code>outcome</code></td><td>string</td><td>Yes</td><td>Session outcome (see values below)</td></tr>
<tr><td><code>iterations</code></td><td>integer</td><td>Yes</td><td>Total number of iterations completed</td></tr>
<tr><td><code>summary</code></td><td>string/null</td><td>Yes</td><td>Task completion summary (for success)</td></tr>
<tr><td><code>confidence</code></td><td>float/null</td><td>Yes</td><td>Confidence score 0.0-1.0 (for success)</td></tr>
<tr><td><code>duration_secs</code></td><td>float</td><td>Yes</td><td>Total session duration in seconds</td></tr>
<tr><td><code>timestamp</code></td><td>string</td><td>Yes</td><td>ISO 8601 datetime when session ended</td></tr>
</tbody>
</table>
</div>
<h3 id="outcome-values"><a class="header" href="#outcome-values">Outcome Values</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Value</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>success</code></td><td>Critic returned DONE, task complete</td></tr>
<tr><td><code>failed</code></td><td>Unrecoverable error occurred</td></tr>
<tr><td><code>interrupted</code></td><td>User pressed Ctrl+C</td></tr>
<tr><td><code>max_iterations_reached</code></td><td>Hit iteration limit without completion</td></tr>
</tbody>
</table>
</div>
<h3 id="example-success"><a class="header" href="#example-success">Example (success)</a></h3>
<pre><code class="language-json">{
  "type": "session_end",
  "outcome": "success",
  "iterations": 2,
  "summary": "Input validation has been added to the user registration endpoint. Email addresses are validated using RFC 5321 compliant regex. Passwords require minimum 8 characters. Appropriate error messages are returned for invalid inputs.",
  "confidence": 0.95,
  "duration_secs": 89.4,
  "timestamp": "2025-01-27T15:32:14Z"
}
</code></pre>
<h3 id="example-max_iterations_reached"><a class="header" href="#example-max_iterations_reached">Example (max_iterations_reached)</a></h3>
<pre><code class="language-json">{
  "type": "session_end",
  "outcome": "max_iterations_reached",
  "iterations": 10,
  "summary": null,
  "confidence": null,
  "duration_secs": 482.3,
  "timestamp": "2025-01-27T15:38:45Z"
}
</code></pre>
<h2 id="complete-example"><a class="header" href="#complete-example">Complete Example</a></h2>
<p>A full session file:</p>
<pre><code class="language-json">{"type":"session_start","timestamp":"2025-01-27T15:30:45Z","prompt":"Fix the typo in greeting.rs","working_dir":"/home/user/myapp","actor_agent":"Claude Code","critic_agent":"Claude Code","actor_model":null,"critic_model":null,"max_iterations":null}
{"type":"iteration","iteration_number":1,"actor_output":"I found and fixed the typo. 'Helo' is now 'Hello'.","actor_stderr":"","actor_exit_code":0,"actor_duration_secs":23.4,"git_diff":"diff --git a/src/greeting.rs b/src/greeting.rs\n--- a/src/greeting.rs\n+++ b/src/greeting.rs\n@@ -1 +1 @@\n-println!(\"Helo, World!\");\n+println!(\"Hello, World!\");","git_files_changed":1,"critic_decision":"DONE","feedback":null,"timestamp":"2025-01-27T15:31:08Z"}
{"type":"session_end","outcome":"success","iterations":1,"summary":"Fixed the typo in greeting.rs. Changed 'Helo' to 'Hello'.","confidence":1.0,"duration_secs":23.4,"timestamp":"2025-01-27T15:31:08Z"}
</code></pre>
<h2 id="parsing-sessions"><a class="header" href="#parsing-sessions">Parsing Sessions</a></h2>
<h3 id="using-jq-1"><a class="header" href="#using-jq-1">Using jq</a></h3>
<pre><code class="language-bash"># Get session prompt
head -1 session.jsonl | jq -r '.prompt'

# Get all critic decisions
jq -r 'select(.type == "iteration") | .critic_decision' session.jsonl

# Get final outcome
tail -1 session.jsonl | jq -r '.outcome'

# Count iterations
jq -s '[.[] | select(.type == "iteration")] | length' session.jsonl
</code></pre>
<h3 id="using-python-1"><a class="header" href="#using-python-1">Using Python</a></h3>
<pre><code class="language-python">import json

def parse_session(filepath):
    with open(filepath) as f:
        lines = [json.loads(line) for line in f]

    start = lines[0]
    iterations = [l for l in lines if l.get("type") == "iteration"]
    end = lines[-1] if lines[-1].get("type") == "session_end" else None

    return {
        "start": start,
        "iterations": iterations,
        "end": end,
    }
</code></pre>
<h3 id="using-rust-1"><a class="header" href="#using-rust-1">Using Rust</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use codeloops_sessions::{SessionStore, Session};

let store = SessionStore::new()?;
let session: Session = store.load_session("2025-01-27T15-30-45Z_a3f2c1")?;

println!("Prompt: {}", session.start.prompt);
println!("Iterations: {}", session.iterations.len());
if let Some(end) = session.end {
    println!("Outcome: {}", end.outcome);
}
<span class="boring">}</span></code></pre>
<h2 id="session-discovery"><a class="header" href="#session-discovery">Session Discovery</a></h2>
<p>Sessions are stored in a flat directory. To discover sessions:</p>
<pre><code class="language-bash"># List all session files
ls ~/.local/share/codeloops/sessions/*.jsonl

# Find sessions by date
ls ~/.local/share/codeloops/sessions/2025-01-27*.jsonl

# Find sessions by prompt hash
ls ~/.local/share/codeloops/sessions/*_a3f2c1.jsonl
</code></pre>
<h2 id="file-integrity"><a class="header" href="#file-integrity">File Integrity</a></h2>
<p>Sessions are written in append-only mode:</p>
<ul>
<li>Lines are written atomically (full line or nothing)</li>
<li>No line is ever modified after writing</li>
<li>Crashes leave the file in a consistent state</li>
</ul>
<p>If a session file is missing <code>session_end</code>, the session was either:</p>
<ul>
<li>Interrupted before completion</li>
<li>Crashed unexpectedly</li>
<li>Still in progress</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="configuration-schema"><a class="header" href="#configuration-schema">Configuration Schema</a></h1>
<p>This document provides a complete reference for all configuration options.</p>
<h2 id="configuration-files"><a class="header" href="#configuration-files">Configuration Files</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>File</th><th>Location</th><th>Scope</th></tr>
</thead>
<tbody>
<tr><td>Global</td><td><code>~/.config/codeloops/config.toml</code></td><td>All projects</td></tr>
<tr><td>Project</td><td><code>&lt;working-dir&gt;/codeloops.toml</code></td><td>Single project</td></tr>
</tbody>
</table>
</div>
<h2 id="precedence"><a class="header" href="#precedence">Precedence</a></h2>
<p>Settings are resolved in order (highest priority first):</p>
<ol>
<li>CLI flags</li>
<li>Project configuration</li>
<li>Global configuration</li>
<li>Built-in defaults</li>
</ol>
<h2 id="global-configuration-1"><a class="header" href="#global-configuration-1">Global Configuration</a></h2>
<p><strong>File</strong>: <code>~/.config/codeloops/config.toml</code></p>
<h3 id="complete-schema"><a class="header" href="#complete-schema">Complete Schema</a></h3>
<pre><code class="language-toml"># Default settings applied to all sessions
[defaults]
# Default agent for both actor and critic roles
# Values: "claude", "opencode", "cursor"
# Default: "claude"
agent = "claude"

# Default model for both roles (optional)
# Value depends on agent (e.g., "sonnet", "opus", "gpt-4o")
# Default: none (uses agent default)
model = "sonnet"

# Actor-specific overrides (optional section)
[defaults.actor]
# Agent for actor role (overrides defaults.agent for actor)
agent = "opencode"

# Model for actor role (overrides defaults.model for actor)
model = "gpt-4o"

# Critic-specific overrides (optional section)
[defaults.critic]
# Agent for critic role (overrides defaults.agent for critic)
agent = "claude"

# Model for critic role (overrides defaults.model for critic)
model = "opus"
</code></pre>
<h3 id="section-reference"><a class="header" href="#section-reference">Section Reference</a></h3>
<h4 id="defaults"><a class="header" href="#defaults"><code>[defaults]</code></a></h4>
<p>Base defaults for all sessions.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>agent</code></td><td>string</td><td><code>"claude"</code></td><td>Default agent for both roles</td></tr>
<tr><td><code>model</code></td><td>string</td><td>none</td><td>Default model for both roles</td></tr>
</tbody>
</table>
</div>
<h4 id="defaultsactor"><a class="header" href="#defaultsactor"><code>[defaults.actor]</code></a></h4>
<p>Override defaults for the actor role.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>agent</code></td><td>string</td><td>inherit</td><td>Agent for actor</td></tr>
<tr><td><code>model</code></td><td>string</td><td>inherit</td><td>Model for actor</td></tr>
</tbody>
</table>
</div>
<h4 id="defaultscritic"><a class="header" href="#defaultscritic"><code>[defaults.critic]</code></a></h4>
<p>Override defaults for the critic role.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>agent</code></td><td>string</td><td>inherit</td><td>Agent for critic</td></tr>
<tr><td><code>model</code></td><td>string</td><td>inherit</td><td>Model for critic</td></tr>
</tbody>
</table>
</div>
<h3 id="example-configurations-2"><a class="header" href="#example-configurations-2">Example Configurations</a></h3>
<p><strong>Minimal (use defaults):</strong></p>
<pre><code class="language-toml">[defaults]
agent = "claude"
</code></pre>
<p><strong>With model:</strong></p>
<pre><code class="language-toml">[defaults]
agent = "claude"
model = "sonnet"
</code></pre>
<p><strong>Different agents per role:</strong></p>
<pre><code class="language-toml">[defaults]
agent = "claude"

[defaults.actor]
agent = "opencode"
model = "gpt-4o"

[defaults.critic]
model = "opus"
</code></pre>
<h2 id="project-configuration-1"><a class="header" href="#project-configuration-1">Project Configuration</a></h2>
<p><strong>File</strong>: <code>&lt;working-dir&gt;/codeloops.toml</code></p>
<h3 id="complete-schema-1"><a class="header" href="#complete-schema-1">Complete Schema</a></h3>
<pre><code class="language-toml"># Default agent for this project
# Values: "claude", "opencode", "cursor"
agent = "claude"

# Default model for this project (optional)
model = "sonnet"

# Actor-specific settings (optional section)
[actor]
agent = "opencode"
model = "gpt-4o"

# Critic-specific settings (optional section)
[critic]
agent = "claude"
model = "opus"
</code></pre>
<h3 id="field-reference"><a class="header" href="#field-reference">Field Reference</a></h3>
<h4 id="root-level"><a class="header" href="#root-level">Root Level</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>agent</code></td><td>string</td><td>inherit</td><td>Default agent for this project</td></tr>
<tr><td><code>model</code></td><td>string</td><td>inherit</td><td>Default model for this project</td></tr>
</tbody>
</table>
</div>
<h4 id="actor"><a class="header" href="#actor"><code>[actor]</code></a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>agent</code></td><td>string</td><td>inherit</td><td>Agent for actor</td></tr>
<tr><td><code>model</code></td><td>string</td><td>inherit</td><td>Model for actor</td></tr>
</tbody>
</table>
</div>
<h4 id="critic"><a class="header" href="#critic"><code>[critic]</code></a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>agent</code></td><td>string</td><td>inherit</td><td>Agent for critic</td></tr>
<tr><td><code>model</code></td><td>string</td><td>inherit</td><td>Model for critic</td></tr>
</tbody>
</table>
</div>
<h3 id="example-configurations-1-1"><a class="header" href="#example-configurations-1-1">Example Configurations</a></h3>
<p><strong>Simple project config:</strong></p>
<pre><code class="language-toml">agent = "claude"
</code></pre>
<p><strong>Mixed agents:</strong></p>
<pre><code class="language-toml">[actor]
agent = "opencode"
model = "gpt-4o-mini"

[critic]
agent = "claude"
model = "sonnet"
</code></pre>
<h2 id="valid-values"><a class="header" href="#valid-values">Valid Values</a></h2>
<h3 id="agent-values"><a class="header" href="#agent-values">Agent Values</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Value</th><th>Agent</th></tr>
</thead>
<tbody>
<tr><td><code>"claude"</code></td><td>Claude Code</td></tr>
<tr><td><code>"opencode"</code></td><td>OpenCode</td></tr>
<tr><td><code>"cursor"</code></td><td>Cursor</td></tr>
</tbody>
</table>
</div>
<h3 id="model-values"><a class="header" href="#model-values">Model Values</a></h3>
<p>Model values depend on the agent:</p>
<p><strong>Claude Code:</strong></p>
<ul>
<li><code>"sonnet"</code> - Claude Sonnet</li>
<li><code>"opus"</code> - Claude Opus</li>
<li><code>"haiku"</code> - Claude Haiku</li>
</ul>
<p><strong>OpenCode:</strong></p>
<ul>
<li><code>"gpt-4o"</code> - GPT-4o</li>
<li><code>"gpt-4o-mini"</code> - GPT-4o Mini</li>
<li>Other OpenAI models</li>
</ul>
<p><strong>Cursor:</strong></p>
<ul>
<li>Uses Cursor’s configured model</li>
</ul>
<h2 id="resolution-examples-1"><a class="header" href="#resolution-examples-1">Resolution Examples</a></h2>
<h3 id="example-1-no-config-files"><a class="header" href="#example-1-no-config-files">Example 1: No config files</a></h3>
<p>Running <code>codeloops</code> with no config:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Setting</th><th>Value</th><th>Source</th></tr>
</thead>
<tbody>
<tr><td>Actor agent</td><td>claude</td><td>default</td></tr>
<tr><td>Critic agent</td><td>claude</td><td>default</td></tr>
<tr><td>Actor model</td><td>(none)</td><td>default</td></tr>
<tr><td>Critic model</td><td>(none)</td><td>default</td></tr>
</tbody>
</table>
</div>
<h3 id="example-2-global-config-only-1"><a class="header" href="#example-2-global-config-only-1">Example 2: Global config only</a></h3>
<p><code>~/.config/codeloops/config.toml</code>:</p>
<pre><code class="language-toml">[defaults]
agent = "opencode"
model = "gpt-4o"
</code></pre>
<p>Running <code>codeloops</code>:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Setting</th><th>Value</th><th>Source</th></tr>
</thead>
<tbody>
<tr><td>Actor agent</td><td>opencode</td><td>global</td></tr>
<tr><td>Critic agent</td><td>opencode</td><td>global</td></tr>
<tr><td>Actor model</td><td>gpt-4o</td><td>global</td></tr>
<tr><td>Critic model</td><td>gpt-4o</td><td>global</td></tr>
</tbody>
</table>
</div>
<h3 id="example-3-global--project-config-1"><a class="header" href="#example-3-global--project-config-1">Example 3: Global + Project config</a></h3>
<p><code>~/.config/codeloops/config.toml</code>:</p>
<pre><code class="language-toml">[defaults]
agent = "opencode"
</code></pre>
<p><code>codeloops.toml</code>:</p>
<pre><code class="language-toml">agent = "claude"
</code></pre>
<p>Running <code>codeloops</code>:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Setting</th><th>Value</th><th>Source</th></tr>
</thead>
<tbody>
<tr><td>Actor agent</td><td>claude</td><td>project</td></tr>
<tr><td>Critic agent</td><td>claude</td><td>project</td></tr>
</tbody>
</table>
</div>
<h3 id="example-4-cli-overrides-all"><a class="header" href="#example-4-cli-overrides-all">Example 4: CLI overrides all</a></h3>
<p><code>~/.config/codeloops/config.toml</code>:</p>
<pre><code class="language-toml">[defaults]
agent = "opencode"
</code></pre>
<p><code>codeloops.toml</code>:</p>
<pre><code class="language-toml">agent = "claude"
</code></pre>
<p>Running <code>codeloops --agent cursor</code>:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Setting</th><th>Value</th><th>Source</th></tr>
</thead>
<tbody>
<tr><td>Actor agent</td><td>cursor</td><td>CLI</td></tr>
<tr><td>Critic agent</td><td>cursor</td><td>CLI</td></tr>
</tbody>
</table>
</div>
<h3 id="example-5-per-role-settings"><a class="header" href="#example-5-per-role-settings">Example 5: Per-role settings</a></h3>
<p><code>~/.config/codeloops/config.toml</code>:</p>
<pre><code class="language-toml">[defaults]
agent = "claude"
model = "sonnet"

[defaults.actor]
agent = "opencode"
model = "gpt-4o"
</code></pre>
<p>Running <code>codeloops</code>:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Setting</th><th>Value</th><th>Source</th></tr>
</thead>
<tbody>
<tr><td>Actor agent</td><td>opencode</td><td>global.actor</td></tr>
<tr><td>Critic agent</td><td>claude</td><td>global.defaults</td></tr>
<tr><td>Actor model</td><td>gpt-4o</td><td>global.actor</td></tr>
<tr><td>Critic model</td><td>sonnet</td><td>global.defaults</td></tr>
</tbody>
</table>
</div>
<h2 id="environment-variables-1"><a class="header" href="#environment-variables-1">Environment Variables</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Variable</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>CODELOOPS_UI_DIR</code></td><td>Override UI assets directory</td></tr>
<tr><td><code>NO_COLOR</code></td><td>Disable colored output when set</td></tr>
</tbody>
</table>
</div>
<h2 id="creating-configuration-1"><a class="header" href="#creating-configuration-1">Creating Configuration</a></h2>
<h3 id="using-init-1"><a class="header" href="#using-init-1">Using init</a></h3>
<pre><code class="language-bash">codeloops init
</code></pre>
<p>Interactive prompts create <code>~/.config/codeloops/config.toml</code>.</p>
<h3 id="manual-creation-1"><a class="header" href="#manual-creation-1">Manual creation</a></h3>
<pre><code class="language-bash">mkdir -p ~/.config/codeloops
cat &gt; ~/.config/codeloops/config.toml &lt;&lt; 'EOF'
[defaults]
agent = "claude"
EOF
</code></pre>
<h2 id="validating-configuration-1"><a class="header" href="#validating-configuration-1">Validating Configuration</a></h2>
<p>Use <code>--dry-run</code> to see resolved configuration:</p>
<pre><code class="language-bash">codeloops --dry-run
</code></pre>
<p>Output shows the effective settings without executing.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="api-server-reference"><a class="header" href="#api-server-reference">API Server Reference</a></h1>
<p>This document provides a complete reference for the codeloops REST API.</p>
<h2 id="overview-3"><a class="header" href="#overview-3">Overview</a></h2>
<p>The API server provides HTTP endpoints for accessing session data. It’s started with <code>codeloops ui</code> and runs alongside the web UI.</p>
<p><strong>Base URL</strong>: <code>http://localhost:3100</code> (default)</p>
<p><strong>Content-Type</strong>: <code>application/json</code> (unless noted)</p>
<h2 id="starting-the-server"><a class="header" href="#starting-the-server">Starting the Server</a></h2>
<pre><code class="language-bash"># Start with defaults
codeloops ui

# Custom API port
codeloops ui --api-port 4000

# Development mode
codeloops ui --dev
</code></pre>
<h2 id="endpoints"><a class="header" href="#endpoints">Endpoints</a></h2>
<h3 id="list-sessions-1"><a class="header" href="#list-sessions-1">List Sessions</a></h3>
<p>List all sessions with optional filtering.</p>
<p><strong>Request</strong></p>
<pre><code>GET /api/sessions
</code></pre>
<p><strong>Query Parameters</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Parameter</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>outcome</code></td><td>string</td><td>Filter by outcome: <code>success</code>, <code>failed</code>, <code>interrupted</code>, <code>max_iterations_reached</code></td></tr>
<tr><td><code>after</code></td><td>string</td><td>Sessions after date (YYYY-MM-DD)</td></tr>
<tr><td><code>before</code></td><td>string</td><td>Sessions before date (YYYY-MM-DD)</td></tr>
<tr><td><code>search</code></td><td>string</td><td>Search in prompt text</td></tr>
<tr><td><code>project</code></td><td>string</td><td>Filter by project name</td></tr>
</tbody>
</table>
</div>
<p><strong>Response</strong></p>
<pre><code class="language-json">[
  {
    "id": "2025-01-27T15-30-45Z_a3f2c1",
    "timestamp": "2025-01-27T15:30:45Z",
    "prompt_preview": "Add input validation to the user registration...",
    "working_dir": "/home/user/projects/myapp",
    "project": "myapp",
    "outcome": "success",
    "iterations": 2,
    "duration_secs": 89.4,
    "confidence": 0.95,
    "actor_agent": "Claude Code",
    "critic_agent": "Claude Code"
  }
]
</code></pre>
<p><strong>Response Fields</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>id</code></td><td>string</td><td>Session identifier</td></tr>
<tr><td><code>timestamp</code></td><td>string</td><td>ISO 8601 start time</td></tr>
<tr><td><code>prompt_preview</code></td><td>string</td><td>First 256 chars of prompt</td></tr>
<tr><td><code>working_dir</code></td><td>string</td><td>Absolute path</td></tr>
<tr><td><code>project</code></td><td>string</td><td>Basename of working_dir</td></tr>
<tr><td><code>outcome</code></td><td>string/null</td><td>Outcome or null if active</td></tr>
<tr><td><code>iterations</code></td><td>integer</td><td>Number of iterations</td></tr>
<tr><td><code>duration_secs</code></td><td>float/null</td><td>Total duration or null if active</td></tr>
<tr><td><code>confidence</code></td><td>float/null</td><td>Confidence score (0-1)</td></tr>
<tr><td><code>actor_agent</code></td><td>string</td><td>Actor agent name</td></tr>
<tr><td><code>critic_agent</code></td><td>string</td><td>Critic agent name</td></tr>
</tbody>
</table>
</div>
<p><strong>Example</strong></p>
<pre><code class="language-bash"># List all sessions
curl http://localhost:3100/api/sessions

# Filter by outcome
curl "http://localhost:3100/api/sessions?outcome=success"

# Filter by date range
curl "http://localhost:3100/api/sessions?after=2025-01-01&amp;before=2025-01-31"

# Search prompts
curl "http://localhost:3100/api/sessions?search=authentication"

# Combine filters
curl "http://localhost:3100/api/sessions?outcome=success&amp;project=myapp"
</code></pre>
<h3 id="get-session"><a class="header" href="#get-session">Get Session</a></h3>
<p>Get detailed information for a single session.</p>
<p><strong>Request</strong></p>
<pre><code>GET /api/sessions/{id}
</code></pre>
<p><strong>Path Parameters</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Parameter</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>id</code></td><td>string</td><td>Session identifier</td></tr>
</tbody>
</table>
</div>
<p><strong>Response</strong></p>
<pre><code class="language-json">{
  "id": "2025-01-27T15-30-45Z_a3f2c1",
  "start": {
    "timestamp": "2025-01-27T15:30:45Z",
    "prompt": "Add input validation to the user registration endpoint...",
    "working_dir": "/home/user/projects/myapp",
    "actor_agent": "Claude Code",
    "critic_agent": "Claude Code",
    "actor_model": "sonnet",
    "critic_model": null,
    "max_iterations": 10
  },
  "iterations": [
    {
      "iteration_number": 1,
      "actor_output": "I've added email validation...",
      "actor_stderr": "",
      "actor_exit_code": 0,
      "actor_duration_secs": 45.2,
      "git_diff": "diff --git a/src/api/users.rs...",
      "git_files_changed": 1,
      "critic_decision": "CONTINUE",
      "feedback": "Email validation looks good, but...",
      "timestamp": "2025-01-27T15:31:30Z"
    },
    {
      "iteration_number": 2,
      "actor_output": "I've added password validation...",
      "actor_stderr": "",
      "actor_exit_code": 0,
      "actor_duration_secs": 32.1,
      "git_diff": "diff --git a/src/api/users.rs...",
      "git_files_changed": 1,
      "critic_decision": "DONE",
      "feedback": null,
      "timestamp": "2025-01-27T15:32:02Z"
    }
  ],
  "end": {
    "outcome": "success",
    "iterations": 2,
    "summary": "Input validation has been added...",
    "confidence": 0.95,
    "duration_secs": 89.4,
    "timestamp": "2025-01-27T15:32:14Z"
  }
}
</code></pre>
<p><strong>Example</strong></p>
<pre><code class="language-bash">curl http://localhost:3100/api/sessions/2025-01-27T15-30-45Z_a3f2c1
</code></pre>
<h3 id="get-session-diff"><a class="header" href="#get-session-diff">Get Session Diff</a></h3>
<p>Get the cumulative git diff for a session.</p>
<p><strong>Request</strong></p>
<pre><code>GET /api/sessions/{id}/diff
</code></pre>
<p><strong>Path Parameters</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Parameter</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>id</code></td><td>string</td><td>Session identifier</td></tr>
</tbody>
</table>
</div>
<p><strong>Response</strong></p>
<p>Content-Type: <code>text/plain</code></p>
<pre><code class="language-diff">diff --git a/src/api/users.rs b/src/api/users.rs
index 1234567..abcdefg 100644
--- a/src/api/users.rs
+++ b/src/api/users.rs
@@ -10,6 +10,18 @@ pub async fn register(data: Json&lt;RegisterRequest&gt;) {
+    // Validate email
+    if !is_valid_email(&amp;data.email) {
+        return Err(ApiError::BadRequest("Invalid email format"));
+    }
+
+    // Validate password
+    if data.password.len() &lt; 8 {
+        return Err(ApiError::BadRequest("Password must be at least 8 characters"));
+    }
</code></pre>
<p><strong>Example</strong></p>
<pre><code class="language-bash">curl http://localhost:3100/api/sessions/2025-01-27T15-30-45Z_a3f2c1/diff
</code></pre>
<h3 id="get-statistics"><a class="header" href="#get-statistics">Get Statistics</a></h3>
<p>Get aggregate statistics across all sessions.</p>
<p><strong>Request</strong></p>
<pre><code>GET /api/stats
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">{
  "total_sessions": 47,
  "success_rate": 0.787,
  "avg_iterations": 2.3,
  "avg_duration_secs": 94.2,
  "sessions_over_time": [
    { "date": "2025-01-27", "count": 5 },
    { "date": "2025-01-26", "count": 8 },
    { "date": "2025-01-25", "count": 12 }
  ],
  "by_project": [
    {
      "project": "myapp",
      "total": 23,
      "success_rate": 0.826
    },
    {
      "project": "api-svc",
      "total": 15,
      "success_rate": 0.733
    }
  ]
}
</code></pre>
<p><strong>Response Fields</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>total_sessions</code></td><td>integer</td><td>Total number of sessions</td></tr>
<tr><td><code>success_rate</code></td><td>float</td><td>Success rate (0.0-1.0)</td></tr>
<tr><td><code>avg_iterations</code></td><td>float</td><td>Average iterations per session</td></tr>
<tr><td><code>avg_duration_secs</code></td><td>float</td><td>Average session duration</td></tr>
<tr><td><code>sessions_over_time</code></td><td>array</td><td>Sessions grouped by date</td></tr>
<tr><td><code>by_project</code></td><td>array</td><td>Statistics per project</td></tr>
</tbody>
</table>
</div>
<p><strong>Example</strong></p>
<pre><code class="language-bash">curl http://localhost:3100/api/stats
</code></pre>
<h3 id="live-session-events-sse"><a class="header" href="#live-session-events-sse">Live Session Events (SSE)</a></h3>
<p>Stream real-time session events using Server-Sent Events.</p>
<p><strong>Request</strong></p>
<pre><code>GET /api/sessions/live
</code></pre>
<p><strong>Response</strong></p>
<p>Content-Type: <code>text/event-stream</code></p>
<p>Events are sent as they occur:</p>
<pre><code>event: session_created
data: {"id":"2025-01-27T16-00-00Z_b5d3e2","timestamp":"2025-01-27T16:00:00Z","prompt_preview":"Fix the bug...","actor_agent":"Claude Code","critic_agent":"Claude Code"}

event: session_updated
data: {"id":"2025-01-27T16-00-00Z_b5d3e2","iteration":1,"critic_decision":"CONTINUE"}

event: session_completed
data: {"id":"2025-01-27T16-00-00Z_b5d3e2","outcome":"success","iterations":2}
</code></pre>
<p><strong>Event Types</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Event</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>session_created</code></td><td>New session started</td></tr>
<tr><td><code>session_updated</code></td><td>Iteration completed</td></tr>
<tr><td><code>session_completed</code></td><td>Session finished</td></tr>
</tbody>
</table>
</div>
<p><strong>Example (JavaScript)</strong></p>
<pre><code class="language-javascript">const eventSource = new EventSource('http://localhost:3100/api/sessions/live');

eventSource.addEventListener('session_created', (e) =&gt; {
  const data = JSON.parse(e.data);
  console.log('New session:', data.id);
});

eventSource.addEventListener('session_updated', (e) =&gt; {
  const data = JSON.parse(e.data);
  console.log('Session updated:', data.id, 'iteration:', data.iteration);
});

eventSource.addEventListener('session_completed', (e) =&gt; {
  const data = JSON.parse(e.data);
  console.log('Session completed:', data.id, 'outcome:', data.outcome);
});
</code></pre>
<p><strong>Example (curl)</strong></p>
<pre><code class="language-bash">curl -N http://localhost:3100/api/sessions/live
</code></pre>
<h2 id="error-responses"><a class="header" href="#error-responses">Error Responses</a></h2>
<h3 id="404-not-found"><a class="header" href="#404-not-found">404 Not Found</a></h3>
<pre><code class="language-json">{
  "error": "Session not found",
  "id": "invalid-session-id"
}
</code></pre>
<h3 id="400-bad-request"><a class="header" href="#400-bad-request">400 Bad Request</a></h3>
<pre><code class="language-json">{
  "error": "Invalid filter parameter",
  "details": "Invalid date format for 'after' parameter"
}
</code></pre>
<h3 id="500-internal-server-error"><a class="header" href="#500-internal-server-error">500 Internal Server Error</a></h3>
<pre><code class="language-json">{
  "error": "Internal server error",
  "details": "Failed to read session file"
}
</code></pre>
<h2 id="cors"><a class="header" href="#cors">CORS</a></h2>
<p>The API server allows cross-origin requests from localhost origins by default, enabling the separate UI dev server to make requests.</p>
<p>Headers included:</p>
<ul>
<li><code>Access-Control-Allow-Origin: *</code> (in dev mode)</li>
<li><code>Access-Control-Allow-Methods: GET, OPTIONS</code></li>
<li><code>Access-Control-Allow-Headers: Content-Type</code></li>
</ul>
<h2 id="health-check"><a class="header" href="#health-check">Health Check</a></h2>
<p>Check if the API server is running:</p>
<pre><code class="language-bash">curl http://localhost:3100/api/sessions
</code></pre>
<p>A successful response (even an empty array <code>[]</code>) indicates the server is healthy.</p>
<h2 id="rate-limiting"><a class="header" href="#rate-limiting">Rate Limiting</a></h2>
<p>There is no built-in rate limiting. The API is designed for local use only.</p>
<h2 id="authentication"><a class="header" href="#authentication">Authentication</a></h2>
<p>There is no authentication. The API is intended for local development use.</p>
<h2 id="programmatic-usage"><a class="header" href="#programmatic-usage">Programmatic Usage</a></h2>
<h3 id="python"><a class="header" href="#python">Python</a></h3>
<pre><code class="language-python">import requests

BASE_URL = "http://localhost:3100"

# List sessions
sessions = requests.get(f"{BASE_URL}/api/sessions").json()

# Get session detail
session = requests.get(f"{BASE_URL}/api/sessions/{sessions[0]['id']}").json()

# Get statistics
stats = requests.get(f"{BASE_URL}/api/stats").json()
</code></pre>
<h3 id="javascripttypescript"><a class="header" href="#javascripttypescript">JavaScript/TypeScript</a></h3>
<pre><code class="language-typescript">const BASE_URL = "http://localhost:3100";

// List sessions
const sessions = await fetch(`${BASE_URL}/api/sessions`).then(r =&gt; r.json());

// Get session detail
const session = await fetch(`${BASE_URL}/api/sessions/${sessions[0].id}`).then(r =&gt; r.json());

// Get statistics
const stats = await fetch(`${BASE_URL}/api/stats`).then(r =&gt; r.json());
</code></pre>
<h3 id="curl"><a class="header" href="#curl">curl</a></h3>
<pre><code class="language-bash"># List sessions with jq formatting
curl -s http://localhost:3100/api/sessions | jq

# Get specific session
curl -s http://localhost:3100/api/sessions/2025-01-27T15-30-45Z_a3f2c1 | jq

# Get diff
curl http://localhost:3100/api/sessions/2025-01-27T15-30-45Z_a3f2c1/diff
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="development-setup-1"><a class="header" href="#development-setup-1">Development Setup</a></h1>
<p>This guide covers how to set up a development environment for contributing to codeloops.</p>
<h2 id="prerequisites-2"><a class="header" href="#prerequisites-2">Prerequisites</a></h2>
<ul>
<li>Rust toolchain (stable): <a href="https://rustup.rs/">rustup.rs</a></li>
<li>Bun (for UI development): <a href="https://bun.sh/">bun.sh</a></li>
<li>Git</li>
</ul>
<h2 id="cloning-the-repository"><a class="header" href="#cloning-the-repository">Cloning the Repository</a></h2>
<pre><code class="language-bash">git clone https://github.com/silvabyte/codeloops
cd codeloops
</code></pre>
<h2 id="building"><a class="header" href="#building">Building</a></h2>
<h3 id="debug-build"><a class="header" href="#debug-build">Debug Build</a></h3>
<pre><code class="language-bash">cargo build
</code></pre>
<p>Binary location: <code>./target/debug/codeloops</code></p>
<h3 id="release-build"><a class="header" href="#release-build">Release Build</a></h3>
<pre><code class="language-bash">cargo build --release
</code></pre>
<p>Binary location: <code>./target/release/codeloops</code></p>
<h2 id="running-tests"><a class="header" href="#running-tests">Running Tests</a></h2>
<h3 id="all-tests"><a class="header" href="#all-tests">All Tests</a></h3>
<pre><code class="language-bash">cargo test --workspace
</code></pre>
<h3 id="specific-crate"><a class="header" href="#specific-crate">Specific Crate</a></h3>
<pre><code class="language-bash">cargo test -p codeloops-core
cargo test -p codeloops-agent
cargo test -p codeloops-sessions
</code></pre>
<h3 id="with-output"><a class="header" href="#with-output">With Output</a></h3>
<pre><code class="language-bash">cargo test --workspace -- --nocapture
</code></pre>
<h2 id="running-the-cli-locally"><a class="header" href="#running-the-cli-locally">Running the CLI Locally</a></h2>
<pre><code class="language-bash"># Show help
cargo run -- --help

# Run with a prompt
cargo run -- --prompt "Fix the typo"

# List sessions
cargo run -- sessions list

# Start the UI
cargo run -- ui --dev
</code></pre>
<h2 id="frontend-development"><a class="header" href="#frontend-development">Frontend Development</a></h2>
<h3 id="install-dependencies"><a class="header" href="#install-dependencies">Install Dependencies</a></h3>
<pre><code class="language-bash">cd ui
bun install
</code></pre>
<h3 id="development-server"><a class="header" href="#development-server">Development Server</a></h3>
<pre><code class="language-bash"># From project root
cargo run -- ui --dev

# Or from ui directory
cd ui &amp;&amp; bun dev
</code></pre>
<h3 id="build"><a class="header" href="#build">Build</a></h3>
<pre><code class="language-bash">cd ui
bun run build
</code></pre>
<h3 id="type-checking-1"><a class="header" href="#type-checking-1">Type Checking</a></h3>
<pre><code class="language-bash">cd ui
bun run typecheck
</code></pre>
<h2 id="code-style"><a class="header" href="#code-style">Code Style</a></h2>
<h3 id="rust"><a class="header" href="#rust">Rust</a></h3>
<p>The project uses standard Rust formatting:</p>
<pre><code class="language-bash"># Format code
cargo fmt

# Check formatting
cargo fmt --check

# Run clippy
cargo clippy --workspace
</code></pre>
<h3 id="typescript"><a class="header" href="#typescript">TypeScript</a></h3>
<pre><code class="language-bash">cd ui
bun run lint
bun run format
</code></pre>
<h2 id="project-structure-1"><a class="header" href="#project-structure-1">Project Structure</a></h2>
<pre><code>codeloops/
├── crates/
│   ├── codeloops/          # CLI binary
│   ├── codeloops-core/     # Loop orchestration
│   ├── codeloops-agent/    # Agent abstraction
│   ├── codeloops-critic/   # Critic evaluation
│   ├── codeloops-git/      # Git operations
│   ├── codeloops-logging/  # Logging and session writing
│   └── codeloops-sessions/ # Session reading
├── ui/                     # Web UI (React)
├── docs/                   # Documentation (mdbook)
├── Cargo.toml              # Workspace manifest
└── README.md
</code></pre>
<h2 id="issue-tracking"><a class="header" href="#issue-tracking">Issue Tracking</a></h2>
<p>This project uses <a href="https://github.com/matsilva/beads">beads</a> for issue tracking. Issues are stored in <code>.beads/</code> directory.</p>
<h3 id="common-commands"><a class="header" href="#common-commands">Common Commands</a></h3>
<pre><code class="language-bash"># List ready issues (no blockers)
bd ready

# Show all open issues
bd list --status=open

# Create a new issue
bd create --title="Description" --type=task

# Start working on an issue
bd update &lt;id&gt; --status=in_progress

# Close an issue
bd close &lt;id&gt;

# Sync with remote
bd sync
</code></pre>
<p>See <code>AGENTS.md</code> for detailed workflow.</p>
<h2 id="making-changes"><a class="header" href="#making-changes">Making Changes</a></h2>
<h3 id="1-find-or-create-an-issue"><a class="header" href="#1-find-or-create-an-issue">1. Find or Create an Issue</a></h3>
<pre><code class="language-bash">bd ready              # See available work
bd show &lt;id&gt;          # Review details
</code></pre>
<p>Or create a new issue:</p>
<pre><code class="language-bash">bd create --title="Add feature X" --type=feature
</code></pre>
<h3 id="2-create-a-branch"><a class="header" href="#2-create-a-branch">2. Create a Branch</a></h3>
<pre><code class="language-bash">git checkout -b feature/my-feature
</code></pre>
<h3 id="3-make-changes"><a class="header" href="#3-make-changes">3. Make Changes</a></h3>
<p>Edit files, add tests, update documentation.</p>
<h3 id="4-test"><a class="header" href="#4-test">4. Test</a></h3>
<pre><code class="language-bash">cargo test --workspace
cargo fmt --check
cargo clippy --workspace
</code></pre>
<h3 id="5-commit"><a class="header" href="#5-commit">5. Commit</a></h3>
<pre><code class="language-bash">git add &lt;files&gt;
git commit -m "feat: add feature X"
</code></pre>
<p>Follow <a href="https://www.conventionalcommits.org/">Conventional Commits</a>:</p>
<ul>
<li><code>feat:</code> - New feature</li>
<li><code>fix:</code> - Bug fix</li>
<li><code>docs:</code> - Documentation</li>
<li><code>refactor:</code> - Code refactoring</li>
<li><code>test:</code> - Tests</li>
<li><code>chore:</code> - Maintenance</li>
</ul>
<h3 id="6-push-and-create-pr"><a class="header" href="#6-push-and-create-pr">6. Push and Create PR</a></h3>
<pre><code class="language-bash">git push -u origin feature/my-feature
gh pr create
</code></pre>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<h3 id="building-docs"><a class="header" href="#building-docs">Building Docs</a></h3>
<pre><code class="language-bash"># Install mdbook
cargo install mdbook

# Build
mdbook build docs

# Serve locally
mdbook serve docs --open
</code></pre>
<h3 id="rustdoc"><a class="header" href="#rustdoc">Rustdoc</a></h3>
<pre><code class="language-bash"># Build API documentation
cargo doc --no-deps --open
</code></pre>
<h2 id="debugging-1"><a class="header" href="#debugging-1">Debugging</a></h2>
<h3 id="verbose-logging"><a class="header" href="#verbose-logging">Verbose Logging</a></h3>
<pre><code class="language-bash">RUST_LOG=debug cargo run -- --prompt "test"
</code></pre>
<h3 id="session-files"><a class="header" href="#session-files">Session Files</a></h3>
<p>Sessions are stored in <code>~/.local/share/codeloops/sessions/</code>. Inspect them with:</p>
<pre><code class="language-bash">cat ~/.local/share/codeloops/sessions/*.jsonl | jq
</code></pre>
<h3 id="testing-without-agents"><a class="header" href="#testing-without-agents">Testing Without Agents</a></h3>
<p>For testing changes that don’t require actual agent execution, you can mock the agent:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(test)]
mod tests {
    use crate::Agent;

    struct MockAgent;

    impl Agent for MockAgent {
        // ... implement with test data
    }
}
<span class="boring">}</span></code></pre>
<h2 id="common-development-tasks"><a class="header" href="#common-development-tasks">Common Development Tasks</a></h2>
<h3 id="adding-a-new-cli-option"><a class="header" href="#adding-a-new-cli-option">Adding a New CLI Option</a></h3>
<ol>
<li>Edit <code>crates/codeloops/src/main.rs</code></li>
<li>Add the option to the <code>Cli</code> struct with clap attributes</li>
<li>Handle the option in the command logic</li>
<li>Update CLI reference documentation</li>
</ol>
<h3 id="adding-a-configuration-option"><a class="header" href="#adding-a-configuration-option">Adding a Configuration Option</a></h3>
<ol>
<li>Edit <code>crates/codeloops/src/config.rs</code></li>
<li>Add field to appropriate struct (GlobalConfig or ProjectConfig)</li>
<li>Update resolution logic</li>
<li>Update configuration documentation</li>
</ol>
<h3 id="adding-a-session-field"><a class="header" href="#adding-a-session-field">Adding a Session Field</a></h3>
<ol>
<li>Edit <code>crates/codeloops-logging/src/session.rs</code> (SessionLine enum)</li>
<li>Edit <code>crates/codeloops-sessions/src/types.rs</code> (Session structs)</li>
<li>Update parser in <code>crates/codeloops-sessions/src/parser.rs</code></li>
<li>Update session format documentation</li>
</ol>
<h3 id="adding-an-api-endpoint"><a class="header" href="#adding-an-api-endpoint">Adding an API Endpoint</a></h3>
<ol>
<li>Create handler in <code>crates/codeloops/src/api/</code></li>
<li>Add route in <code>crates/codeloops/src/api/mod.rs</code></li>
<li>Add TypeScript types in <code>ui/src/api/types.ts</code></li>
<li>Add client function in <code>ui/src/api/client.ts</code></li>
<li>Update API documentation</li>
</ol>
<h2 id="getting-help"><a class="header" href="#getting-help">Getting Help</a></h2>
<ul>
<li>Open an issue on GitHub</li>
<li>Check existing issues for similar problems</li>
<li>Review the documentation</li>
</ul>
<h2 id="contributor-license"><a class="header" href="#contributor-license">Contributor License</a></h2>
<p>By contributing, you agree that your contributions will be licensed under the same license as the project.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="adding-new-agents"><a class="header" href="#adding-new-agents">Adding New Agents</a></h1>
<p>This guide walks through adding support for a new coding agent to codeloops.</p>
<h2 id="overview-4"><a class="header" href="#overview-4">Overview</a></h2>
<p>To add a new agent, you need to:</p>
<ol>
<li>Implement the <code>Agent</code> trait</li>
<li>Add the agent type to the <code>AgentType</code> enum</li>
<li>Update the agent factory function</li>
<li>Add CLI support</li>
<li>Update documentation and tests</li>
</ol>
<h2 id="step-1-implement-the-agent-trait"><a class="header" href="#step-1-implement-the-agent-trait">Step 1: Implement the Agent Trait</a></h2>
<p>Create a new file in <code>crates/codeloops-agent/src/agents/</code>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/codeloops-agent/src/agents/aider.rs

use crate::{Agent, AgentConfig, AgentError, AgentOutput, AgentType, OutputCallback};
use async_trait::async_trait;
use std::path::{Path, PathBuf};
use std::process::Stdio;
use tokio::process::Command;
use tokio::io::{AsyncBufReadExt, BufReader};

/// Aider coding agent implementation.
pub struct AiderAgent {
    binary_path: PathBuf,
}

impl AiderAgent {
    pub fn new() -&gt; Self {
        Self {
            binary_path: PathBuf::from("aider"),
        }
    }
}

#[async_trait]
impl Agent for AiderAgent {
    fn name(&amp;self) -&gt; &amp;str {
        "Aider"
    }

    fn agent_type(&amp;self) -&gt; AgentType {
        AgentType::Aider
    }

    // Note: execute() has a default implementation that calls execute_with_callback(),
    // so you only need to implement execute_with_callback().

    async fn execute_with_callback(
        &amp;self,
        prompt: &amp;str,
        config: &amp;AgentConfig,
        on_output: Option&lt;OutputCallback&gt;,
    ) -&gt; Result&lt;AgentOutput, AgentError&gt; {
        let start = std::time::Instant::now();

        // Build command
        let mut cmd = Command::new(&amp;self.binary_path);
        cmd.current_dir(&amp;config.working_dir);

        // Add agent-specific arguments
        cmd.arg("--message").arg(prompt);
        cmd.arg("--yes");  // Auto-confirm changes
        cmd.arg("--no-git");  // Let codeloops handle git

        // Add model if specified
        if let Some(model) = &amp;config.model {
            cmd.arg("--model").arg(model);
        }

        // Set up I/O
        cmd.stdin(Stdio::null());
        cmd.stdout(Stdio::piped());
        cmd.stderr(Stdio::piped());

        // Spawn process
        let mut child = cmd.spawn().map_err(|e| {
            AgentError::SpawnError(format!("Failed to spawn aider: {}", e))
        })?;

        // Capture output
        let stdout = child.stdout.take().unwrap();
        let stderr = child.stderr.take().unwrap();

        let mut stdout_reader = BufReader::new(stdout).lines();
        let mut stderr_reader = BufReader::new(stderr).lines();

        let mut stdout_output = String::new();
        let mut stderr_output = String::new();

        // Read output streams
        loop {
            tokio::select! {
                line = stdout_reader.next_line() =&gt; {
                    match line {
                        Ok(Some(line)) =&gt; {
                            if let Some(ref callback) = on_output {
                                callback(&amp;line);
                            }
                            stdout_output.push_str(&amp;line);
                            stdout_output.push('\n');
                        }
                        Ok(None) =&gt; break,
                        Err(e) =&gt; {
                            stderr_output.push_str(&amp;format!("Read error: {}\n", e));
                            break;
                        }
                    }
                }
                line = stderr_reader.next_line() =&gt; {
                    if let Ok(Some(line)) = line {
                        stderr_output.push_str(&amp;line);
                        stderr_output.push('\n');
                    }
                }
            }
        }

        // Wait for process
        let status = child.wait().await.map_err(|e| {
            AgentError::ExecutionError(format!("Failed to wait for aider: {}", e))
        })?;

        let duration = start.elapsed();

        Ok(AgentOutput {
            stdout: stdout_output,
            stderr: stderr_output,
            exit_code: status.code().unwrap_or(-1),
            duration,
        })
    }

    async fn is_available(&amp;self) -&gt; bool {
        Command::new(&amp;self.binary_path)
            .arg("--version")
            .stdout(Stdio::null())
            .stderr(Stdio::null())
            .status()
            .await
            .map(|s| s.success())
            .unwrap_or(false)
    }

    fn binary_path(&amp;self) -&gt; &amp;Path {
        &amp;self.binary_path
    }
}

impl Default for AiderAgent {
    fn default() -&gt; Self {
        Self::new()
    }
}
<span class="boring">}</span></code></pre>
<h2 id="step-2-add-the-agent-type"><a class="header" href="#step-2-add-the-agent-type">Step 2: Add the Agent Type</a></h2>
<p>Edit <code>crates/codeloops-agent/src/lib.rs</code>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Supported agent types.
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum AgentType {
    ClaudeCode,
    OpenCode,
    Cursor,
    Aider,  // Add new variant
}

impl AgentType {
    pub fn display_name(&amp;self) -&gt; &amp;'static str {
        match self {
            AgentType::ClaudeCode =&gt; "Claude Code",
            AgentType::OpenCode =&gt; "OpenCode",
            AgentType::Cursor =&gt; "Cursor",
            AgentType::Aider =&gt; "Aider",  // Add display name
        }
    }
}
<span class="boring">}</span></code></pre>
<h2 id="step-3-update-the-factory-function"><a class="header" href="#step-3-update-the-factory-function">Step 3: Update the Factory Function</a></h2>
<p>Edit <code>crates/codeloops-agent/src/lib.rs</code>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>mod agents;

pub use agents::aider::AiderAgent;  // Export new agent
pub use agents::claude::ClaudeCodeAgent;
pub use agents::cursor::CursorAgent;
pub use agents::opencode::OpenCodeAgent;

/// Create an agent instance from the agent type.
pub fn create_agent(agent_type: AgentType) -&gt; Box&lt;dyn Agent&gt; {
    match agent_type {
        AgentType::ClaudeCode =&gt; Box::new(ClaudeCodeAgent::new()),
        AgentType::OpenCode =&gt; Box::new(OpenCodeAgent::new()),
        AgentType::Cursor =&gt; Box::new(CursorAgent::new()),
        AgentType::Aider =&gt; Box::new(AiderAgent::new()),  // Add factory case
    }
}
<span class="boring">}</span></code></pre>
<p>Don’t forget to add the module declaration:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// crates/codeloops-agent/src/agents/mod.rs
pub mod aider;
pub mod claude;
pub mod cursor;
pub mod opencode;
<span class="boring">}</span></code></pre>
<h2 id="step-4-add-cli-support"><a class="header" href="#step-4-add-cli-support">Step 4: Add CLI Support</a></h2>
<p>Edit <code>crates/codeloops/src/main.rs</code>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Agent choice for CLI arguments.
#[derive(Debug, Clone, Copy, ValueEnum)]
pub enum AgentChoice {
    Claude,
    Opencode,
    Cursor,
    Aider,  // Add new variant
}

impl From&lt;AgentChoice&gt; for AgentType {
    fn from(choice: AgentChoice) -&gt; Self {
        match choice {
            AgentChoice::Claude =&gt; AgentType::ClaudeCode,
            AgentChoice::Opencode =&gt; AgentType::OpenCode,
            AgentChoice::Cursor =&gt; AgentType::Cursor,
            AgentChoice::Aider =&gt; AgentType::Aider,  // Add mapping
        }
    }
}
<span class="boring">}</span></code></pre>
<h2 id="step-5-update-configuration"><a class="header" href="#step-5-update-configuration">Step 5: Update Configuration</a></h2>
<p>Edit <code>crates/codeloops/src/config.rs</code> to recognize the new agent string:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn parse_agent(s: &amp;str) -&gt; Option&lt;AgentType&gt; {
    match s.to_lowercase().as_str() {
        "claude" =&gt; Some(AgentType::ClaudeCode),
        "opencode" =&gt; Some(AgentType::OpenCode),
        "cursor" =&gt; Some(AgentType::Cursor),
        "aider" =&gt; Some(AgentType::Aider),  // Add parsing
        _ =&gt; None,
    }
}
<span class="boring">}</span></code></pre>
<h2 id="step-6-write-tests"><a class="header" href="#step-6-write-tests">Step 6: Write Tests</a></h2>
<p>Create test file <code>crates/codeloops-agent/src/agents/aider_test.rs</code>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(test)]
mod tests {
    use super::*;
    use std::path::PathBuf;

    #[test]
    fn test_agent_name() {
        let agent = AiderAgent::new();
        assert_eq!(agent.name(), "Aider");
    }

    #[test]
    fn test_agent_type() {
        let agent = AiderAgent::new();
        assert_eq!(agent.agent_type(), AgentType::Aider);
    }

    #[test]
    fn test_binary_path() {
        let agent = AiderAgent::new();
        assert_eq!(agent.binary_path(), Path::new("aider"));
    }

    #[tokio::test]
    async fn test_execute_not_available() {
        // Test behavior when agent is not installed
        let agent = AiderAgent {
            binary_path: PathBuf::from("/nonexistent/aider"),
        };
        assert!(!agent.is_available().await);
    }
}
<span class="boring">}</span></code></pre>
<h2 id="step-7-update-documentation"><a class="header" href="#step-7-update-documentation">Step 7: Update Documentation</a></h2>
<h3 id="cli-reference-1"><a class="header" href="#cli-reference-1">CLI Reference</a></h3>
<p>Update <code>docs/src/user-guide/cli-reference.md</code>:</p>
<pre><code class="language-markdown">Agent values: `claude`, `opencode`, `cursor`, `aider`
</code></pre>
<h3 id="agents-guide"><a class="header" href="#agents-guide">Agents Guide</a></h3>
<p>Update <code>docs/src/user-guide/agents.md</code>:</p>
<pre><code class="language-markdown">## Supported Agents

| Agent | CLI Value | Binary | Description |
|-------|-----------|--------|-------------|
| Claude Code | `claude` | `claude` | Anthropic's Claude-powered coding agent |
| OpenCode | `opencode` | `opencode` | Multi-model coding agent |
| Cursor | `cursor` | `cursor` | Cursor IDE's agent CLI |
| Aider | `aider` | `aider` | AI pair programming in your terminal |

### Aider

Aider is an AI pair programming tool that works in your terminal.

**Binary**: `aider`

**Strengths**:
- Works with many LLM providers
- Good for iterative editing
- Supports multiple files

**Installation**: Visit [aider.chat](https://aider.chat/)
</code></pre>
<h3 id="configuration-schema-1"><a class="header" href="#configuration-schema-1">Configuration Schema</a></h3>
<p>Update <code>docs/src/reference/config-schema.md</code>:</p>
<pre><code class="language-markdown">### Agent Values

| Value | Agent |
|-------|-------|
| `"claude"` | Claude Code |
| `"opencode"` | OpenCode |
| `"cursor"` | Cursor |
| `"aider"` | Aider |
</code></pre>
<h2 id="step-8-test-the-integration"><a class="header" href="#step-8-test-the-integration">Step 8: Test the Integration</a></h2>
<pre><code class="language-bash"># Build
cargo build

# Run tests
cargo test -p codeloops-agent

# Test CLI
./target/debug/codeloops --agent aider --dry-run

# Test actual execution (requires aider installed)
./target/debug/codeloops --agent aider --prompt "Fix typo"
</code></pre>
<h2 id="agent-implementation-tips"><a class="header" href="#agent-implementation-tips">Agent Implementation Tips</a></h2>
<h3 id="handle-different-output-formats"><a class="header" href="#handle-different-output-formats">Handle Different Output Formats</a></h3>
<p>Agents may produce output in different formats. Normalize output for the critic:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn normalize_output(&amp;self, raw_output: &amp;str) -&gt; String {
    // Remove agent-specific noise
    // Standardize formatting
    raw_output.to_string()
}
<span class="boring">}</span></code></pre>
<h3 id="handle-model-selection"><a class="header" href="#handle-model-selection">Handle Model Selection</a></h3>
<p>Different agents support models differently:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Some agents use --model
cmd.arg("--model").arg(model);

// Some use environment variables
cmd.env("MODEL_NAME", model);

// Some use different flag names
cmd.arg("-m").arg(model);
<span class="boring">}</span></code></pre>
<h3 id="handle-working-directory"><a class="header" href="#handle-working-directory">Handle Working Directory</a></h3>
<p>Agents should run in the specified working directory:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>cmd.current_dir(&amp;config.working_dir);
<span class="boring">}</span></code></pre>
<h3 id="handle-prompts"><a class="header" href="#handle-prompts">Handle Prompts</a></h3>
<p>Different agents accept prompts differently:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Via argument
cmd.arg("--message").arg(prompt);

// Via stdin
cmd.stdin(Stdio::piped());
// Then write prompt to stdin after spawn

// Via file
let prompt_file = config.working_dir.join(".prompt");
std::fs::write(&amp;prompt_file, prompt)?;
cmd.arg("--prompt-file").arg(&amp;prompt_file);
<span class="boring">}</span></code></pre>
<h3 id="handle-errors-gracefully"><a class="header" href="#handle-errors-gracefully">Handle Errors Gracefully</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>if !status.success() {
    // Don't fail immediately - let the critic handle it
    // The critic can provide recovery suggestions
}
<span class="boring">}</span></code></pre>
<h2 id="checklist"><a class="header" href="#checklist">Checklist</a></h2>
<p>Before submitting your PR:</p>
<ul>
<li><input disabled="" type="checkbox"> Agent trait implemented</li>
<li><input disabled="" type="checkbox"> AgentType enum updated</li>
<li><input disabled="" type="checkbox"> Factory function updated</li>
<li><input disabled="" type="checkbox"> CLI AgentChoice added</li>
<li><input disabled="" type="checkbox"> Configuration parsing updated</li>
<li><input disabled="" type="checkbox"> Tests written</li>
<li><input disabled="" type="checkbox"> Documentation updated (agents guide, CLI reference, config schema)</li>
<li><input disabled="" type="checkbox"> All tests pass (<code>cargo test --workspace</code>)</li>
<li><input disabled="" type="checkbox"> Code formatted (<code>cargo fmt</code>)</li>
<li><input disabled="" type="checkbox"> No clippy warnings (<code>cargo clippy --workspace</code>)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="best-practices-1"><a class="header" href="#best-practices-1">Best Practices</a></h1>
<p>This guide covers best practices for getting the most out of codeloops, based on patterns observed across real sessions.</p>
<h2 id="the-planning-workflow"><a class="header" href="#the-planning-workflow">The Planning Workflow</a></h2>
<p>The most successful codeloops sessions follow a two-phase workflow:</p>
<h3 id="phase-1-interactive-exploration"><a class="header" href="#phase-1-interactive-exploration">Phase 1: Interactive Exploration</a></h3>
<p>Use your coding agent interactively to explore and plan:</p>
<pre><code class="language-bash"># Start your agent
opencode  # or claude

# Explore the problem
&gt; Analyze the authentication flow and identify where rate limiting should be added

# Generate a detailed prompt
&gt; /promptmd
</code></pre>
<h3 id="phase-2-disciplined-execution"><a class="header" href="#phase-2-disciplined-execution">Phase 2: Disciplined Execution</a></h3>
<p>Run codeloops with the generated prompt:</p>
<pre><code class="language-bash">codeloops
</code></pre>
<p>This workflow leverages your agent’s interactive capabilities for exploration, then uses codeloops’ actor-critic loop for structured, self-correcting execution.</p>
<h2 id="what-makes-prompts-succeed-in-one-iteration"><a class="header" href="#what-makes-prompts-succeed-in-one-iteration">What Makes Prompts Succeed in One Iteration</a></h2>
<p>Analysis of successful single-iteration sessions reveals these patterns:</p>
<h3 id="include-root-cause-analysis-for-bugs"><a class="header" href="#include-root-cause-analysis-for-bugs">Include Root Cause Analysis (for bugs)</a></h3>
<p>Don’t just describe symptoms—explain why it’s happening:</p>
<p><strong>Good:</strong></p>
<pre><code class="language-markdown">## Problem
The daemon logs spam this error every ~6 seconds:
`Telegram poll error: Ctrl-C signal handler already registered`

## Root Cause
The daemon registers a `ctrlc::set_handler` at `crates/butler/src/commands/daemon.rs:79`.
Then it calls `telegram::poll()` which also calls `ctrlc::set_handler()` at line 40.
The `ctrlc` crate only allows one global handler—the second registration fails.

## Fix
Skip the ctrlc registration in `poll()` when called with `once: true`.

## Files
- `crates/butler/src/commands/telegram.rs` — lines 38-42
- `crates/butler/src/commands/daemon.rs` — lines 79-81, 91
</code></pre>
<h3 id="provide-exact-file-paths-and-line-numbers"><a class="header" href="#provide-exact-file-paths-and-line-numbers">Provide Exact File Paths and Line Numbers</a></h3>
<p>Specificity eliminates guesswork:</p>
<p><strong>Good:</strong></p>
<pre><code class="language-markdown">In `run.rs`, guard against empty output before sending to Telegram:

File: `crates/butler/src/commands/run.rs` — lines 100-103

Change:
```rust
OutputTarget::Telegram =&gt; {
    let msg = output_result.stdout.trim();
    if msg.is_empty() {
        eprintln!("Warning: playbook produced no output");
    } else {
        tg.send_message(msg).await?;
    }
}
</code></pre>
<pre><code>
### Include Schema Definitions for Data Changes

When adding database tables or data structures, include the full schema:

**Good:**
```markdown
## Database Schema

```sql
CREATE TABLE tasks (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending',
    trigger_at TEXT,
    created_at TEXT NOT NULL
);
CREATE INDEX idx_tasks_status_trigger ON tasks(status, trigger_at);
</code></pre>
<pre><code>
### Structure Complex Tasks in Phases

Break large features into numbered, dependent tasks:

**Good:**
```markdown
## Phase 1: Foundation Setup

### Task 1.1: Create the database module
Location: `crates/butler-db/`
- Implement `open_db()` with WAL mode
- Add migration helpers

### Task 1.2: Add state helpers
- Implement `get_state(conn, table, key)`
- Implement `set_state(conn, table, key, value)`

## Phase 2: Migration

### Task 2.1: Migrate telegram state
- Replace JSON file reads with database queries
- Update `crates/butler/src/commands/telegram.rs`
</code></pre>
<h2 id="what-causes-multiple-iterations"><a class="header" href="#what-causes-multiple-iterations">What Causes Multiple Iterations</a></h2>
<p>Sessions that require 2-3 iterations typically have these gaps:</p>
<h3 id="missing-edge-cases"><a class="header" href="#missing-edge-cases">Missing Edge Cases</a></h3>
<p>The critic catches issues the prompt didn’t mention:</p>
<ul>
<li>Double initialization of global state</li>
<li>Empty output handling</li>
<li>Error propagation paths</li>
<li>Clippy warnings in new code</li>
</ul>
<p><strong>Prevention:</strong> Include a “Validation Checklist” in your prompt:</p>
<pre><code class="language-markdown">## Validation Checklist
- [ ] No clippy warnings in modified files
- [ ] Error cases return appropriate error types
- [ ] Empty/null inputs are handled
- [ ] New code has test coverage
</code></pre>
<h3 id="ambiguous-done-criteria-1"><a class="header" href="#ambiguous-done-criteria-1">Ambiguous “Done” Criteria</a></h3>
<p>When the critic can’t determine if requirements are met, it requests more changes.</p>
<p><strong>Prevention:</strong> Use explicit acceptance criteria with checkboxes:</p>
<pre><code class="language-markdown">## Acceptance Criteria
- [ ] `bun scripts/generate-route-config.ts --check` returns exit code 0 when in sync
- [ ] `bun scripts/generate-route-config.ts --check` returns exit code 1 when out of sync
- [ ] Pre-commit hook fails with clear error message when route config is stale
- [ ] All existing tests pass
</code></pre>
<h2 id="writing-effective-prompts"><a class="header" href="#writing-effective-prompts">Writing Effective Prompts</a></h2>
<h3 id="be-specific"><a class="header" href="#be-specific">Be Specific</a></h3>
<p>Vague prompts lead to vague results:</p>
<p><strong>Bad:</strong></p>
<pre><code class="language-markdown">Improve the code.
</code></pre>
<p><strong>Good:</strong></p>
<pre><code class="language-markdown">Refactor the `calculate_total` function in src/cart.rs to:
1. Use iterators instead of manual loops
2. Handle the case where the cart is empty
3. Add documentation comments
</code></pre>
<h3 id="include-acceptance-criteria"><a class="header" href="#include-acceptance-criteria">Include Acceptance Criteria</a></h3>
<p>Tell the critic what “done” looks like:</p>
<pre><code class="language-markdown">## Task
Add rate limiting to the API endpoint.

## Acceptance Criteria
- [ ] Limit to 100 requests per minute per IP
- [ ] Return 429 status code when limit exceeded
- [ ] Include Retry-After header in 429 responses
- [ ] Log rate limit violations
</code></pre>
<h3 id="provide-context"><a class="header" href="#provide-context">Provide Context</a></h3>
<p>Reference specific files and functions:</p>
<pre><code class="language-markdown">Add pagination to the `list_users` function in src/api/users.rs.

The function currently returns all users. Change it to:
- Accept `page` and `per_page` query parameters
- Default to page 1 with 20 items per page
- Return total count in the response

Related types are in src/models/user.rs and src/api/types.rs.
</code></pre>
<h3 id="one-task-per-prompt"><a class="header" href="#one-task-per-prompt">One Task Per Prompt</a></h3>
<p>Don’t combine unrelated tasks:</p>
<p><strong>Bad:</strong></p>
<pre><code class="language-markdown">Fix the login bug and add a new dashboard page and update the README.
</code></pre>
<p><strong>Good:</strong>
Create separate prompts for each:</p>
<ol>
<li><code>prompt-login.md</code>: Fix the login bug</li>
<li><code>prompt-dashboard.md</code>: Add dashboard page</li>
<li><code>prompt-readme.md</code>: Update README</li>
</ol>
<h2 id="structuring-complex-tasks"><a class="header" href="#structuring-complex-tasks">Structuring Complex Tasks</a></h2>
<h3 id="break-down-large-features"><a class="header" href="#break-down-large-features">Break Down Large Features</a></h3>
<p>Instead of one large prompt:</p>
<pre><code class="language-markdown">Implement complete user authentication with registration, login,
logout, password reset, and email verification.
</code></pre>
<p>Create a series of prompts:</p>
<ol>
<li>User registration</li>
<li>User login</li>
<li>Logout</li>
<li>Password reset (request)</li>
<li>Password reset (confirm)</li>
<li>Email verification</li>
</ol>
<p>Run them sequentially, each building on the previous.</p>
<h3 id="use-iteration-limits-wisely"><a class="header" href="#use-iteration-limits-wisely">Use Iteration Limits Wisely</a></h3>
<p>Set limits based on task complexity:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Task Type</th><th>Suggested Limit</th></tr>
</thead>
<tbody>
<tr><td>Simple fix</td><td>2-3</td></tr>
<tr><td>Small feature</td><td>5</td></tr>
<tr><td>Medium feature</td><td>10</td></tr>
<tr><td>Complex task</td><td>Consider breaking down</td></tr>
</tbody>
</table>
</div>
<pre><code class="language-bash">codeloops --max-iterations 5
</code></pre>
<h2 id="agent-selection"><a class="header" href="#agent-selection">Agent Selection</a></h2>
<h3 id="same-agent-for-both-roles-1"><a class="header" href="#same-agent-for-both-roles-1">Same Agent for Both Roles</a></h3>
<p>Use the same agent when:</p>
<ul>
<li>Starting out (simpler configuration)</li>
<li>The agent performs well for your use case</li>
<li>You want predictable behavior</li>
</ul>
<pre><code class="language-bash">codeloops --agent claude
</code></pre>
<h3 id="different-agents-per-role"><a class="header" href="#different-agents-per-role">Different Agents per Role</a></h3>
<p>Mix agents when:</p>
<ul>
<li>You want fast iteration with thorough review</li>
<li>Different agents excel at different aspects</li>
</ul>
<pre><code class="language-bash"># Fast actor, thorough critic
codeloops --actor-agent opencode --critic-agent claude
</code></pre>
<h3 id="agent-task-matching"><a class="header" href="#agent-task-matching">Agent-Task Matching</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Task Type</th><th>Recommended</th></tr>
</thead>
<tbody>
<tr><td>Complex refactoring</td><td>Claude (strong reasoning)</td></tr>
<tr><td>Simple fixes</td><td>OpenCode (fast)</td></tr>
<tr><td>Cursor-centric workflow</td><td>Cursor</td></tr>
</tbody>
</table>
</div>
<h2 id="working-with-the-feedback-loop"><a class="header" href="#working-with-the-feedback-loop">Working with the Feedback Loop</a></h2>
<h3 id="trust-the-critic"><a class="header" href="#trust-the-critic">Trust the Critic</a></h3>
<p>The critic provides valuable feedback. If the loop continues, review the feedback to understand what’s missing.</p>
<h3 id="know-when-to-cancel"><a class="header" href="#know-when-to-cancel">Know When to Cancel</a></h3>
<p>Cancel and reformulate if:</p>
<ul>
<li>Multiple iterations produce similar results</li>
<li>The critic’s feedback seems stuck</li>
<li>The task scope may be wrong</li>
</ul>
<p>Press <code>Ctrl+C</code> to cancel, then revise your prompt.</p>
<h3 id="learn-from-sessions"><a class="header" href="#learn-from-sessions">Learn from Sessions</a></h3>
<p>Review completed sessions to improve future prompts:</p>
<pre><code class="language-bash">codeloops sessions show
</code></pre>
<p>Look for patterns:</p>
<ul>
<li>What feedback was given?</li>
<li>How many iterations did similar tasks take?</li>
<li>What made some tasks succeed faster?</li>
</ul>
<h2 id="cicd-integration"><a class="header" href="#cicd-integration">CI/CD Integration</a></h2>
<h3 id="json-output"><a class="header" href="#json-output">JSON Output</a></h3>
<p>Use JSON output for machine parsing:</p>
<pre><code class="language-bash">codeloops --json-output &gt; result.json
</code></pre>
<h3 id="exit-codes-1"><a class="header" href="#exit-codes-1">Exit Codes</a></h3>
<p>Use exit codes in scripts:</p>
<pre><code class="language-bash">codeloops --max-iterations 3 || echo "Task incomplete"
</code></pre>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Code</th><th>Meaning</th></tr>
</thead>
<tbody>
<tr><td>0</td><td>Success</td></tr>
<tr><td>1</td><td>Max iterations reached</td></tr>
<tr><td>2</td><td>Failed</td></tr>
<tr><td>130</td><td>Interrupted</td></tr>
</tbody>
</table>
</div>
<h3 id="configuration-files-1"><a class="header" href="#configuration-files-1">Configuration Files</a></h3>
<p>Use project configuration for CI consistency:</p>
<pre><code class="language-toml"># codeloops.toml
agent = "claude"
max_iterations = 5
log_format = "json"
</code></pre>
<h3 id="pipeline-example"><a class="header" href="#pipeline-example">Pipeline Example</a></h3>
<pre><code class="language-yaml"># .github/workflows/autofix.yml
- name: Run codeloops
  run: |
    codeloops --prompt "${{ github.event.issue.body }}" \
      --max-iterations 3 \
      --json-output &gt; result.json
  continue-on-error: true

- name: Check result
  run: |
    outcome=$(jq -r '.outcome' result.json)
    if [ "$outcome" != "success" ]; then
      echo "Task did not complete successfully"
      exit 1
    fi
</code></pre>
<h2 id="performance-tips"><a class="header" href="#performance-tips">Performance Tips</a></h2>
<h3 id="minimize-iteration-count"><a class="header" href="#minimize-iteration-count">Minimize Iteration Count</a></h3>
<p>Better prompts = fewer iterations = faster completion.</p>
<h3 id="use-appropriate-agents"><a class="header" href="#use-appropriate-agents">Use Appropriate Agents</a></h3>
<p>Faster agents reduce total time when the task is straightforward.</p>
<h3 id="limit-scope"><a class="header" href="#limit-scope">Limit Scope</a></h3>
<p>Smaller, focused tasks complete faster than large ones.</p>
<h2 id="common-pitfalls"><a class="header" href="#common-pitfalls">Common Pitfalls</a></h2>
<h3 id="ambiguous-requirements"><a class="header" href="#ambiguous-requirements">Ambiguous Requirements</a></h3>
<p><strong>Problem:</strong> Critic keeps requesting changes because requirements are unclear.</p>
<p><strong>Solution:</strong> Add explicit acceptance criteria to your prompt. Use checkboxes that the critic can verify.</p>
<h3 id="too-many-unrelated-changes"><a class="header" href="#too-many-unrelated-changes">Too Many Unrelated Changes</a></h3>
<p><strong>Problem:</strong> Actor makes changes beyond what was asked.</p>
<p><strong>Solution:</strong> Be specific about scope in the prompt. Add “Do not modify other files” if needed.</p>
<h3 id="ignoring-feedback"><a class="header" href="#ignoring-feedback">Ignoring Feedback</a></h3>
<p><strong>Problem:</strong> Re-running the same prompt hoping for different results.</p>
<p><strong>Solution:</strong> Read the critic’s feedback and adjust your prompt or approach. The critic often catches legitimate issues like:</p>
<ul>
<li>Double initialization of global state</li>
<li>Missing error handling</li>
<li>Clippy warnings</li>
</ul>
<h3 id="overly-broad-tasks"><a class="header" href="#overly-broad-tasks">Overly Broad Tasks</a></h3>
<p><strong>Problem:</strong> Task never completes because scope is too large.</p>
<p><strong>Solution:</strong> Break into smaller, manageable tasks. Use the <code>/promptmd</code> workflow to plan interactively, then execute each phase with codeloops.</p>
<h3 id="missing-context-1"><a class="header" href="#missing-context-1">Missing Context</a></h3>
<p><strong>Problem:</strong> Actor can’t find the right files or uses wrong patterns.</p>
<p><strong>Solution:</strong> Include file paths and line numbers. Reference existing code patterns by showing examples from the codebase.</p>
<h3 id="describing-symptoms-instead-of-causes"><a class="header" href="#describing-symptoms-instead-of-causes">Describing Symptoms Instead of Causes</a></h3>
<p><strong>Problem:</strong> Bug fix prompts describe what’s wrong but not why.</p>
<p><strong>Solution:</strong> Include root cause analysis. Explain <em>why</em> the bug happens, not just <em>what</em> happens. This dramatically reduces iterations.</p>
<p><strong>Bad:</strong></p>
<pre><code class="language-markdown">The daemon crashes on startup.
</code></pre>
<p><strong>Good:</strong></p>
<pre><code class="language-markdown">The daemon crashes on startup because tracing-subscriber is initialized twice:
1. `main.rs:10` calls `tracing_subscriber::fmt().init()`
2. `daemon.rs:66` calls it again, which panics

Fix: Use `try_init()` instead of `init()` in main.rs.
</code></pre>
<h3 id="not-including-quality-assurance-steps"><a class="header" href="#not-including-quality-assurance-steps">Not Including Quality Assurance Steps</a></h3>
<p><strong>Problem:</strong> Prompt completes but leaves behind clippy warnings, failing tests, or missing documentation.</p>
<p><strong>Solution:</strong> Always include QA requirements in your prompt:</p>
<pre><code class="language-markdown">## Quality Requirements
- Run `cargo clippy` and fix all warnings in modified files
- Ensure all existing tests pass
- Add tests for new functionality
- Update relevant documentation
</code></pre>
<h2 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h2>
<h3 id="review-changes"><a class="header" href="#review-changes">Review Changes</a></h3>
<p>Always review the git diff before committing:</p>
<pre><code class="language-bash">git diff
</code></pre>
<h3 id="sensitive-files"><a class="header" href="#sensitive-files">Sensitive Files</a></h3>
<p>Don’t include sensitive information in prompts. The prompt is logged in the session file.</p>
<h3 id="access-control"><a class="header" href="#access-control">Access Control</a></h3>
<p>Agents have full filesystem access in the working directory. Run codeloops in appropriate environments.</p>
<h2 id="session-management"><a class="header" href="#session-management">Session Management</a></h2>
<h3 id="regular-cleanup"><a class="header" href="#regular-cleanup">Regular Cleanup</a></h3>
<p>Delete old sessions periodically:</p>
<pre><code class="language-bash"># Delete sessions older than 30 days
find ~/.local/share/codeloops/sessions -name "*.jsonl" -mtime +30 -delete
</code></pre>
<h3 id="backup-important-sessions"><a class="header" href="#backup-important-sessions">Backup Important Sessions</a></h3>
<p>Copy sessions you want to preserve:</p>
<pre><code class="language-bash">cp ~/.local/share/codeloops/sessions/important-session.jsonl ~/backups/
</code></pre>
<h3 id="analyze-patterns"><a class="header" href="#analyze-patterns">Analyze Patterns</a></h3>
<p>Use statistics to improve your workflow:</p>
<pre><code class="language-bash">codeloops sessions stats
</code></pre>
<p>Look at success rates by project to identify areas for improvement.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="faq"><a class="header" href="#faq">FAQ</a></h1>
<p>Frequently asked questions about codeloops.</p>
<h2 id="general"><a class="header" href="#general">General</a></h2>
<h3 id="what-is-codeloops"><a class="header" href="#what-is-codeloops">What is codeloops?</a></h3>
<p>Codeloops is a command-line tool that orchestrates an actor-critic feedback loop for AI coding agents. It runs a coding agent to execute tasks, evaluates the results with another agent instance, and loops until the task is complete.</p>
<h3 id="why-use-codeloops-instead-of-running-an-agent-directly"><a class="header" href="#why-use-codeloops-instead-of-running-an-agent-directly">Why use codeloops instead of running an agent directly?</a></h3>
<p>AI coding agents lack built-in self-correction. They may produce incomplete work, miss edge cases, or make mistakes without knowing. Codeloops adds a feedback loop where a critic evaluates the work and provides guidance for improvement, leading to higher quality results.</p>
<h3 id="what-agents-are-supported"><a class="header" href="#what-agents-are-supported">What agents are supported?</a></h3>
<p>Currently supported:</p>
<ul>
<li>Claude Code (<code>claude</code>)</li>
<li>OpenCode (<code>opencode</code>)</li>
<li>Cursor (<code>cursor</code>)</li>
</ul>
<h3 id="can-i-use-my-own-llm-or-a-custom-agent"><a class="header" href="#can-i-use-my-own-llm-or-a-custom-agent">Can I use my own LLM or a custom agent?</a></h3>
<p>Yes, by implementing the <code>Agent</code> trait. See <a href="#adding-new-agents">Adding New Agents</a> for a step-by-step guide.</p>
<h3 id="is-codeloops-free"><a class="header" href="#is-codeloops-free">Is codeloops free?</a></h3>
<p>Codeloops itself is open source and free. However, the agents it uses (Claude, OpenCode, Cursor) may have their own pricing. You’ll need accounts with those services.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<h3 id="why-does-the-loop-keep-running"><a class="header" href="#why-does-the-loop-keep-running">Why does the loop keep running?</a></h3>
<p>The loop continues when the critic returns <code>CONTINUE</code>, meaning the task isn’t complete. Possible reasons:</p>
<ol>
<li><strong>Requirements not fully met</strong>: Check the critic’s feedback to see what’s missing</li>
<li><strong>Vague prompt</strong>: Add explicit acceptance criteria</li>
<li><strong>Error in implementation</strong>: Actor may be making mistakes</li>
</ol>
<p>Review the session to see the feedback:</p>
<pre><code class="language-bash">codeloops sessions show
</code></pre>
<h3 id="how-do-i-stop-a-running-session"><a class="header" href="#how-do-i-stop-a-running-session">How do I stop a running session?</a></h3>
<p>Press <code>Ctrl+C</code>. The session will be recorded with outcome <code>interrupted</code>.</p>
<h3 id="how-do-i-reduce-iterations"><a class="header" href="#how-do-i-reduce-iterations">How do I reduce iterations?</a></h3>
<ol>
<li>Write more specific prompts with clear acceptance criteria</li>
<li>Provide context (file paths, function names)</li>
<li>Break complex tasks into smaller ones</li>
<li>Set a limit: <code>--max-iterations 5</code></li>
</ol>
<h3 id="why-is-the-critic-rejecting-my-changes"><a class="header" href="#why-is-the-critic-rejecting-my-changes">Why is the critic rejecting my changes?</a></h3>
<p>Common reasons:</p>
<ul>
<li>Requirements in the prompt aren’t fully implemented</li>
<li>Edge cases not handled</li>
<li>Tests failing (if mentioned in prompt)</li>
<li>Code quality issues</li>
</ul>
<p>Check the feedback in the session:</p>
<pre><code class="language-bash">codeloops sessions show
</code></pre>
<h3 id="can-i-run-multiple-sessions-simultaneously"><a class="header" href="#can-i-run-multiple-sessions-simultaneously">Can I run multiple sessions simultaneously?</a></h3>
<p>Yes, in different terminals or directories. Each session writes to its own file.</p>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<h3 id="where-is-the-configuration-file"><a class="header" href="#where-is-the-configuration-file">Where is the configuration file?</a></h3>
<ul>
<li>Global: <code>~/.config/codeloops/config.toml</code></li>
<li>Project: <code>./codeloops.toml</code> (in working directory)</li>
</ul>
<h3 id="how-do-i-see-what-configuration-is-being-used"><a class="header" href="#how-do-i-see-what-configuration-is-being-used">How do I see what configuration is being used?</a></h3>
<p>Use dry run:</p>
<pre><code class="language-bash">codeloops --dry-run
</code></pre>
<h3 id="how-do-i-use-different-agents-for-actor-and-critic"><a class="header" href="#how-do-i-use-different-agents-for-actor-and-critic">How do I use different agents for actor and critic?</a></h3>
<pre><code class="language-bash">codeloops --actor-agent opencode --critic-agent claude
</code></pre>
<p>Or in configuration:</p>
<pre><code class="language-toml">[actor]
agent = "opencode"

[critic]
agent = "claude"
</code></pre>
<h2 id="sessions-1"><a class="header" href="#sessions-1">Sessions</a></h2>
<h3 id="where-are-my-sessions-stored"><a class="header" href="#where-are-my-sessions-stored">Where are my sessions stored?</a></h3>
<p><code>~/.local/share/codeloops/sessions/</code></p>
<h3 id="can-i-delete-old-sessions"><a class="header" href="#can-i-delete-old-sessions">Can I delete old sessions?</a></h3>
<p>Yes, they’re just files:</p>
<pre><code class="language-bash">rm ~/.local/share/codeloops/sessions/session-id.jsonl
</code></pre>
<h3 id="how-do-i-export-session-data"><a class="header" href="#how-do-i-export-session-data">How do I export session data?</a></h3>
<p>Sessions are JSONL files. Parse them with jq, Python, or any JSON tool:</p>
<pre><code class="language-bash">cat ~/.local/share/codeloops/sessions/session.jsonl | jq
</code></pre>
<h3 id="why-is-my-session-file-missing-session_end"><a class="header" href="#why-is-my-session-file-missing-session_end">Why is my session file missing session_end?</a></h3>
<p>The session was either:</p>
<ul>
<li>Still in progress when you checked</li>
<li>Interrupted (Ctrl+C, crash)</li>
<li>The process was killed</li>
</ul>
<h2 id="troubleshooting-1"><a class="header" href="#troubleshooting-1">Troubleshooting</a></h2>
<h3 id="agent-not-found-in-path"><a class="header" href="#agent-not-found-in-path">Agent not found in PATH</a></h3>
<pre><code>Error: Agent 'claude' not found in PATH
</code></pre>
<p><strong>Solution</strong>: Install the agent and ensure its binary is in your PATH.</p>
<pre><code class="language-bash"># Check if agent is installed
which claude

# Verify it works
claude --version
</code></pre>
<h3 id="no-prompt-provided-1"><a class="header" href="#no-prompt-provided-1">No prompt provided</a></h3>
<pre><code>Error: No prompt provided
</code></pre>
<p><strong>Solution</strong>: Create a <code>prompt.md</code> file or use <code>--prompt</code>:</p>
<pre><code class="language-bash">echo "Fix the bug" &gt; prompt.md
codeloops
</code></pre>
<p>Or:</p>
<pre><code class="language-bash">codeloops --prompt "Fix the bug"
</code></pre>
<h3 id="not-a-git-repository-1"><a class="header" href="#not-a-git-repository-1">Not a git repository</a></h3>
<pre><code>Error: Not a git repository
</code></pre>
<p><strong>Solution</strong>: Initialize git in your working directory:</p>
<pre><code class="language-bash">git init
</code></pre>
<h3 id="permission-denied"><a class="header" href="#permission-denied">Permission denied</a></h3>
<pre><code>Error: Permission denied
</code></pre>
<p><strong>Solution</strong>: Check file and directory permissions:</p>
<pre><code class="language-bash">ls -la ~/.local/share/codeloops/
</code></pre>
<h3 id="session-directory-doesnt-exist"><a class="header" href="#session-directory-doesnt-exist">Session directory doesn’t exist</a></h3>
<p>The session directory is created automatically. If it fails, create it manually:</p>
<pre><code class="language-bash">mkdir -p ~/.local/share/codeloops/sessions
</code></pre>
<h3 id="ui-wont-start-1"><a class="header" href="#ui-wont-start-1">UI won’t start</a></h3>
<p><strong>Port in use</strong>:</p>
<pre><code class="language-bash">codeloops ui --api-port 4000 --ui-port 4001
</code></pre>
<p><strong>UI directory not found</strong>: Build the UI:</p>
<pre><code class="language-bash">cd ui &amp;&amp; bun install &amp;&amp; bun run build
</code></pre>
<h3 id="slow-performance"><a class="header" href="#slow-performance">Slow performance</a></h3>
<p>Possible causes:</p>
<ul>
<li>Agent response time (depends on the service)</li>
<li>Large diffs (many files changed)</li>
<li>Complex prompts</li>
</ul>
<p>Tips:</p>
<ul>
<li>Use faster agents for simple tasks</li>
<li>Break large tasks into smaller ones</li>
</ul>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<h3 id="how-do-i-contribute"><a class="header" href="#how-do-i-contribute">How do I contribute?</a></h3>
<p>See <a href="#development-setup-1">Development Setup</a> for getting started.</p>
<h3 id="how-do-i-report-bugs"><a class="header" href="#how-do-i-report-bugs">How do I report bugs?</a></h3>
<p>Open an issue on GitHub with:</p>
<ul>
<li>Steps to reproduce</li>
<li>Expected vs actual behavior</li>
<li>Session file (if applicable)</li>
<li>System information</li>
</ul>
<h3 id="how-do-i-request-features"><a class="header" href="#how-do-i-request-features">How do I request features?</a></h3>
<p>Open an issue on GitHub describing:</p>
<ul>
<li>The use case</li>
<li>Proposed solution</li>
<li>Alternatives considered</li>
</ul>
<h2 id="miscellaneous"><a class="header" href="#miscellaneous">Miscellaneous</a></h2>
<h3 id="does-codeloops-modify-my-code"><a class="header" href="#does-codeloops-modify-my-code">Does codeloops modify my code?</a></h3>
<p>No, codeloops doesn’t modify code directly. The agents do. Codeloops orchestrates the loop and captures the results.</p>
<h3 id="does-codeloops-send-my-code-anywhere"><a class="header" href="#does-codeloops-send-my-code-anywhere">Does codeloops send my code anywhere?</a></h3>
<p>Codeloops itself doesn’t send code anywhere. The agents you use may send code to their services (Claude API, OpenAI API, etc.) according to their terms of service.</p>
<h3 id="can-i-use-codeloops-offline"><a class="header" href="#can-i-use-codeloops-offline">Can I use codeloops offline?</a></h3>
<p>Codeloops itself runs locally, but the agents typically require internet access to their respective APIs.</p>
<h3 id="how-is-this-different-from-github-copilot"><a class="header" href="#how-is-this-different-from-github-copilot">How is this different from GitHub Copilot?</a></h3>
<p>Copilot is an inline code completion tool. Codeloops is a task execution framework with feedback loops. They solve different problems and can be used together.</p>
<h3 id="does-codeloops-work-with-any-language"><a class="header" href="#does-codeloops-work-with-any-language">Does codeloops work with any language?</a></h3>
<p>Yes, codeloops is language-agnostic. It works with whatever languages your chosen agent supports.</p>
<h3 id="can-i-use-codeloops-in-cicd"><a class="header" href="#can-i-use-codeloops-in-cicd">Can I use codeloops in CI/CD?</a></h3>
<p>Yes. Use <code>--json-output</code> for machine-readable output and exit codes for status:</p>
<pre><code class="language-bash">codeloops --max-iterations 3 --json-output &gt; result.json
</code></pre>
<h3 id="where-can-i-get-help"><a class="header" href="#where-can-i-get-help">Where can I get help?</a></h3>
<ul>
<li>Documentation: This site</li>
<li>Issues: <a href="https://github.com/silvabyte/codeloops/issues">GitHub Issues</a></li>
<li>Discussions: <a href="https://github.com/silvabyte/codeloops/discussions">GitHub Discussions</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>


        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
